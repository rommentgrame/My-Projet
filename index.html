<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#080b16">
<title>ProjectFlow</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --accent: #7c3aed;
  --accent-rgb: 124, 58, 237;
  --accent2: #4f46e5;
  --bg: #080b16;
  --bg2: #0d1122;
  --bg3: #111828;
  --glass: rgba(255,255,255,0.038);
  --glass2: rgba(255,255,255,0.065);
  --border: rgba(255,255,255,0.075);
  --border2: rgba(255,255,255,0.13);
  --text: #eef1ff;
  --text2: rgba(238,241,255,0.55);
  --text3: rgba(238,241,255,0.28);
  --radius: 16px;
  --radius-sm: 10px;
  --radius-xs: 7px;
  --shadow: 0 24px 60px rgba(0,0,0,0.5);
  --shadow-sm: 0 8px 24px rgba(0,0,0,0.35);
  --font: 'DM Sans', system-ui, sans-serif;
  --font-display: 'Outfit', system-ui, sans-serif;
  --font-mono: 'DM Mono', monospace;
  --sidebar-w: 300px;
  --header-h: 58px;
  --nav-h: 64px;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  position: relative;
}
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 80% 60% at 10% -10%, rgba(var(--accent-rgb),0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 90% 110%, rgba(79,70,229,0.1) 0%, transparent 60%);
  pointer-events: none;
}
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  background-size: 200px;
  pointer-events: none; opacity: 0.4;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 2px; }
* { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.12) transparent; }
::selection { background: rgba(var(--accent-rgb),0.35); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-wrapper {
  position: relative; z-index: 1;
  display: flex; flex-direction: column;
  min-height: 100dvh;
}
.app-header {
  height: var(--header-h);
  background: rgba(8,11,22,0.85);
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
  padding: 0 16px;
  position: sticky; top: 0; z-index: 200;
  flex-shrink: 0;
}
.app-body {
  display: flex; flex: 1;
  min-height: 0;
}
.sidebar {
  width: var(--sidebar-w); flex-shrink: 0;
  background: rgba(8,11,22,0.6);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: sticky; top: var(--header-h);
  height: calc(100dvh - var(--header-h));
  overflow: hidden;
}
.main-area {
  flex: 1; min-width: 0;
  overflow-y: auto;
  padding: 18px 20px 32px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.logo { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.logo-icon {
  width: 34px; height: 34px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; box-shadow: 0 4px 16px rgba(var(--accent-rgb),0.4);
}
.logo-text { font-family: var(--font-display); font-weight: 800; font-size: 16px; letter-spacing: -0.02em; }
.logo-sub { font-size: 10px; color: var(--text3); letter-spacing: 0.05em; }
.header-center { flex: 1; display: flex; justify-content: center; }
.header-stats { display: flex; gap: 2px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.hstat {
  padding: 5px 11px; text-align: center; cursor: default;
  transition: background var(--transition);
}
.hstat:hover { background: var(--glass2); }
.hstat-val { font-family: var(--font-display); font-size: 13px; font-weight: 700; color: var(--text); }
.hstat-lbl { font-size: 9px; color: var(--text3); margin-top: 1px; }
.header-actions { display: flex; gap: 6px; align-items: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 7px 14px; border-radius: var(--radius-xs); border: 1px solid var(--border);
  background: var(--glass); color: var(--text2); cursor: pointer; font-family: var(--font);
  font-size: 12px; font-weight: 500; transition: all var(--transition);
  white-space: nowrap; user-select: none; -webkit-tap-highlight-color: transparent;
}
.btn:hover { background: var(--glass2); color: var(--text); border-color: var(--border2); }
.btn:active { transform: scale(0.97); }
.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-color: transparent; color: white; font-weight: 600;
  box-shadow: 0 4px 16px rgba(var(--accent-rgb),0.35);
}
.btn-primary:hover { filter: brightness(1.1); color: white; }
.btn-icon {
  width: 32px; height: 32px; padding: 0; border-radius: var(--radius-xs);
  flex-shrink: 0; font-size: 14px;
}
.btn-danger { border-color: rgba(239,68,68,0.3); color: #f87171; }
.btn-danger:hover { background: rgba(239,68,68,0.12); color: #fca5a5; }
.btn-success { border-color: rgba(34,197,94,0.3); color: #4ade80; }
.btn-success:hover { background: rgba(34,197,94,0.12); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.input {
  width: 100%; padding: 9px 12px; border-radius: var(--radius-xs);
  border: 1px solid var(--border); background: var(--glass);
  color: var(--text); font-family: var(--font); font-size: 13px;
  outline: none; transition: all var(--transition);
}
.input:focus { border-color: rgba(var(--accent-rgb),0.6); background: var(--glass2); box-shadow: 0 0 0 3px rgba(var(--accent-rgb),0.15); }
.input::placeholder { color: var(--text3); }
textarea.input { resize: vertical; min-height: 72px; }
select.input { cursor: pointer; color-scheme: dark; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='rgba(238,241,255,0.4)' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 30px; }
label.form-label { display: block; font-size: 10px; font-weight: 600; color: var(--text3); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 5px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar-header {
  padding: 12px 14px 10px; border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.sidebar-title { font-family: var(--font-display); font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 6px; }
.count-badge {
  padding: 2px 8px; border-radius: 20px;
  background: rgba(var(--accent-rgb),0.15); color: var(--accent);
  font-size: 11px; font-weight: 700;
}
.search-wrap { position: relative; }
.search-wrap .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text3); font-size: 13px; pointer-events: none; }
.search-wrap .input { padding-left: 30px; padding-top: 7px; padding-bottom: 7px; font-size: 12px; }
.search-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text3); font-size: 16px; padding: 2px; }
.sidebar-filters { margin-top: 8px; display: flex; flex-direction: column; gap: 8px; animation: slideDown 0.2s ease; }
.filter-row { display: flex; gap: 4px; flex-wrap: wrap; }
.filter-chip {
  padding: 3px 9px; border-radius: 20px; border: 1px solid var(--border);
  background: transparent; color: var(--text3); cursor: pointer;
  font-size: 10px; font-family: var(--font); font-weight: 500; transition: all var(--transition);
}
.filter-chip.active { background: rgba(var(--accent-rgb),0.15); border-color: rgba(var(--accent-rgb),0.4); color: var(--accent); }
.filter-chip:hover { border-color: var(--border2); color: var(--text2); }
.sidebar-list { flex: 1; overflow-y: auto; padding: 10px 12px 12px; display: flex; flex-direction: column; gap: 7px; }
.sidebar-add-btn {
  display: flex; align-items: center; justify-content: center; gap: 6px;
  width: 100%; padding: 9px; border-radius: var(--radius-sm);
  border: 2px dashed rgba(var(--accent-rgb),0.3); background: rgba(var(--accent-rgb),0.05);
  color: var(--accent); cursor: pointer; font-size: 12px; font-weight: 600; font-family: var(--font);
  transition: all var(--transition); margin-bottom: 10px;
}
.sidebar-add-btn:hover { border-color: rgba(var(--accent-rgb),0.7); background: rgba(var(--accent-rgb),0.1); }
.sidebar-add-btn:active { transform: scale(0.98); }
.sidebar-empty { text-align: center; padding: 32px 16px; color: var(--text3); }
.sidebar-empty .empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.4; }
.sidebar-empty p { font-size: 12px; line-height: 1.5; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKLOG CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bl-card {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 11px 12px;
  cursor: grab; transition: all var(--transition); position: relative;
  border-left: 3px solid transparent;
}
.bl-card:hover { background: var(--glass2); border-color: var(--border2); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.bl-card:active { cursor: grabbing; transform: translateY(0); }
.bl-card.dragging { opacity: 0.4; }
.bl-card-top { display: flex; align-items: flex-start; gap: 8px; }
.bl-icon {
  width: 30px; height: 30px; border-radius: 8px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 14px;
}
.bl-info { flex: 1; min-width: 0; }
.bl-name { font-size: 12px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.3; }
.bl-desc { font-size: 10px; color: var(--text3); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 1px; }
.bl-meta { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; align-items: center; }
.bl-actions { display: flex; gap: 3px; flex-shrink: 0; }
.bl-prog { margin-top: 7px; }
.bl-prog-bar { height: 3px; border-radius: 2px; background: rgba(255,255,255,0.07); overflow: hidden; }
.bl-prog-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
.bl-prog-info { display: flex; justify-content: space-between; margin-top: 3px; }
.bl-prog-info span { font-size: 9px; color: var(--text3); }
.bl-overdue { position: absolute; top: -1px; right: 8px; background: #ef4444; color: white; font-size: 8px; font-weight: 700; padding: 1px 6px; border-radius: 0 0 6px 6px; letter-spacing: 0.03em; }
.bl-active-badge {
  position: absolute; top: 4px; right: 4px; font-size: 8px;
  color: var(--text3); background: var(--glass2); padding: 1px 5px; border-radius: 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES & TAGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 7px; border-radius: 20px; font-size: 10px; font-weight: 500; flex-shrink: 0;
}
.badge-due-ok { background: rgba(34,197,94,0.12); color: #4ade80; }
.badge-due-soon { background: rgba(234,179,8,0.12); color: #facc15; }
.badge-due-urgent { background: rgba(249,115,22,0.12); color: #fb923c; }
.badge-due-late { background: rgba(239,68,68,0.15); color: #f87171; }
.badge-pri-critical { background: rgba(168,85,247,0.12); color: #c084fc; }
.badge-pri-high { background: rgba(239,68,68,0.12); color: #f87171; }
.badge-pri-medium { background: rgba(249,115,22,0.12); color: #fb923c; }
.badge-pri-low { background: rgba(34,197,94,0.12); color: #4ade80; }
.tag-badge { border-radius: 20px; padding: 1px 7px; font-size: 10px; font-weight: 500; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SLOTS GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
.slot-card {
  border-radius: var(--radius); border: 2px dashed var(--border);
  background: rgba(255,255,255,0.015);
  transition: all var(--transition); min-height: 340px; overflow: hidden;
  display: flex; flex-direction: column;
}
.slot-card.drag-over {
  border-color: var(--accent); background: rgba(var(--accent-rgb),0.08);
  box-shadow: 0 0 30px rgba(var(--accent-rgb),0.15);
}
.slot-card.has-project {
  background: var(--bg2); border-style: solid; border-color: var(--border);
}
.slot-card.has-project:hover { box-shadow: 0 0 40px rgba(var(--accent-rgb),0.07); }
.slot-header {
  padding: 12px 15px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.slot-meta { display: flex; flex-direction: column; }
.slot-label { font-family: var(--font-display); font-size: 13px; font-weight: 700; }
.slot-desc { font-size: 10px; color: var(--text3); margin-top: 1px; }
.slot-body { flex: 1; padding: 14px 15px; display: flex; flex-direction: column; gap: 12px; }
.slot-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; color: var(--text3); gap: 10px; }
.slot-empty-icon { font-size: 38px; opacity: 0.2; }
.slot-empty p { font-size: 12px; line-height: 1.6; }
/* Project in slot */
.sp-header { display: flex; align-items: flex-start; gap: 10px; }
.sp-icon { width: 42px; height: 42px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.sp-info { flex: 1; min-width: 0; }
.sp-name { font-size: 14px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sp-desc { font-size: 11px; color: var(--text2); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sp-prog { }
.sp-prog-label { display: flex; justify-content: space-between; margin-bottom: 5px; }
.sp-prog-label span:first-child { font-size: 11px; color: var(--text2); }
.sp-prog-pct { font-size: 13px; font-weight: 700; }
.sp-prog-bar { height: 7px; border-radius: 4px; background: rgba(255,255,255,0.07); overflow: hidden; }
.sp-prog-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.sp-tasks { }
.sp-tasks-scroll { max-height: 130px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-bottom: 7px; }
.sp-task { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
.task-check {
  width: 18px; height: 18px; border-radius: 5px; border: 2px solid var(--border2);
  background: transparent; cursor: pointer; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
}
.task-check.done { border-color: var(--accent); background: var(--accent); }
.task-check.done::after { content: 'âœ“'; color: white; font-size: 10px; font-weight: 700; }
.task-text { flex: 1; font-size: 12px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.task-text.done { text-decoration: line-through; color: var(--text3); }
.task-del { background: none; border: none; cursor: pointer; color: rgba(255,255,255,0.2); font-size: 14px; padding: 0; opacity: 0; transition: opacity var(--transition); flex-shrink: 0; }
.sp-task:hover .task-del { opacity: 1; }
.sp-task-input { display: flex; gap: 6px; }
.sp-task-input .input { font-size: 12px; padding: 6px 10px; }
.sp-actions { display: flex; gap: 6px; margin-top: auto; flex-wrap: wrap; }
.sp-actions .btn { flex: 1; min-width: 0; font-size: 11px; padding: 6px 8px; justify-content: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS RING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-ring { transform: rotate(-90deg); flex-shrink: 0; }
.prog-ring circle { transition: stroke-dasharray 0.5s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER WIDGET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-widget {
  background: rgba(0,0,0,0.25); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  display: flex; flex-direction: column; gap: 8px;
}
.timer-mode-tabs { display: flex; gap: 3px; }
.timer-tab {
  flex: 1; padding: 4px; border-radius: var(--radius-xs); border: 1px solid var(--border);
  background: transparent; color: var(--text3); cursor: pointer; font-size: 10px; font-family: var(--font);
  font-weight: 600; transition: all var(--transition); text-align: center;
}
.timer-tab.active { background: rgba(var(--accent-rgb),0.15); border-color: rgba(var(--accent-rgb),0.4); color: var(--accent); }
.timer-display { display: flex; align-items: center; gap: 8px; }
.timer-clock { flex: 1; }
.timer-time-edit { display: flex; align-items: center; gap: 4px; }
.timer-seg {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
}
.timer-seg input {
  width: 40px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text); font-family: var(--font-mono); font-size: 18px;
  font-weight: 600; text-align: center; padding: 4px 2px; outline: none;
  transition: border-color var(--transition);
}
.timer-seg input:focus { border-color: rgba(var(--accent-rgb),0.6); }
.timer-seg input:disabled { opacity: 0.5; }
.timer-seg span { font-size: 9px; color: var(--text3); }
.timer-colon { font-family: var(--font-mono); font-size: 18px; font-weight: 700; color: var(--text2); line-height: 1; margin-top: -4px; }
.timer-running .timer-colon { animation: colonBlink 1s steps(1) infinite; }
@keyframes colonBlink { 0%,50%{opacity:1} 51%,100%{opacity:0.15} }
.timer-controls { display: flex; gap: 4px; flex-shrink: 0; }
.timer-controls .btn { width: 28px; height: 28px; padding: 0; font-size: 12px; border-radius: 8px; }
.timer-progress-bar { height: 3px; border-radius: 2px; background: rgba(255,255,255,0.07); overflow: hidden; }
.timer-progress-fill { height: 100%; border-radius: 2px; background: var(--accent); transition: width 0.3s linear; }
.pomo-count { font-size: 10px; color: var(--text3); text-align: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-bg {
  position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 400;
  display: flex; align-items: center; justify-content: center; padding: 16px;
  backdrop-filter: blur(4px); animation: fadeIn 0.15s ease;
}
.modal {
  background: #0e1326; border: 1px solid var(--border2);
  border-radius: 20px; width: 100%; max-width: 560px; max-height: 90dvh;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 40px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.04);
  animation: modalIn 0.2s cubic-bezier(0.34,1.3,0.64,1);
}
.modal-wide { max-width: 680px; }
.modal-header {
  padding: 18px 22px 14px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.modal-title { font-family: var(--font-display); font-size: 17px; font-weight: 700; }
.modal-body { flex: 1; overflow-y: auto; padding: 18px 22px; }
.modal-footer { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; flex-shrink: 0; }
.modal-tabs { display: flex; gap: 2px; padding: 8px 22px 0; border-bottom: 1px solid var(--border); }
.modal-tab {
  padding: 7px 14px; border: none; background: transparent; color: var(--text3);
  cursor: pointer; font-size: 12px; font-family: var(--font); font-weight: 500;
  border-bottom: 2px solid transparent; transition: all var(--transition);
}
.modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.modal-tab-body { display: none; }
.modal-tab-body.active { display: block; }
.form-row { display: flex; gap: 12px; }
.form-row > * { flex: 1; min-width: 0; }
.form-group { margin-bottom: 14px; }
.form-group:last-child { margin-bottom: 0; }
.toggle-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 12px; color: var(--text2); }
.toggle {
  width: 38px; height: 21px; border-radius: 11px; background: rgba(255,255,255,0.1);
  position: relative; cursor: pointer; transition: background var(--transition); flex-shrink: 0;
}
.toggle.on { background: var(--accent); }
.toggle::after {
  content: ''; position: absolute; top: 2px; left: 2px;
  width: 17px; height: 17px; border-radius: 50%; background: white;
  transition: left var(--transition); box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.toggle.on::after { left: 19px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detail-banner {
  padding: 20px 22px; border-bottom: 1px solid var(--border);
}
.detail-banner-inner { display: flex; align-items: flex-start; gap: 14px; }
.detail-icon { width: 56px; height: 56px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
.detail-prog-ring-wrap { position: relative; flex-shrink: 0; }
.detail-prog-ring-wrap span { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 12px; font-weight: 700; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPLETED VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.completed-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
.comp-card {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; cursor: pointer;
  transition: all var(--transition); position: relative; overflow: hidden;
}
.comp-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--c, #7c3aed), transparent);
}
.comp-card:hover { background: var(--glass2); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
.comp-icon { font-size: 26px; margin-bottom: 8px; }
.comp-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
.comp-date { font-size: 10px; color: var(--text3); margin-bottom: 8px; }
.comp-stats { display: flex; gap: 8px; flex-wrap: wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 18px; }
.stat-card {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px 12px; text-align: center;
}
.stat-icon { font-size: 22px; margin-bottom: 6px; }
.stat-val { font-family: var(--font-display); font-size: 26px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
.stat-lbl { font-size: 10px; color: var(--text3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-section { margin-bottom: 24px; }
.settings-section-title { font-size: 10px; font-weight: 700; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
.sync-status { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: var(--radius-xs); background: var(--glass); font-size: 12px; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.sync-dot.idle { background: var(--text3); }
.sync-dot.syncing { background: #facc15; animation: pulse 1s infinite; }
.sync-dot.synced { background: #4ade80; }
.sync-dot.error { background: #f87171; }
.color-swatches { display: flex; gap: 6px; flex-wrap: wrap; }
.color-swatch {
  width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;
  transition: all var(--transition); box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.color-swatch.active { border-color: white; transform: scale(1.2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(8,11,22,0.95); backdrop-filter: blur(24px);
  border-top: 1px solid var(--border); padding: 8px 0 max(8px, env(safe-area-inset-bottom));
}
.mobile-nav-inner { display: flex; justify-content: space-around; }
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 12px; border: none; background: transparent; color: var(--text3);
  cursor: pointer; font-size: 11px; font-family: var(--font); font-weight: 500;
  transition: color var(--transition); border-radius: var(--radius-xs);
  -webkit-tap-highlight-color: transparent;
}
.nav-item.active { color: var(--accent); }
.nav-item span:first-child { font-size: 20px; }
.mobile-fab {
  display: none; position: fixed; right: 18px;
  bottom: calc(var(--nav-h) + 12px + max(0px, env(safe-area-inset-bottom)));
  z-index: 300; width: 52px; height: 52px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none; color: white; font-size: 24px; cursor: pointer;
  box-shadow: 0 8px 24px rgba(var(--accent-rgb),0.5);
  transition: all var(--transition); -webkit-tap-highlight-color: transparent;
}
.mobile-fab:hover { transform: scale(1.08); }
.mobile-fab:active { transform: scale(0.94); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast-container { position: fixed; top: 16px; right: 16px; z-index: 9000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.toast {
  background: #1a2035; border: 1px solid var(--border2);
  border-radius: 12px; padding: 12px 16px; max-width: 300px;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
  animation: toastIn 0.3s cubic-bezier(0.34,1.3,0.64,1);
  pointer-events: auto; font-size: 13px; font-weight: 500;
}
.toast.removing { animation: toastOut 0.25s ease forwards; }
.toast-icon { font-size: 18px; flex-shrink: 0; }
.toast-border-l { width: 3px; height: 100%; border-radius: 2px; align-self: stretch; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MENU DROPDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dropdown {
  position: absolute; right: 0; top: calc(100% + 4px); z-index: 100;
  background: #111828; border: 1px solid var(--border2); border-radius: var(--radius-sm);
  padding: 5px; min-width: 160px; box-shadow: 0 16px 40px rgba(0,0,0,0.6);
  animation: dropIn 0.15s ease;
}
.dropdown-item {
  display: flex; align-items: center; gap: 8px; width: 100%;
  padding: 8px 10px; border: none; background: transparent; color: var(--text2);
  cursor: pointer; font-size: 12px; font-family: var(--font); font-weight: 500;
  border-radius: var(--radius-xs); transition: all var(--transition); text-align: left;
}
.dropdown-item:hover { background: var(--glass2); color: var(--text); }
.dropdown-item.danger { color: #f87171; }
.dropdown-item.danger:hover { background: rgba(239,68,68,0.1); }
.dropdown-sep { height: 1px; background: var(--border); margin: 4px 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLOR & ICON PICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.icon-grid { display: flex; flex-wrap: wrap; gap: 5px; }
.icon-btn {
  width: 36px; height: 36px; border-radius: 8px; border: 2px solid transparent;
  background: var(--glass); cursor: pointer; font-size: 18px; display: flex;
  align-items: center; justify-content: center; transition: all var(--transition);
}
.icon-btn.active { border-color: var(--accent); background: rgba(var(--accent-rgb),0.2); }
.icon-btn:hover { background: var(--glass2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tags-wrap { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.confetti-piece {
  position: fixed; width: 8px; height: 8px; z-index: 9999;
  animation: confettiFall linear forwards;
  pointer-events: none; border-radius: 2px;
}
@keyframes confettiFall {
  0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.section-title { font-family: var(--font-display); font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.divider { height: 1px; background: var(--border); margin: 18px 0; }
.view-hidden { display: none !important; }
.kbd { padding: 2px 6px; border-radius: 5px; background: var(--glass2); border: 1px solid var(--border2); font-family: var(--font-mono); font-size: 10px; color: var(--text3); }
.no-select { user-select: none; -webkit-user-select: none; }
.spin { animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes modalIn { from { opacity: 0; transform: scale(0.94) translateY(16px); } to { opacity: 1; transform: scale(1) translateY(0); } }
@keyframes dropIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastIn { from { opacity: 0; transform: translateX(40px) scale(0.9); } to { opacity: 1; transform: translateX(0) scale(1); } }
@keyframes toastOut { to { opacity: 0; transform: translateX(40px) scale(0.9); } }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
@keyframes shimmer { 0%{background-position:-200%}100%{background-position:200%} }
.skeleton {
  background: linear-gradient(90deg, var(--glass) 0%, var(--glass2) 50%, var(--glass) 100%);
  background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE SIDEBAR OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 250; backdrop-filter: blur(4px); animation: fadeIn 0.15s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE BREAKPOINTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1200px) {
  :root { --sidebar-w: 270px; }
  .slots-grid { grid-template-columns: repeat(3,1fr); gap: 12px; }
}
@media (max-width: 900px) {
  :root { --sidebar-w: 280px; }
  .slots-grid { grid-template-columns: 1fr 1fr; }
  .sidebar {
    position: fixed; left: 0; top: var(--header-h);
    height: calc(100dvh - var(--header-h)); z-index: 260;
    transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay { display: block; }
  .main-area { padding: 14px 14px 100px; }
  .header-stats .hstat:nth-child(n+4) { display: none; }
}
@media (max-width: 640px) {
  :root { --header-h: 52px; }
  .slots-grid { grid-template-columns: 1fr; gap: 12px; }
  .mobile-nav { display: block; }
  .mobile-fab { display: flex; align-items: center; justify-content: center; }
  .header-stats { display: none; }
  .header-actions .btn-text { display: none; }
  .logo-sub { display: none; }
  .main-area { padding: 12px 12px 120px; }
  .modal { border-radius: 20px 20px 0 0; max-height: 92dvh; }
  .modal-bg { align-items: flex-end; padding: 0; }
  .slot-card { min-height: auto; }
  .sp-tasks-scroll { max-height: 100px; }
}
@media (min-width: 641px) {
  .mobile-only { display: none; }
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.login-screen {
  position: fixed; inset: 0; z-index: 10000;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.login-screen::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(ellipse 70% 60% at 50% 30%, rgba(var(--accent-rgb),0.18) 0%, transparent 70%);
  pointer-events: none;
}
.login-card {
  position: relative; z-index: 1;
  background: #0e1326; border: 1px solid var(--border2);
  border-radius: 24px; padding: 36px 32px; width: 100%; max-width: 400px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6);
  animation: modalIn 0.4s cubic-bezier(0.34,1.2,0.64,1);
}
.login-logo { text-align: center; margin-bottom: 28px; }
.login-logo-icon {
  width: 60px; height: 60px; border-radius: 18px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 30px; margin: 0 auto 12px;
  box-shadow: 0 8px 30px rgba(var(--accent-rgb),0.5);
}
.login-logo-title { font-family: var(--font-display); font-size: 24px; font-weight: 800; letter-spacing: -0.03em; }
.login-logo-sub { font-size: 12px; color: var(--text3); margin-top: 3px; }
.login-form { display: flex; flex-direction: column; gap: 14px; }
.login-divider { height: 1px; background: var(--border); margin: 4px 0; }
.login-error { color: #f87171; font-size: 12px; text-align: center; padding: 8px; background: rgba(239,68,68,0.08); border-radius: 8px; display: none; }
.login-lock-overlay {
  position: fixed; inset: 0; z-index: 9500;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PORTAL DROPDOWN (fixed positioning - fixes z-index bug)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dropdown-portal {
  position: fixed !important; z-index: 9900 !important;
  background: #111828; border: 1px solid var(--border2); border-radius: var(--radius-sm);
  padding: 5px; min-width: 180px; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
  animation: dropIn 0.15s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.category-chip {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 600;
  border: 1px solid transparent; cursor: pointer; transition: all var(--transition);
  white-space: nowrap;
}
.category-chip.active { filter: brightness(1.15); }
.cat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.cat-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 7px; border-radius: 20px; font-size: 10px; font-weight: 600;
}
.cats-filter-row { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
.sidebar-cat-section {
  padding: 8px 12px 4px; border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-cat-title { font-size: 10px; font-weight: 700; color: var(--text3); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENHANCED TASKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.task-item {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--radius-xs); margin-bottom: 5px;
  transition: all var(--transition); overflow: hidden;
}
.task-item:hover { border-color: var(--border2); }
.task-item-header { display: flex; align-items: center; gap: 8px; padding: 8px 10px; }
.task-rank { font-family: var(--font-mono); font-size: 10px; color: var(--text3); width: 16px; text-align: center; flex-shrink: 0; }
.task-status-btn {
  width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border2);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: all var(--transition); background: transparent;
  font-size: 9px; font-weight: 700;
}
.task-status-btn.todo { border-color: var(--text3); }
.task-status-btn.in_progress { border-color: #f97316; background: rgba(249,115,22,0.15); color: #fb923c; }
.task-status-btn.done { border-color: #22c55e; background: rgba(34,197,94,0.2); color: #4ade80; }
.task-main-text { flex: 1; font-size: 12px; min-width: 0; cursor: pointer; }
.task-main-text.done { text-decoration: line-through; color: var(--text3); }
.task-main-text.in_progress { color: var(--text); }
.task-priority-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.task-expand-btn { background: none; border: none; cursor: pointer; color: var(--text3); font-size: 12px; padding: 0 2px; transition: transform var(--transition); }
.task-expand-btn.open { transform: rotate(90deg); }
.task-actions-row { display: flex; gap: 3px; flex-shrink: 0; }
.task-actions-row button { background: none; border: none; cursor: pointer; color: var(--text3); font-size: 12px; padding: 1px 3px; opacity: 0; transition: opacity var(--transition); }
.task-item-header:hover .task-actions-row button { opacity: 1; }
.task-item-header:hover .task-actions-row button:hover { color: var(--text); }
.task-detail { padding: 0 10px 10px 38px; border-top: 1px solid rgba(255,255,255,0.04); margin-top: 0; display: none; }
.task-detail.open { display: block; }
.subtask-list { display: flex; flex-direction: column; gap: 3px; margin-bottom: 7px; }
.subtask-row { display: flex; align-items: center; gap: 7px; padding: 4px 0; }
.subtask-check {
  width: 15px; height: 15px; border-radius: 4px; border: 1.5px solid var(--border2);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 8px; transition: all var(--transition);
}
.subtask-check.done { border-color: #22c55e; background: rgba(34,197,94,0.2); color: #4ade80; }
.subtask-text { flex: 1; font-size: 11px; color: var(--text2); }
.subtask-text.done { text-decoration: line-through; color: var(--text3); }
.subtask-del { background: none; border: none; cursor: pointer; color: transparent; font-size: 12px; padding: 0; }
.subtask-row:hover .subtask-del { color: var(--text3); }
.task-note-field { font-size: 11px; color: var(--text3); background: rgba(0,0,0,0.2); border-radius: 6px; padding: 5px 8px; margin-top: 5px; border: 1px solid var(--border); width: 100%; }
.task-meta-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 5px; }
.task-due-badge { font-size: 10px; color: var(--text3); display: flex; align-items: center; gap: 3px; }
/* Drag handle */
.task-drag-handle { cursor: grab; color: var(--text3); font-size: 14px; padding: 0 2px; opacity: 0; }
.task-item-header:hover .task-drag-handle { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOUCH DRAG (mobile)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.touch-drag-ghost {
  position: fixed; z-index: 9999; pointer-events: none;
  opacity: 0.85; transform: scale(1.05) rotate(2deg);
  transition: none; border-radius: var(--radius-sm);
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}
.drag-valid-target { border-color: var(--accent) !important; background: rgba(var(--accent-rgb),0.08) !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPROVED MOBILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  .slot-card { min-height: auto; }
  .sp-tasks-scroll { max-height: 100px; }
  .sp-actions { gap: 4px; }
  .sp-actions .btn { font-size: 10px; padding: 5px 6px; }
  .timer-widget { padding: 8px 10px; }
  .timer-seg input { width: 34px; font-size: 16px; }
  .login-card { padding: 28px 20px; }
  .task-item-header { gap: 5px; padding: 7px 8px; }
}
@media (max-width: 380px) {
  .slots-grid { gap: 8px; }
  .sp-actions .btn span { display: none; }
}
</style>
</head>
<body>
<!-- â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â• -->
<div id="login-screen" class="login-screen" style="display:none">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">ğŸ—‚</div>
      <div class="login-logo-title">ProjectFlow</div>
      <div class="login-logo-sub" id="login-subtitle">Votre espace de travail privÃ©</div>
    </div>
    <div class="login-form">
      <div id="login-error" class="login-error"></div>
      <div id="login-username-wrap" class="form-group">
        <label class="form-label">Nom d'utilisateur</label>
        <input class="input" id="login-username" placeholder="Votre prÃ©nom ou pseudo" autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input class="input" type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <div id="login-confirm-wrap" class="form-group" style="display:none">
        <label class="form-label">Confirmer le mot de passe</label>
        <input class="input" type="password" id="login-confirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn btn-primary" onclick="doLogin()" id="login-btn" style="padding:12px;font-size:14px">
        ğŸ” Se connecter
      </button>
      <div style="text-align:center;font-size:11px;color:var(--text3);margin-top:4px" id="login-hint"></div>
    </div>
  </div>
</div>

<div class="app-wrapper" id="app" style="display:none">

<!-- â•â•â•â•â•â• HEADER â•â•â•â•â•â• -->
<header class="app-header">
  <div class="logo">
    <div class="logo-icon">ğŸ—‚</div>
    <div>
      <div class="logo-text">ProjectFlow</div>
      <div class="logo-sub" id="quote-text">Chargement...</div>
    </div>
  </div>
  <button class="btn btn-icon mobile-only" id="btn-menu-sidebar" onclick="toggleSidebar()" style="display:none">â˜°</button>
  <div class="header-center">
    <div class="header-stats" id="header-stats"></div>
  </div>
  <div class="header-actions">
    <div id="sync-badge" class="sync-status" style="padding:4px 10px;flex-direction:column;gap:1px;cursor:pointer" onclick="openSettings()" title="ParamÃ¨tres sync">
      <div style="display:flex;align-items:center;gap:5px">
        <div class="sync-dot idle" id="sync-dot"></div>
        <span id="sync-label" style="font-size:11px">Local</span>
        <span id="user-label" style="font-size:10px;color:var(--text3);border-left:1px solid var(--border);padding-left:5px;margin-left:2px"></span>
      </div>
      <div style="font-size:9px;color:var(--text3)" id="sync-time"></div>
    </div>
    <button class="btn btn-icon" onclick="openSettings()" title="ParamÃ¨tres">âš™</button>
    <button class="btn btn-icon" onclick="doUndo()" id="undo-btn" title="Annuler (Ctrl+Z)" style="opacity:0.4">â†©</button>
    <button class="btn" onclick="showExportMenu(event)" title="Export">ğŸ“¥ <span class="btn-text">Export</span></button>
    <button class="btn btn-primary" onclick="openNew()" id="btn-new-desktop">+ Projet</button>
  </div>
</header>

<!-- â•â•â•â•â•â• BODY â•â•â•â•â•â• -->
<div class="app-body">

  <!-- SIDEBAR OVERLAY (mobile) -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â• -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-topbar">
        <div class="sidebar-title">
          ğŸ“‹ Liste de projets
          <span class="count-badge" id="backlog-count">0</span>
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-icon" id="btn-filters" onclick="toggleFilters()" title="Filtres">âš™</button>
          <button class="btn btn-icon" id="btn-templates" onclick="openTemplates()" title="Templates">ğŸ“„</button>
          <button class="btn btn-icon" id="btn-archived" onclick="toggleArchived()" title="ArchivÃ©s">ğŸ“¦</button>
        </div>
      </div>
      <!-- Category filter row -->
      <div class="sidebar-cat-section" id="cat-filter-section">
        <div class="sidebar-cat-title">
          CatÃ©gories
          <button onclick="openCategoryManager()" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:12px" title="GÃ©rer">âš™</button>
        </div>
        <div class="cats-filter-row" id="cats-filter-row"></div>
      </div>
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input class="input" id="search-input" placeholder="Rechercher..." oninput="renderBacklog()" autocomplete="off">
        <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none">Ã—</button>
      </div>
      <div id="filters-panel" style="display:none" class="sidebar-filters">
        <div>
          <label class="form-label">Tri</label>
          <select class="input" id="sort-select" onchange="renderBacklog()" style="font-size:11px;padding:5px 28px 5px 8px">
            <option value="createdAt">Plus rÃ©cent</option>
            <option value="name">Nom Aâ†’Z</option>
            <option value="priority">PrioritÃ©</option>
            <option value="progress">Progression</option>
            <option value="dueDate">Date limite</option>
          </select>
        </div>
        <div>
          <label class="form-label">PrioritÃ©</label>
          <div class="filter-row" id="filter-priority-row"></div>
        </div>
        <div id="filter-tags-section" style="display:none">
          <label class="form-label">Tags</label>
          <div class="filter-row" id="filter-tags-row"></div>
        </div>
        <div style="display:flex;gap:4px;margin-top:2px">
          <button class="btn" style="flex:1;font-size:10px" onclick="toggleCompact()">
            <span id="compact-label">ğŸ“‹ Confortable</span>
          </button>
          <button class="btn" style="font-size:10px" onclick="resetFilters()">RÃ©initialiser</button>
        </div>
      </div>
    </div>

    <div class="sidebar-list" id="backlog-list"
      ondragover="event.preventDefault(); setDragOver('backlog')"
      ondragleave="clearDragOver()"
      ondrop="handleDrop(event,'backlog')">
      <button class="sidebar-add-btn" onclick="openNew()">
        + Nouveau projet <span style="opacity:0.5;font-size:10px">(Ctrl+N)</span>
      </button>
      <div id="backlog-cards"></div>
    </div>

    <div id="sidebar-footer" style="padding:8px 12px;border-top:1px solid var(--border);font-size:10px;color:var(--text3);text-align:center;flex-shrink:0"></div>
  </aside>

  <!-- â•â•â•â•â•â• MAIN â•â•â•â•â•â• -->
  <main class="main-area" id="main-area">

    <!-- Active Projects View -->
    <div id="view-board">
      <!-- Habits Widget -->
      <div style="background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px" id="habits-widget">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div style="font-family:var(--font-display);font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px">
            ğŸŒ¿ Habitudes du jour
            <span class="count-badge" id="habits-streak-badge" style="display:none"></span>
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-icon" style="font-size:11px" onclick="addHabitPrompt()" title="Ajouter">+</button>
            <button class="btn btn-icon" style="font-size:11px" onclick="toggleHabitsWidget()" id="habits-collapse-btn" title="RÃ©duire">âˆ’</button>
          </div>
        </div>
        <div id="habits-body"></div>
      </div>
      <!-- Slots -->
      <div class="section-header">
        <div class="section-title">
          âš¡ Projets actifs
          <span style="font-size:11px;color:var(--text3);font-weight:400">Max 3 simultanÃ©s</span>
        </div>
        <button class="btn" onclick="openSlotNamesEditor()" style="font-size:11px">âœ Nommer les slots</button>
      </div>
      <div class="slots-grid" id="slots-grid"></div>

      <!-- Quick stats bar -->
      <div id="quick-stats-bar" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:20px"></div>

      <!-- Keyboard hints -->
      <div style="display:flex;gap:12px;flex-wrap:wrap;padding:10px 14px;background:var(--glass);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11px;color:var(--text3)">
        <span><kbd class="kbd">Ctrl+N</kbd> Nouveau projet</span>
        <span><kbd class="kbd">Ctrl+Z</kbd> Annuler</span>
        <span>ğŸ–± Glisser-dÃ©poser vers slots</span>
        <span>â†’ Assigner depuis la liste</span>
      </div>
    </div>

    <!-- Completed View -->
    <div id="view-completed" class="view-hidden">
      <div class="section-header">
        <div class="section-title">ğŸ† Projets terminÃ©s</div>
        <button class="btn btn-danger" onclick="confirmClearCompleted()" style="font-size:11px">Vider tout</button>
      </div>
      <div id="completed-grid" class="completed-grid"></div>
      <div id="completed-empty" style="text-align:center;padding:60px 20px;color:var(--text3);display:none">
        <div style="font-size:48px;margin-bottom:12px">ğŸ†</div>
        <p style="font-size:14px">Aucun projet terminÃ© pour l'instant.<br>Terminez un projet actif pour le voir ici !</p>
      </div>
    </div>

    <!-- Stats View -->
    <div id="view-stats" class="view-hidden">
      <div class="section-title" style="margin-bottom:16px">ğŸ“Š Tableau de bord</div>
      <div class="stats-grid" id="stats-grid"></div>
      <div class="divider"></div>
      <div class="section-title" style="margin-bottom:12px">ğŸ“ Tous les projets actifs</div>
      <div id="all-projects-overview" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px"></div>
    </div>

  </main>
</div><!-- end app-body -->

<!-- â•â•â•â•â•â• MOBILE NAV â•â•â•â•â•â• -->
<nav class="mobile-nav">
  <div class="mobile-nav-inner">
    <button class="nav-item active" id="nav-list" onclick="setMobileView('list')"><span>ğŸ“‹</span>Liste</button>
    <button class="nav-item" id="nav-board" onclick="setMobileView('board')"><span>âš¡</span>Actifs</button>
    <button class="nav-item" id="nav-done" onclick="setMobileView('completed')"><span>ğŸ†</span>TerminÃ©s</button>
    <button class="nav-item" id="nav-stats" onclick="setMobileView('stats')"><span>ğŸ“Š</span>Stats</button>
    <button class="nav-item" id="nav-settings" onclick="openSettings()"><span>âš™</span>RÃ©glages</button>
  </div>
</nav>
<button class="mobile-fab" onclick="openNew()">ï¼‹</button>

<!-- â•â•â•â•â•â• TOAST CONTAINER â•â•â•â•â•â• -->
<div class="toast-container" id="toast-container"></div>

</div><!-- end app-wrapper -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB_FILENAME = 'database.json';
const LS_KEY = 'pf_local_v2';
const LS_GITHUB_KEY = 'pf_github';

const COLORS = ['#7c3aed','#4f46e5','#0ea5e9','#06b6d4','#10b981','#22c55e','#84cc16','#eab308','#f97316','#ef4444','#f43f5e','#ec4899','#a855f7','#8b5cf6','#6366f1'];
const ICONS = ['ğŸš€','ğŸ’¡','ğŸ¯','ğŸ“š','ğŸ’¼','ğŸ¨','ğŸ”§','ğŸŒ±','âš¡','ğŸ†','ğŸµ','ğŸ”¬','ğŸŒ','ğŸ’ª','âœ¨','ğŸ§ ','â¤ï¸','ğŸ”¥','ğŸŒŸ','ğŸ­','ğŸ¦‹','ğŸŒŠ','ğŸª','ğŸ—ï¸','ğŸ²','ğŸ“','ğŸ‹ï¸','ğŸ¹','ğŸ“±','ğŸ–¥ï¸'];
const PRIO = {
  critical: { label:'Critique', dot:'ğŸ”´', bgClass:'badge-pri-critical' },
  high:     { label:'Ã‰levÃ©',    dot:'ğŸŸ ', bgClass:'badge-pri-high'     },
  medium:   { label:'Moyen',    dot:'ğŸŸ¡', bgClass:'badge-pri-medium'   },
  low:      { label:'Faible',   dot:'ğŸŸ¢', bgClass:'badge-pri-low'      }
};
const SLOT_INFO = {
  primary:   { emoji:'ğŸ¯', label:'Primaire',   desc:'Votre prioritÃ© absolue' },
  secondary: { emoji:'âš¡', label:'Secondaire', desc:'Important mais flexible' },
  pleasure:  { emoji:'ğŸ˜Š', label:'Plaisir',    desc:'Pour la joie crÃ©ative' }
};
const TEMPLATES = [
  { name:'App / Web', icon:'ğŸ”§', color:'#6366f1', tags:['dev','tech'],     tasks:['Setup & config','Design UI','Dev backend','Tests','DÃ©ploiement'] },
  { name:'CrÃ©atif',   icon:'ğŸ¨', color:'#ec4899', tags:['crÃ©atif','art'],   tasks:['Brainstorm','Maquettes','CrÃ©ation','RÃ©vision','Finalisation'] },
  { name:'Apprentissage',icon:'ğŸ“š',color:'#22c55e',tags:['learning'],      tasks:['Objectifs','Ressources','Pratiquer','Notes','RÃ©vision'] },
  { name:'Sport',     icon:'ğŸ’ª', color:'#f97316', tags:['santÃ©','sport'],   tasks:['Programme','Semaine 1','Semaine 2','Semaine 3','Ã‰valuation'] },
  { name:'Business',  icon:'ğŸ’¼', color:'#0ea5e9', tags:['business','pro'],  tasks:['MarchÃ©','ModÃ¨le Ã©co','Marketing','Finance','Pitch'] },
  { name:'Musique',   icon:'ğŸµ', color:'#a855f7', tags:['music','crÃ©atif'], tasks:['Concept','Enregistrement','Mixage','Artwork','Publication'] },
  { name:'Voyage',    icon:'ğŸŒ', color:'#14b8a6', tags:['perso','voyage'],  tasks:['Destinations','Billets','HÃ©bergement','ActivitÃ©s','Packing'] },
  { name:'Recherche', icon:'ğŸ”¬', color:'#8b5cf6', tags:['research','pro'],  tasks:['Sujet','Sources','Analyse','RÃ©daction','RÃ©vision'] },
];
const QUOTES = [
  'La constance bat le talent quand il ne travaille pas.',
  'Un projet commencÃ© est Ã  moitiÃ© fini.',
  'Le secret, c\'est de commencer.',
  'Focus sur le progrÃ¨s, pas la perfection.',
  'Petits pas, grandes victoires.',
  'Chaque jour est une nouvelle opportunitÃ©.',
  'Un objectif sans plan est juste un souhait.',
  'La discipline est le pont entre les objectifs et les rÃ©sultats.',
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  projects: [],
  slots: { primary: null, secondary: null, pleasure: null },
  completedProjects: [],
  categories: [
    { id: 'cat_general', name: 'GÃ©nÃ©ral', color: '#6366f1', icon: 'ğŸ“' },
    { id: 'cat_tech', name: 'Tech / Dev', color: '#0ea5e9', icon: 'ğŸ’»' },
    { id: 'cat_creative', name: 'CrÃ©atif', color: '#ec4899', icon: 'ğŸ¨' },
    { id: 'cat_learning', name: 'Apprentissage', color: '#22c55e', icon: 'ğŸ“š' },
    { id: 'cat_perso', name: 'Personnel', color: '#f97316', icon: 'ğŸ ' },
  ],
  habits: [],
  habitLog: {},
  settings: {
    accent: '#7c3aed',
    compact: false,
    slotNames: { primary: 'Primaire', secondary: 'Secondaire', pleasure: 'Plaisir' },
    timerDefault: { mode: 'countdown', h: 0, m: 25, s: 0 },
    habitsCollapsed: false
  }
};
let filterActive = { priority: '', tags: [], archived: false, category: '' };
let undoStack = [];
let timers = {};
let github = { token: '', owner: '', repo: '', sha: null };
let syncStatus = 'idle';
let draggedId = null, dragFrom = null, dragOverZone = null;
let mobileView = 'board';
let openDropdown = null;
let activeModalBg = null;
let saveTimeout = null;
let lastSaveTime = null;
let broadcastChannel = null;
let touchDragId = null, touchGhost = null, touchDragOver = null;
const LS_AUTH_KEY = 'pf_auth_v1';

const uid = () => Math.random().toString(36).slice(2,11) + Date.now().toString(36);
const fmtDate = d => d ? new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}) : '';
const fmtDateTime = d => d ? new Date(d).toLocaleString('fr-FR',{day:'2-digit',month:'short',year:'numeric'}) : '';
const daysUntil = d => d ? Math.ceil((new Date(d) - Date.now()) / 86400000) : null;
const clamp = (v,min,max) => Math.max(min, Math.min(max,v));
const proj = id => state.projects.find(p => p.id === id) || state.completedProjects.find(p => p.id === id);
const progress = p => p.tasks.length ? Math.round(p.tasks.filter(t=>t.done).length/p.tasks.length*100) : 0;
const isOverdue = p => p.dueDate && new Date(p.dueDate) < new Date() && !p.completed && !p.archived;
const getCat = id => state.categories.find(c=>c.id===id);

// â”€â”€ AUTH SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function hashPwd(pwd) {
  const enc = new TextEncoder().encode(pwd + 'pf_salt_2024');
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function getAuth() {
  try { return JSON.parse(localStorage.getItem(LS_AUTH_KEY)) || null; } catch(e) { return null; }
}

async function doLogin() {
  const auth = getAuth();
  const username = document.getElementById('login-username')?.value.trim();
  const password = document.getElementById('login-password')?.value;
  const confirm = document.getElementById('login-confirm')?.value;
  const errEl = document.getElementById('login-error');

  if (!password) { showLoginError('Saisissez un mot de passe'); return; }

  if (!auth) {
    // First time: create account
    if (!username) { showLoginError('Choisissez un nom d\'utilisateur'); return; }
    if (password.length < 4) { showLoginError('Mot de passe trop court (min 4 caractÃ¨res)'); return; }
    if (password !== confirm) { showLoginError('Les mots de passe ne correspondent pas'); return; }
    const hash = await hashPwd(password);
    localStorage.setItem(LS_AUTH_KEY, JSON.stringify({ username, hash, createdAt: new Date().toISOString() }));
    launchApp(username);
  } else {
    // Login
    const hash = await hashPwd(password);
    if (hash !== auth.hash) { showLoginError('Mot de passe incorrect'); return; }
    launchApp(auth.username);
  }
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  if (el) { el.textContent = msg; el.style.display = 'block'; setTimeout(()=>el.style.display='none', 3000); }
}

function launchApp(username) {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  // Add username display in header
  const lbl = document.getElementById('user-label');
  if (lbl) lbl.textContent = username;
  loadAndRender();
}

function showLoginScreen() {
  const auth = getAuth();
  const loginScreen = document.getElementById('login-screen');
  const app = document.getElementById('app');
  app.style.display = 'none';

  if (auth) {
    // Returning user
    document.getElementById('login-subtitle').textContent = `Bon retour, ${auth.username} !`;
    document.getElementById('login-username-wrap').style.display = 'none';
    document.getElementById('login-btn').textContent = 'ğŸ” Se connecter';
    document.getElementById('login-hint').textContent = 'Vos donnÃ©es sont protÃ©gÃ©es localement';
    document.getElementById('login-password').placeholder = 'Votre mot de passe';
  } else {
    // New user
    document.getElementById('login-subtitle').textContent = 'CrÃ©ez votre espace privÃ©';
    document.getElementById('login-username-wrap').style.display = 'block';
    document.getElementById('login-confirm-wrap').style.display = 'block';
    document.getElementById('login-btn').textContent = 'âœ¨ CrÃ©er mon compte';
    document.getElementById('login-hint').textContent = 'Compte local â€” personne d\'autre ne peut accÃ©der Ã  vos projets';
  }
  loginScreen.style.display = 'flex';
  setTimeout(()=>{
    const inp = auth ? document.getElementById('login-password') : document.getElementById('login-username');
    if (inp) inp.focus();
  }, 100);
}

async function loadAndRender() {
  // BroadcastChannel
  try {
    broadcastChannel = new BroadcastChannel('projectflow_sync');
    broadcastChannel.onmessage = (e) => {
      if (e.data?.type === 'state_update') { applyData(e.data.data); renderAll(); toast('ğŸ”„ Sync entre onglets', 'info'); }
    };
  } catch(e) {}

  // Load GitHub config
  const ghStr = localStorage.getItem(LS_GITHUB_KEY);
  if (ghStr) try { Object.assign(github, JSON.parse(ghStr)); } catch(e) {}

  let loaded = false;
  if (github.token && github.owner && github.repo) loaded = await syncFromGitHub();
  if (!loaded) {
    try {
      const r = await fetch('./database.json?t=' + Date.now());
      if (r.ok) { const d = await r.json(); applyData(d); loaded = true; setSyncStatus('synced'); }
    } catch(e) {}
  }
  if (!loaded) {
    const ls = localStorage.getItem(LS_KEY);
    if (ls) try { applyData(JSON.parse(ls)); } catch(e) {}
    setSyncStatus('idle');
  }

  applyAccent(state.settings.accent || '#7c3aed');
  document.getElementById('quote-text').textContent = QUOTES[new Date().getDay() % QUOTES.length];
  renderFilterPriority();
  renderCategoryFilters();
  renderAll();
  renderHeaderStats();
  setMobileView('board');

  // Auto-sync every 5min
  setInterval(()=>{ if (github.token&&github.owner&&github.repo) saveData(); }, 5*60*1000);
  setInterval(updateSyncTime, 30000);
}

function newProject(overrides={}) {
  return {
    id: uid(), name: '', description: '', icon: ICONS[Math.floor(Math.random()*ICONS.length)],
    color: COLORS[Math.floor(Math.random()*COLORS.length)], tasks: [], tags: [],
    priority: 'medium', dueDate: '', notes: '', links: [],
    estimatedHours: 0, loggedHours: 0, pomodoroCount: 0,
    categoryId: 'cat_general',
    pinned: false, archived: false, completed: false,
    createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
    ...overrides
  };
}

function newTask(text='') {
  return { id: uid(), text, done: false, status: 'todo', priority: 'medium', rank: 0, subtasks: [], note: '', dueDate: '' };
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  document.addEventListener('keydown', onKeyDown);
  document.addEventListener('click', e => {
    if (openDropdown && !openDropdown.contains(e.target)) closeDropdown();
  });
  window.addEventListener('resize', onResize);
  showLoginScreen();
}

function applyData(d) {
  if (!d) return;
  if (Array.isArray(d.projects)) state.projects = d.projects;
  if (d.slots) state.slots = { primary:null, secondary:null, pleasure:null, ...d.slots };
  if (Array.isArray(d.completedProjects)) state.completedProjects = d.completedProjects;
  if (d.settings) state.settings = { ...state.settings, ...d.settings };
  if (Array.isArray(d.categories) && d.categories.length) state.categories = d.categories;
  if (Array.isArray(d.habits)) state.habits = d.habits;
  if (d.habitLog) state.habitLog = d.habitLog;
  if (!state.settings.slotNames) state.settings.slotNames = { primary:'Primaire', secondary:'Secondaire', pleasure:'Plaisir' };
  // Migrate old tasks to new format
  state.projects.forEach(p => {
    p.tasks = (p.tasks||[]).map(t => ({
      status: t.done ? 'done' : 'todo', priority: 'medium', rank: 0, subtasks: [], note: '', dueDate: '', ...t
    }));
    if (!p.categoryId) p.categoryId = 'cat_general';
  });
}

// â”€â”€ SYNC & SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dataSnapshot() {
  return {
    version: '3.0',
    lastUpdated: new Date().toISOString(),
    projects: state.projects,
    slots: state.slots,
    completedProjects: state.completedProjects,
    categories: state.categories,
    habits: state.habits,
    habitLog: state.habitLog,
    settings: state.settings
  };
}

function scheduleSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveData, 500);
}

async function saveData() {
  const data = dataSnapshot();
  const json = JSON.stringify(data, null, 2);
  try { localStorage.setItem(LS_KEY, json); } catch(e) {}
  lastSaveTime = new Date(); updateSyncTime();
  if (broadcastChannel) try { broadcastChannel.postMessage({ type:'state_update', data }); } catch(e) {}
  if (github.token && github.owner && github.repo) await saveToGitHub(json);
}


async function saveToGitHub(json) {
  setSyncStatus('syncing');
  try {
    // Get current SHA if not cached
    if (!github.sha) {
      const r = await fetch(`https://api.github.com/repos/${github.owner}/${github.repo}/contents/${DB_FILENAME}`, {
        headers: { 'Authorization': 'token ' + github.token, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (r.ok) { const d = await r.json(); github.sha = d.sha; }
    }
    const body = { message: 'ğŸ”„ ProjectFlow sync ' + new Date().toLocaleTimeString('fr-FR'), content: btoa(unescape(encodeURIComponent(json))), ...(github.sha ? { sha: github.sha } : {}) };
    const r2 = await fetch(`https://api.github.com/repos/${github.owner}/${github.repo}/contents/${DB_FILENAME}`, {
      method: 'PUT', headers: { 'Authorization': 'token ' + github.token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (r2.ok) {
      const d2 = await r2.json(); github.sha = d2.content.sha;
      setSyncStatus('synced');
    } else {
      const err = await r2.json();
      // SHA mismatch â†’ refetch
      if (r2.status === 409) { github.sha = null; await saveToGitHub(json); return; }
      setSyncStatus('error'); console.error('GitHub save error:', err);
    }
  } catch(e) { setSyncStatus('error'); console.error('GitHub sync error:', e); }
}

async function syncFromGitHub() {
  setSyncStatus('syncing');
  try {
    const r = await fetch(`https://api.github.com/repos/${github.owner}/${github.repo}/contents/${DB_FILENAME}`, {
      headers: { 'Authorization': 'token ' + github.token, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!r.ok) { setSyncStatus('error'); return false; }
    const d = await r.json();
    github.sha = d.sha;
    const json = decodeURIComponent(escape(atob(d.content.replace(/\n/g,''))));
    applyData(JSON.parse(json));
    setSyncStatus('synced');
    return true;
  } catch(e) { setSyncStatus('error'); return false; }
}

function pushUndo() {
  undoStack.push(JSON.parse(JSON.stringify({ projects:state.projects, slots:state.slots, completedProjects:state.completedProjects })));
  if (undoStack.length > 20) undoStack.shift();
  document.getElementById('undo-btn').style.opacity = '1';
}

function doUndo() {
  if (!undoStack.length) return;
  const snap = undoStack.pop();
  state.projects = snap.projects;
  state.slots = snap.slots;
  state.completedProjects = snap.completedProjects;
  if (!undoStack.length) document.getElementById('undo-btn').style.opacity = '0.4';
  renderAll(); scheduleSave(); toast('Action annulÃ©e â†©', 'info');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderBacklog();
  renderSlots();
  renderCompleted();
  renderStats();
  renderHeaderStats();
  updateAllProjectsOverview();
  renderQuickStats();
  renderHabits();
  renderCategoryFilters();
}

function renderHeaderStats() {
  const slotIds = Object.values(state.slots).filter(Boolean);
  const allTasks = state.projects.reduce((a,p)=>a+p.tasks.length,0);
  const doneTasks = state.projects.reduce((a,p)=>a+p.tasks.filter(t=>t.done).length,0);
  const pomos = state.projects.reduce((a,p)=>a+(p.pomodoroCount||0),0) + state.completedProjects.reduce((a,p)=>a+(p.pomodoroCount||0),0);
  const el = document.getElementById('header-stats');
  el.innerHTML = [
    { v: state.projects.length, l:'projets' },
    { v: `${slotIds.length}/3`, l:'actifs' },
    { v: `${doneTasks}/${allTasks}`, l:'tÃ¢ches' },
    { v: pomos, l:'ğŸ…' },
    { v: state.completedProjects.length, l:'terminÃ©s' },
  ].map(s => `<div class="hstat"><div class="hstat-val">${s.v}</div><div class="hstat-lbl">${s.l}</div></div>`).join('');
}

// â”€â”€ BACKLOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCategoryFilters() {
  const row = document.getElementById('cats-filter-row');
  if (!row) return;
  const chips = [{ id:'', name:'Tout', color:'var(--text3)', icon:'ğŸ“‹' }, ...state.categories].map(c =>
    `<button class="category-chip${filterActive.category===c.id?' active':''}" 
      style="background:${filterActive.category===c.id?(c.color||'var(--accent)')+'22':'transparent'};color:${filterActive.category===c.id?(c.color||'var(--accent)'):'var(--text3)'};border-color:${filterActive.category===c.id?(c.color||'var(--accent)')+'60':'var(--border)'};"
      onclick="setCatFilter('${c.id}')">${c.icon} ${c.name}</button>`
  ).join('');
  row.innerHTML = chips;
}

function setCatFilter(id) {
  filterActive.category = filterActive.category===id ? '' : id;
  renderCategoryFilters(); renderBacklog();
}

function renderBacklog() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const sortBy = document.getElementById('sort-select').value;
  const showArchived = filterActive.archived;
  const slotIds = Object.values(state.slots).filter(Boolean);

  document.getElementById('search-clear').style.display = search ? 'block' : 'none';

  let list = state.projects.filter(p => {
    if (showArchived) return p.archived && !p.completed;
    if (p.archived || p.completed) return false;
    if (search && !p.name.toLowerCase().includes(search) && !p.description.toLowerCase().includes(search) && !p.tags.some(t=>t.includes(search))) return false;
    if (filterActive.priority && p.priority !== filterActive.priority) return false;
    if (filterActive.tags.length && !filterActive.tags.some(t=>p.tags.includes(t))) return false;
    if (filterActive.category && p.categoryId !== filterActive.category) return false;
    return true;
  });

  const ordPri = {critical:0,high:1,medium:2,low:3};
  list.sort((a,b) => {
    if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    switch(sortBy) {
      case 'name': return a.name.localeCompare(b.name);
      case 'priority': return ordPri[a.priority] - ordPri[b.priority];
      case 'progress': return progress(b) - progress(a);
      case 'dueDate': return (a.dueDate||'9999') > (b.dueDate||'9999') ? 1 : -1;
      default: return new Date(b.createdAt) - new Date(a.createdAt);
    }
  });

  document.getElementById('backlog-count').textContent = list.length;

  // Update tags filter UI
  updateTagFilters();

  const container = document.getElementById('backlog-cards');
  if (!list.length) {
    container.innerHTML = `<div class="sidebar-empty"><div class="empty-icon">${showArchived?'ğŸ“¦':'âœ¨'}</div><p>${showArchived?'Aucun projet archivÃ©':'Votre liste est vide !<br>CrÃ©ez un projet ou choisissez un template.'}</p></div>`;
  } else {
    container.innerHTML = list.map(p => renderBacklogCard(p, slotIds.includes(p.id))).join('');
    // Bind drag events (desktop + touch/mobile)
    container.querySelectorAll('.bl-card').forEach(el => {
      el.addEventListener('dragstart', e => { draggedId=el.dataset.id; dragFrom='backlog'; el.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
      el.addEventListener('dragend', () => { el.classList.remove('dragging'); clearDragOver(); });
      // Touch drag for mobile
      el.addEventListener('touchstart', onTouchDragStart, { passive: true });
    });
  }

  // Footer
  const archived = state.projects.filter(p=>p.archived&&!p.completed).length;
  document.getElementById('sidebar-footer').innerHTML = archived && !showArchived
    ? `<button style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:11px" onclick="toggleArchived()">ğŸ“¦ ${archived} projet${archived>1?'s':''} archivÃ©${archived>1?'s':''}</button>`
    : showArchived ? `<button style="background:none;border:none;cursor:pointer;color:var(--accent);font-size:11px" onclick="toggleArchived()">â† Retour Ã  la liste</button>` : '';
}

function renderBacklogCard(p, inSlot) {
  const pct = progress(p);
  const overdue = isOverdue(p);
  const due = daysUntil(p.dueDate);
  const dueBadge = p.dueDate ? `<span class="badge ${due < 0 ? 'badge-due-late' : due <= 2 ? 'badge-due-urgent' : due <= 7 ? 'badge-due-soon' : 'badge-due-ok'}">ğŸ“… ${due < 0 ? Math.abs(due)+'j retard' : due===0?'Auj.':due===1?'Demain':due+'j'}</span>` : '';
  const compact = state.settings.compact;
  const cat = getCat(p.categoryId);
  const catBadge = cat ? `<span class="cat-badge" style="background:${cat.color}20;color:${cat.color}">${cat.icon} ${cat.name}</span>` : '';
  return `<div class="bl-card" data-id="${p.id}" draggable="true" style="border-left-color:${p.color};${inSlot?'opacity:0.65;':''}">
    ${overdue ? '<div class="bl-overdue">EN RETARD</div>' : ''}
    ${inSlot ? '<div class="bl-active-badge">actif</div>' : ''}
    <div class="bl-card-top">
      <div class="bl-icon" style="background:${p.color}22">${p.icon}</div>
      <div class="bl-info">
        <div class="bl-name">${p.pinned?'ğŸ“Œ ':''}<span title="${esc(p.name)}">${esc(p.name)||'<em style="opacity:0.4">Sans titre</em>'}</span></div>
        ${!compact && p.description ? `<div class="bl-desc">${esc(p.description)}</div>` : ''}
        ${!compact ? `<div class="bl-meta">
          <span class="badge ${PRIO[p.priority].bgClass}">${PRIO[p.priority].dot} ${PRIO[p.priority].label}</span>
          ${dueBadge}
          ${catBadge}
          ${p.tags.slice(0,2).map(t=>`<span class="tag-badge" style="background:${tagColor(t)}22;color:${tagColor(t)}">#${esc(t)}</span>`).join('')}
        </div>` : ''}
      </div>
      <div class="bl-actions">
        <button class="btn btn-icon" style="font-size:11px;color:${p.color}" onclick="assignDropdown(event,'${p.id}')" title="Assigner">â†’</button>
        <button class="btn btn-icon" onclick="openCardMenu(event,'${p.id}')" title="Menu">â‹®</button>
      </div>
    </div>
    ${p.tasks.length ? `<div class="bl-prog">
      <div class="bl-prog-bar"><div class="bl-prog-fill" style="width:${pct}%;background:${p.color}"></div></div>
      <div class="bl-prog-info"><span>${p.tasks.filter(t=>t.done).length}/${p.tasks.length} tÃ¢ches</span><span style="color:${p.color};font-weight:700">${pct}%</span></div>
    </div>` : ''}
  </div>`;
}

// â”€â”€ SLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSlots() {
  const grid = document.getElementById('slots-grid');
  grid.innerHTML = Object.entries(SLOT_INFO).map(([key, meta]) => {
    const customLabel = state.settings.slotNames?.[key] || meta.label;
    const projId = state.slots[key];
    const p = projId ? state.projects.find(x=>x.id===projId) : null;
    const isDragOver = dragOverZone === key;
    return `<div class="slot-card${p?' has-project':''}${isDragOver?' drag-over':''}" id="slot-${key}"
      ondragover="event.preventDefault(); setDragOver('${key}')"
      ondragleave="clearDragOver()"
      ondrop="handleDrop(event,'${key}')">
      <div class="slot-header" style="${p?`background:linear-gradient(135deg,${p.color}18,${p.color}07);border-bottom-color:${p.color}25`:''}">
        <div class="slot-meta">
          <div class="slot-label" style="${p?`color:${p.color}`:'color:var(--text3)'}">${meta.emoji} ${customLabel}</div>
          <div class="slot-desc">${meta.desc}</div>
        </div>
        ${p ? `<div style="display:flex;align-items:center;gap:6px">
          ${renderProgRing(progress(p), 36, 3, p.color)}
          <span style="font-family:var(--font-display);font-size:12px;font-weight:700;color:${p.color}">${progress(p)}%</span>
        </div>` : ''}
      </div>
      ${p ? renderActiveProject(p, key) : `<div class="slot-empty">
        <div class="slot-empty-icon">${meta.emoji}</div>
        <p>Glissez un projet ici<br>ou utilisez la flÃ¨che â†’</p>
      </div>`}
    </div>`;
  }).join('');

  // After rendering, bind task checkboxes and inputs
  Object.keys(state.slots).forEach(key => {
    const projId = state.slots[key];
    if (!projId) return;
    const p = state.projects.find(x=>x.id===projId);
    if (!p) return;
    // Timer setup if not already running
    if (!timers[projId]) initTimer(projId, p);
    renderTimerWidget(projId);
  });
}

function renderActiveProject(p, slotKey) {
  const pct = progress(p);
  const tasks = p.tasks.slice(0,6);
  const more = p.tasks.length - 6;
  return `<div class="slot-body">
    <div class="sp-header">
      <div class="sp-icon" style="background:${p.color}22">${p.icon}</div>
      <div class="sp-info">
        <div class="sp-name">${esc(p.name)||'Sans titre'}</div>
        ${p.description ? `<div class="sp-desc">${esc(p.description)}</div>` : ''}
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">
          <span class="badge ${PRIO[p.priority].bgClass}">${PRIO[p.priority].dot} ${PRIO[p.priority].label}</span>
          ${p.dueDate ? (() => { const d=daysUntil(p.dueDate); return `<span class="badge ${d<0?'badge-due-late':d<=2?'badge-due-urgent':d<=7?'badge-due-soon':'badge-due-ok'}">ğŸ“… ${d<0?Math.abs(d)+'j retard':d===0?'Auj.':d+'j'}</span>`; })() : ''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;flex-shrink:0">
        <button class="btn btn-icon" style="font-size:12px" onclick="openEditProj('${p.id}')" title="Modifier">âœ</button>
        <button class="btn btn-icon" style="font-size:12px;color:var(--text3)" onclick="removeFromSlot('${slotKey}')" title="Remettre en liste">â†©</button>
      </div>
    </div>

    <div class="sp-prog">
      <div class="sp-prog-label">
        <span>${p.tasks.filter(t=>t.done).length}/${p.tasks.length} tÃ¢ches</span>
        <span class="sp-prog-pct" style="color:${p.color}">${pct}%</span>
      </div>
      <div class="sp-prog-bar"><div class="sp-prog-fill" style="width:${pct}%;background:linear-gradient(90deg,${p.color},${p.color}cc);box-shadow:0 0 10px ${p.color}60"></div></div>
    </div>

    <div class="sp-tasks">
      <div class="sp-tasks-scroll" id="tasks-${p.id}" style="max-height:160px;overflow-y:auto">
        ${tasks.map((t,i) => renderEnhancedTask(t, p.id, i)).join('')}
        ${more > 0 ? `<div style="font-size:10px;color:var(--text3);text-align:center;padding:4px">+ ${more} de plus â€” <a href="#" onclick="openDetailProj('${p.id}');return false" style="color:var(--accent)">voir tout</a></div>` : ''}
      </div>
      <div class="sp-task-input">
        <input class="input" id="task-input-${p.id}" placeholder="+ Ajouter une tÃ¢che..." onkeydown="if(event.key==='Enter')addTask('${p.id}','${p.id}')">
        <button class="btn" style="padding:6px 10px;font-size:16px;flex-shrink:0" onclick="addTask('${p.id}','${p.id}')">+</button>
      </div>
    </div>

    <!-- Timer Widget -->
    <div id="timer-${p.id}"></div>

    <div class="sp-actions">
      <button class="btn" onclick="openDetailProj('${p.id}')">ğŸ‘ DÃ©tails</button>
      <button class="btn" onclick="openNotesQuick('${p.id}')">ğŸ“ Notes</button>
      <button class="btn btn-success" onclick="completeProject('${p.id}')">ğŸ† Terminer</button>
    </div>
  </div>`;
}

// â”€â”€ PROGRESS RING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProgRing(val, size=44, stroke=4, color='var(--accent)') {
  const r = (size-stroke)/2, circ = 2*Math.PI*r, dash = (val/100)*circ;
  return `<svg class="prog-ring" width="${size}" height="${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="${stroke}"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${color}" stroke-width="${stroke}" stroke-dasharray="${dash} ${circ}" stroke-linecap="round"/></svg>`;
}

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTimer(projId, p) {
  if (timers[projId]) return;
  const def = state.settings.timerDefault || { mode:'countdown', h:0, m:25, s:0 };
  timers[projId] = { mode: def.mode, h: def.h, m: def.m, s: def.s, running: false, elapsed: 0, totalSecs: def.h*3600+def.m*60+def.s, intervalId: null };
}

function renderTimerWidget(projId) {
  const el = document.getElementById('timer-' + projId);
  if (!el) return;
  const t = timers[projId];
  if (!t) return;
  const p = state.projects.find(x=>x.id===projId);

  let display, progress_ = 0;
  if (t.mode === 'countdown') {
    const rem = Math.max(0, t.totalSecs - t.elapsed);
    display = secsToHMS(rem);
    progress_ = t.totalSecs > 0 ? (t.elapsed/t.totalSecs)*100 : 0;
  } else if (t.mode === 'stopwatch') {
    display = secsToHMS(t.elapsed);
    progress_ = Math.min(100, (t.elapsed % 3600) / 3600 * 100);
  } else { // alarm
    const alarmSecs = t.h*3600 + t.m*60 + t.s;
    const now = new Date(); const nowSecs = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
    let rem2 = alarmSecs - nowSecs; if (rem2 < 0) rem2 += 86400;
    display = secsToHMS(rem2);
    progress_ = 100 - (rem2/86400)*100;
  }
  const [dh, dm, ds] = display;

  el.innerHTML = `<div class="timer-widget${t.running?' timer-running':''}">
    <div class="timer-mode-tabs">
      ${['countdown','stopwatch','alarm'].map(m=>`<button class="timer-tab${t.mode===m?' active':''}" onclick="setTimerMode('${projId}','${m}')">${{countdown:'â± Compte',stopwatch:'â² Chrono',alarm:'â° Alarme'}[m]}</button>`).join('')}
    </div>
    <div class="timer-display">
      <div class="timer-clock">
        <div class="timer-time-edit">
          ${t.mode==='stopwatch' ? `<div style="font-family:var(--font-mono);font-size:22px;font-weight:700;color:var(--accent);padding:4px 0">${pad(dh)}:${pad(dm)}:${pad(ds)}</div>` :
          `<div class="timer-seg"><input type="number" value="${pad(dh)}" min="0" max="23" ${t.running?'disabled':''} onchange="setTimerH('${projId}',this.value)"><span>h</span></div>
          <div class="timer-colon">:</div>
          <div class="timer-seg"><input type="number" value="${pad(dm)}" min="0" max="59" ${t.running?'disabled':''} onchange="setTimerM('${projId}',this.value)"><span>min</span></div>
          <div class="timer-colon">:</div>
          <div class="timer-seg"><input type="number" value="${pad(ds)}" min="0" max="59" ${t.running?'disabled':''} onchange="setTimerS('${projId}',this.value)"><span>sec</span></div>`}
        </div>
        <div class="timer-progress-bar" style="margin-top:5px"><div class="timer-progress-fill" style="width:${progress_}%"></div></div>
      </div>
      <div class="timer-controls">
        <button class="btn ${t.running?'btn-danger':''}" onclick="toggleTimer('${projId}')" title="${t.running?'Pause':'DÃ©marrer'}">${t.running?'â¸':'â–¶'}</button>
        <button class="btn" onclick="resetTimer('${projId}')" title="RÃ©initialiser">â†º</button>
      </div>
    </div>
    ${p ? `<div class="pomo-count">ğŸ… ${p.pomodoroCount||0} pomodoro${(p.pomodoroCount||0)!==1?'s':''} complÃ©tÃ©${(p.pomodoroCount||0)!==1?'s':''}</div>` : ''}
  </div>`;
}

function secsToHMS(s) { s = Math.floor(s); return [Math.floor(s/3600), Math.floor((s%3600)/60), s%60]; }
function pad(n) { return String(n).padStart(2,'0'); }

function setTimerMode(projId, mode) {
  const t = timers[projId]; if (!t) return;
  stopTimer(projId);
  t.mode = mode; t.elapsed = 0;
  if (mode === 'alarm') { const now = new Date(); t.h = now.getHours(); t.m = now.getMinutes()+25; if(t.m>=60){t.h++;t.m-=60;} t.s = 0; }
  else { const def = state.settings.timerDefault; t.h=def.h; t.m=def.m; t.s=def.s; t.totalSecs=def.h*3600+def.m*60+def.s; }
  renderTimerWidget(projId);
}

function setTimerH(projId, v) { const t=timers[projId];if(!t)return;t.h=clamp(+v,0,23);t.totalSecs=t.h*3600+t.m*60+t.s;t.elapsed=0;renderTimerWidget(projId); }
function setTimerM(projId, v) { const t=timers[projId];if(!t)return;t.m=clamp(+v,0,59);t.totalSecs=t.h*3600+t.m*60+t.s;t.elapsed=0;renderTimerWidget(projId); }
function setTimerS(projId, v) { const t=timers[projId];if(!t)return;t.s=clamp(+v,0,59);t.totalSecs=t.h*3600+t.m*60+t.s;t.elapsed=0;renderTimerWidget(projId); }

function toggleTimer(projId) {
  const t = timers[projId]; if (!t) return;
  if (t.running) stopTimer(projId);
  else startTimer(projId);
}

function startTimer(projId) {
  const t = timers[projId]; if (!t || t.running) return;
  t.running = true;
  t.intervalId = setInterval(() => {
    if (!t.running) return;
    if (t.mode === 'stopwatch') {
      t.elapsed++;
    } else if (t.mode === 'countdown') {
      t.elapsed++;
      if (t.elapsed >= t.totalSecs) {
        stopTimer(projId); timerAlarm(projId);
        const p = state.projects.find(x=>x.id===projId);
        if (p) { updateProj(projId, { pomodoroCount: (p.pomodoroCount||0)+1 }); renderHeaderStats(); }
        return;
      }
    } else { // alarm
      const now = new Date(); const alarmSecs = t.h*3600+t.m*60+t.s;
      const nowSecs = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
      if (nowSecs >= alarmSecs) { stopTimer(projId); timerAlarm(projId); return; }
      t.elapsed++;
    }
    renderTimerWidget(projId);
  }, 1000);
  renderTimerWidget(projId);
}

function stopTimer(projId) {
  const t = timers[projId]; if (!t) return;
  clearInterval(t.intervalId); t.running = false; t.intervalId = null;
  renderTimerWidget(projId);
}

function resetTimer(projId) {
  stopTimer(projId);
  const t = timers[projId]; if (!t) return;
  t.elapsed = 0; renderTimerWidget(projId);
}

function timerAlarm(projId) {
  const p = state.projects.find(x=>x.id===projId);
  toast(`â° Timer terminÃ©${p?' pour "'+p.name+'"':''}! ğŸ…`, 'success');
  // Try Web Audio API beep
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [0,0.15,0.3].forEach(t => {
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880; g.gain.setValueAtTime(0.3, ctx.currentTime+t);
      g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+t+0.3);
      o.start(ctx.currentTime+t); o.stop(ctx.currentTime+t+0.3);
    });
  } catch(e) {}
  renderTimerWidget(projId);
}

// â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTask(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  const task = p.tasks.find(t=>t.id===taskId); if (!task) return;
  // Cycle: todo â†’ in_progress â†’ done â†’ todo
  const cycle = { todo:'in_progress', in_progress:'done', done:'todo' };
  task.status = cycle[task.status] || 'todo';
  task.done = task.status === 'done';
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave();
}

function addTask(projId, inputSuffix) {
  const inp = document.getElementById('task-input-' + inputSuffix); if (!inp) return;
  const text = inp.value.trim(); if (!text) return;
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  p.tasks.push(newTask(text));
  p.updatedAt = new Date().toISOString();
  inp.value = '';
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave();
}

function delTask(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  p.tasks = p.tasks.filter(t=>t.id!==taskId);
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); scheduleSave();
}

// â”€â”€ PROJECTS CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addProject(data) {
  pushUndo();
  const p = newProject(data);
  state.projects.unshift(p);
  renderAll(); scheduleSave();
  toast(`âœ¨ "${p.name}" crÃ©Ã© !`);
  return p;
}

function updateProj(id, changes) {
  const p = state.projects.find(x=>x.id===id); if (!p) return;
  Object.assign(p, changes, { updatedAt: new Date().toISOString() });
}

function deleteProject(id) {
  pushUndo();
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===id) state.slots[k]=null; });
  if (timers[id]) { stopTimer(id); delete timers[id]; }
  state.projects = state.projects.filter(p=>p.id!==id);
  renderAll(); scheduleSave(); toast('Projet supprimÃ© ğŸ—‘', 'warning');
}

function archiveProject(id) {
  pushUndo();
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===id) state.slots[k]=null; });
  updateProj(id, { archived: true });
  renderAll(); scheduleSave(); toast('Projet archivÃ© ğŸ“¦');
}

function restoreProject(id) {
  pushUndo();
  updateProj(id, { archived: false });
  renderAll(); scheduleSave(); toast('Projet restaurÃ© ğŸ”„');
}

function duplicateProject(id) {
  pushUndo();
  const src = state.projects.find(p=>p.id===id); if (!src) return;
  const copy = { ...JSON.parse(JSON.stringify(src)), id: uid(), name: src.name + ' (copie)', createdAt: new Date().toISOString(), pinned: false, completed: false, archived: false };
  state.projects.unshift(copy);
  renderAll(); scheduleSave(); toast('Projet dupliquÃ© ğŸ“‹');
}

function completeProject(id) {
  pushUndo();
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===id) state.slots[k]=null; });
  if (timers[id]) { stopTimer(id); delete timers[id]; }
  const idx = state.projects.findIndex(p=>p.id===id); if (idx<0) return;
  const p = state.projects[idx];
  p.completed = true; p.completedAt = new Date().toISOString();
  state.completedProjects.unshift(p);
  state.projects.splice(idx, 1);
  shootConfetti();
  renderAll(); scheduleSave();
  toast('ğŸ† FÃ©licitations ! Projet terminÃ© !', 'success');
}

function restoreCompleted(id) {
  pushUndo();
  const idx = state.completedProjects.findIndex(p=>p.id===id); if (idx<0) return;
  const p = state.completedProjects[idx];
  p.completed = false; p.archived = false; delete p.completedAt;
  state.projects.unshift(p);
  state.completedProjects.splice(idx, 1);
  renderAll(); scheduleSave(); toast('Projet restaurÃ© ğŸ”„');
}

function deleteCompleted(id) {
  pushUndo();
  state.completedProjects = state.completedProjects.filter(p=>p.id!==id);
  renderCompleted(); scheduleSave(); toast('SupprimÃ© ğŸ—‘', 'warning');
}

function confirmClearCompleted() {
  if (!state.completedProjects.length) return;
  if (confirm('Supprimer dÃ©finitivement TOUS les projets terminÃ©s ?')) {
    pushUndo(); state.completedProjects = [];
    renderCompleted(); scheduleSave(); toast('Historique vidÃ© ğŸ—‘', 'warning');
  }
}

// â”€â”€ SLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function assignToSlot(projId, slot) {
  pushUndo();
  // Remove from any current slot
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===projId) state.slots[k]=null; });
  state.slots[slot] = projId;
  const p = state.projects.find(x=>x.id===projId);
  if (p) initTimer(projId, p);
  renderAll(); scheduleSave();
  toast(`AssignÃ© Ã  ${state.settings.slotNames?.[slot]||SLOT_INFO[slot].label} ${SLOT_INFO[slot].emoji}`);
}

function removeFromSlot(slotKey) {
  pushUndo();
  const id = state.slots[slotKey];
  if (id && timers[id]) stopTimer(id);
  state.slots[slotKey] = null;
  renderAll(); scheduleSave();
}

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDragOver(zone) {
  dragOverZone = zone;
  // Update slot visual
  Object.keys(SLOT_INFO).forEach(k => {
    const el = document.getElementById('slot-'+k);
    if (el) el.classList.toggle('drag-over', k===zone);
  });
  const bl = document.getElementById('backlog-list');
  if (bl) bl.style.background = zone==='backlog' ? 'rgba(var(--accent-rgb),0.05)' : '';
}

function clearDragOver() {
  dragOverZone = null;
  Object.keys(SLOT_INFO).forEach(k => {
    const el = document.getElementById('slot-'+k); if (el) el.classList.remove('drag-over');
  });
  const bl = document.getElementById('backlog-list'); if (bl) bl.style.background = '';
}

function handleDrop(event, zone) {
  event.preventDefault(); clearDragOver();
  if (!draggedId) return;
  if (zone === 'backlog') {
    Object.keys(state.slots).forEach(k => { if (state.slots[k]===draggedId) { state.slots[k]=null; } });
    renderAll(); scheduleSave();
  } else {
    assignToSlot(draggedId, zone);
  }
  draggedId = null; dragFrom = null;
}

// â”€â”€ COMPLETED VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCompleted() {
  const grid = document.getElementById('completed-grid');
  const empty = document.getElementById('completed-empty');
  if (!state.completedProjects.length) {
    grid.innerHTML = ''; empty.style.display = 'block'; return;
  }
  empty.style.display = 'none';
  grid.innerHTML = state.completedProjects.map(p => {
    const pct = progress(p);
    return `<div class="comp-card" style="--c:${p.color}" onclick="openCompletedDetail('${p.id}')">
      <div class="comp-icon">${p.icon}</div>
      <div class="comp-name">${esc(p.name)}</div>
      <div class="comp-date">âœ… TerminÃ© le ${fmtDateTime(p.completedAt)}</div>
      <div class="comp-stats">
        <span class="badge" style="background:${p.color}20;color:${p.color}">${pct}% â€¢ ${p.tasks.filter(t=>t.done).length}/${p.tasks.length} tÃ¢ches</span>
        ${p.pomodoroCount ? `<span class="badge" style="background:rgba(249,115,22,0.12);color:#fb923c">ğŸ… ${p.pomodoroCount}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ STATS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats() {
  const slotIds = Object.values(state.slots).filter(Boolean);
  const allP = state.projects;
  const allTasks = allP.reduce((a,p)=>a+p.tasks.length,0);
  const doneTasks = allP.reduce((a,p)=>a+p.tasks.filter(t=>t.done).length,0);
  const pomos = [...allP,...state.completedProjects].reduce((a,p)=>a+(p.pomodoroCount||0),0);
  const hours = allP.reduce((a,p)=>a+(p.loggedHours||0),0);
  const overdueCount = allP.filter(isOverdue).length;

  document.getElementById('stats-grid').innerHTML = [
    { i:'ğŸ“', v:allP.filter(p=>!p.archived&&!p.completed).length, l:'Projets en cours', c:'var(--accent)' },
    { i:'âš¡', v:`${slotIds.length}/3`, l:'Slots actifs', c:'#f97316' },
    { i:'âœ…', v:`${doneTasks}/${allTasks}`, l:'TÃ¢ches', c:'#22c55e' },
    { i:'ğŸ†', v:state.completedProjects.length, l:'TerminÃ©s', c:'#eab308' },
    { i:'ğŸ“¦', v:allP.filter(p=>p.archived).length, l:'ArchivÃ©s', c:'#94a3b8' },
    { i:'ğŸ…', v:pomos, l:'Pomodoros', c:'#f97316' },
    { i:'â±', v:`${hours}h`, l:'Heures log', c:'#0ea5e9' },
    { i:'â°', v:overdueCount, l:'En retard', c:'#f87171' },
  ].map(s=>`<div class="stat-card"><div class="stat-icon">${s.i}</div><div class="stat-val" style="color:${s.c}">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
}

function updateAllProjectsOverview() {
  const slotIds = Object.values(state.slots).filter(Boolean);
  const container = document.getElementById('all-projects-overview');
  if (!container) return;
  const active = state.projects.filter(p=>!p.archived&&!p.completed);
  if (!active.length) { container.innerHTML = '<p style="color:var(--text3);font-size:13px">Aucun projet actif.</p>'; return; }
  container.innerHTML = active.map(p => {
    const pct = progress(p);
    return `<div onclick="openDetailProj('${p.id}')" style="background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;border-left:3px solid ${p.color};transition:all var(--transition)" onmouseover="this.style.background='var(--glass2)'" onmouseout="this.style.background='var(--glass)'">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
        <span>${p.icon}</span>
        <span style="font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.name)}</span>
        ${slotIds.includes(p.id)?`<span style="font-size:9px;color:var(--text3);background:var(--glass2);padding:1px 5px;border-radius:10px">actif</span>`:''}
      </div>
      <div style="height:3px;border-radius:2px;background:rgba(255,255,255,0.06);overflow:hidden"><div style="height:100%;width:${pct}%;background:${p.color};border-radius:2px;box-shadow:0 0 6px ${p.color}60"></div></div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px;text-align:right">${pct}%</div>
    </div>`;
  }).join('');
}

// â”€â”€ MENUS (portal-based, fixed position to fix z-index overlap bug) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createPortalDropdown(anchorEl, itemsHTML) {
  closeDropdown();
  const rect = anchorEl.getBoundingClientRect();
  const dd = document.createElement('div');
  dd.className = 'dropdown dropdown-portal';
  dd.innerHTML = itemsHTML;
  // Position below and right-aligned to button
  document.body.appendChild(dd);
  const ddW = 190;
  let left = rect.right - ddW;
  let top = rect.bottom + 4;
  // Keep within viewport
  if (left < 8) left = 8;
  if (top + 200 > window.innerHeight) top = rect.top - Math.min(200, top + 200 - window.innerHeight) - 4;
  dd.style.left = left + 'px';
  dd.style.top = top + 'px';
  openDropdown = dd;
}

function openCardMenu(event, projId) {
  event.stopPropagation();
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  createPortalDropdown(event.currentTarget, [
    { i:'ğŸ‘', l:'Voir dÃ©tails', fn:`openDetailProj('${projId}')` },
    { i:'âœ', l:'Modifier', fn:`openEditProj('${projId}')` },
    { i:'ğŸ“‹', l:'Dupliquer', fn:`duplicateProject('${projId}')` },
    { i:'ğŸ“Œ', l:p.pinned?'DÃ©sÃ©pingler':'Ã‰pingler', fn:`togglePin('${projId}')` },
    { i:'ğŸ·', l:'Changer catÃ©gorie', fn:`changeCategoryModal('${projId}')` },
    { i:'ğŸ†', l:'Marquer terminÃ©', fn:`completeProject('${projId}')` },
    null, // separator
    { i:'ğŸ“¦', l:p.archived?'Restaurer':'Archiver', fn:p.archived?`restoreProject('${projId}')`:`archiveProject('${projId}')` },
    { i:'ğŸ—‘', l:'Supprimer', fn:`if(confirm('Supprimer ce projet ?'))deleteProject('${projId}')`, danger:true },
  ].map(it => it===null ? '<div class="dropdown-sep"></div>' :
    `<button class="dropdown-item${it.danger?' danger':''}" onclick="${it.fn};closeDropdown()">${it.i} ${it.l}</button>`
  ).join(''));
}

function assignDropdown(event, projId) {
  event.stopPropagation();
  createPortalDropdown(event.currentTarget, Object.entries(SLOT_INFO).map(([k,m]) => {
    const customLabel = state.settings.slotNames?.[k] || m.label;
    const isCurrent = state.slots[k] === projId;
    return `<button class="dropdown-item${isCurrent?' active':''}" onclick="assignToSlot('${projId}','${k}');closeDropdown()" style="${isCurrent?'color:var(--accent)':''}">${m.emoji} ${customLabel}${isCurrent?' âœ“':''}</button>`;
  }).join(''));
}

function closeDropdown() {
  if (openDropdown) { openDropdown.remove(); openDropdown = null; }
}

function togglePin(id) {
  const p = state.projects.find(x=>x.id===id); if (!p) return;
  updateProj(id, { pinned: !p.pinned });
  renderBacklog(); scheduleSave();
}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFilters() {
  const p = document.getElementById('filters-panel');
  p.style.display = p.style.display==='none' ? 'flex' : 'none';
  document.getElementById('btn-filters').style.borderColor = p.style.display!=='none' ? 'var(--accent)' : 'var(--border)';
}

function renderFilterPriority() {
  const row = document.getElementById('filter-priority-row');
  row.innerHTML = [['','Tout'],['critical','ğŸ”´ Critique'],['high','ğŸŸ  Ã‰levÃ©'],['medium','ğŸŸ¡ Moyen'],['low','ğŸŸ¢ Faible']].map(([v,l])=>
    `<button class="filter-chip${filterActive.priority===v?' active':''}" onclick="setFilterPriority('${v}')">${l}</button>`
  ).join('');
}

function setFilterPriority(v) { filterActive.priority = filterActive.priority===v&&v?'':v; renderFilterPriority(); renderBacklog(); }

function updateTagFilters() {
  const allTags = [...new Set(state.projects.flatMap(p=>p.tags))];
  const sec = document.getElementById('filter-tags-section');
  const row = document.getElementById('filter-tags-row');
  sec.style.display = allTags.length ? 'block' : 'none';
  row.innerHTML = allTags.map(t=>`<button class="filter-chip${filterActive.tags.includes(t)?' active':''}" onclick="toggleTagFilter('${t}')">#${t}</button>`).join('');
}

function toggleTagFilter(t) {
  const idx = filterActive.tags.indexOf(t);
  if (idx>=0) filterActive.tags.splice(idx,1); else filterActive.tags.push(t);
  renderBacklog();
}

function toggleArchived() {
  filterActive.archived = !filterActive.archived;
  document.getElementById('btn-archived').style.borderColor = filterActive.archived ? 'var(--accent)' : 'var(--border)';
  renderBacklog();
}

function toggleCompact() {
  state.settings.compact = !state.settings.compact;
  document.getElementById('compact-label').textContent = state.settings.compact ? 'ğŸ“‘ Compact âœ“' : 'ğŸ“‹ Confortable';
  renderBacklog(); scheduleSave();
}

function resetFilters() {
  filterActive = { priority:'', tags:[], archived:false };
  document.getElementById('search-input').value = '';
  document.getElementById('sort-select').value = 'createdAt';
  renderFilterPriority(); renderBacklog();
}

function clearSearch() { document.getElementById('search-input').value=''; renderBacklog(); }

// â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  const s = document.getElementById('sidebar');
  const o = document.getElementById('sidebar-overlay');
  const open = s.classList.toggle('open');
  o.style.display = open ? 'block' : 'none';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').style.display = 'none';
}

function setMobileView(v) {
  mobileView = v;
  const isMobile = window.innerWidth <= 640;

  // Show/hide main views
  document.getElementById('view-board').classList.toggle('view-hidden', v==='completed'||v==='stats');
  document.getElementById('view-completed').classList.toggle('view-hidden', v!=='completed');
  document.getElementById('view-stats').classList.toggle('view-hidden', v!=='stats');

  if (isMobile) {
    // On mobile: toggle sidebar for 'list' view
    if (v==='list') toggleSidebar();
    else closeSidebar();

    // Update nav
    ['list','board','done','stats','settings'].forEach(n => {
      const el = document.getElementById('nav-'+n);
      if (el) el.classList.toggle('active', v===n||(n==='done'&&v==='completed'));
    });
  }
}

function onResize() {
  const isMobile = window.innerWidth <= 640;
  const isTablet = window.innerWidth <= 900;
  document.getElementById('btn-menu-sidebar').style.display = isTablet ? 'flex' : 'none';
  if (!isTablet) {
    closeSidebar();
    document.getElementById('sidebar-overlay').style.display = 'none';
  }
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(html, wide=false) {
  closeModal();
  const bg = document.createElement('div');
  bg.className = 'modal-bg';
  bg.id = 'active-modal';
  bg.innerHTML = `<div class="modal${wide?' modal-wide':''}">${html}</div>`;
  bg.addEventListener('click', e => { if (e.target === bg) closeModal(); });
  document.body.appendChild(bg);
  activeModalBg = bg;
}
// alias for backwards compat with any inline onclick="openModal..."
const openModal = showModal;

function closeModal() {
  const m = document.getElementById('active-modal');
  if (m) m.remove();
  activeModalBg = null;
}

// â”€â”€ NEW / EDIT PROJECT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNew(templateData) {
  const p = newProject(templateData||{});
  showEditModal(p, true);
}

function openEditProj(id) {
  const p = state.projects.find(x=>x.id===id);
  if (!p) return;
  showEditModal(JSON.parse(JSON.stringify(p)), false);
}

function showEditModal(data, isNew_) {
  let d = data;
  function upd(k,v) { d[k]=v; refreshEditPreview(); }

  openModal(`
    <div class="modal-header">
      <div class="modal-title">${isNew_?'âœ¨ Nouveau projet':'âœ Modifier le projet'}</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" data-tab="info" onclick="switchTab(this,'info')">Infos</button>
      <button class="modal-tab" data-tab="tasks" onclick="switchTab(this,'tasks')">TÃ¢ches</button>
      <button class="modal-tab" data-tab="tags" onclick="switchTab(this,'tags')">Tags</button>
      <button class="modal-tab" data-tab="advanced" onclick="switchTab(this,'advanced')">AvancÃ©</button>
    </div>
    <div class="modal-body">
      <!-- INFO TAB -->
      <div class="modal-tab-body active" id="tab-info">
        <!-- Preview -->
        <div id="edit-preview" style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.08)">
          <span id="prev-icon" style="font-size:24px">${d.icon}</span>
          <span id="prev-name" style="font-weight:700;font-size:15px">${esc(d.name)||'<span style="opacity:0.3">AperÃ§u...</span>'}</span>
        </div>
        <!-- Icon row -->
        <div class="form-group">
          <label class="form-label">IcÃ´ne</label>
          <div class="icon-grid" id="icon-grid">
            ${ICONS.map(ic=>`<button class="icon-btn${ic===d.icon?' active':''}" onclick="selectIcon('${ic}')">${ic}</button>`).join('')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Couleur</label>
          <div class="color-swatches" id="color-swatches">
            ${COLORS.map(c=>`<div class="color-swatch${c===d.color?' active':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Nom *</label>
          <input class="input" id="edit-name" value="${esc(d.name)}" placeholder="Ex: DÃ©velopper mon portfolio" oninput="editField('name',this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="input" id="edit-desc" placeholder="Description courte..." oninput="editField('description',this.value)">${esc(d.description)}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">CatÃ©gorie</label>
            <select class="input" id="edit-category" onchange="editField('categoryId',this.value)">
              ${state.categories.map(c=>`<option value="${c.id}"${(d.categoryId||'cat_general')===c.id?' selected':''}>${c.icon} ${c.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">PrioritÃ©</label>
            <select class="input" id="edit-priority" onchange="editField('priority',this.value)">
              ${Object.entries(PRIO).map(([k,v])=>`<option value="${k}"${d.priority===k?' selected':''}>${v.dot} ${v.label}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Date limite</label>
            <input type="date" class="input" id="edit-due" value="${d.dueDate||''}" onchange="editField('dueDate',this.value)" style="color-scheme:dark">
          </div>
        </div>
      </div>

      <!-- TASKS TAB -->
      <div class="modal-tab-body" id="tab-tasks">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input class="input" id="new-task-inp" placeholder="Ajouter une tÃ¢che..." onkeydown="if(event.key==='Enter')addEditTask()">
          <button class="btn btn-primary" onclick="addEditTask()" style="flex-shrink:0">+</button>
        </div>
        <div id="edit-tasks-list"></div>
      </div>

      <!-- TAGS TAB -->
      <div class="modal-tab-body" id="tab-tags">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input class="input" id="new-tag-inp" placeholder="Ajouter un tag..." onkeydown="if(event.key==='Enter')addEditTag()">
          <button class="btn btn-primary" onclick="addEditTag()" style="flex-shrink:0">+</button>
        </div>
        <div id="edit-tags-list" class="tags-wrap"></div>
        <div id="existing-tags-section" style="margin-top:14px"></div>
      </div>

      <!-- ADVANCED TAB -->
      <div class="modal-tab-body" id="tab-advanced">
        <div class="form-row">
          <div class="form-group"><label class="form-label">Heures estimÃ©es</label><input type="number" min="0" class="input" id="edit-esthours" value="${d.estimatedHours||0}" oninput="editField('estimatedHours',+this.value)"></div>
          <div class="form-group"><label class="form-label">Heures travaillÃ©es</label><input type="number" min="0" class="input" id="edit-loghours" value="${d.loggedHours||0}" oninput="editField('loggedHours',+this.value)"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="input" id="edit-notes" style="min-height:120px" placeholder="Notes, idÃ©es, rÃ©flexions..." oninput="editField('notes',this.value)">${esc(d.notes||'')}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Lien</label>
          <div style="display:flex;gap:8px">
            <input class="input" id="new-link-inp" placeholder="https://...">
            <button class="btn" onclick="addEditLink()" style="flex-shrink:0">+</button>
          </div>
          <div id="edit-links-list" style="margin-top:6px"></div>
        </div>
        <label class="toggle-label" style="margin-top:6px">
          <div class="toggle${d.pinned?' on':''}" id="pin-toggle" onclick="this.classList.toggle('on');editField('pinned',this.classList.contains('on'))"></div>
          Ã‰pingler ce projet
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" id="save-proj-btn" onclick="saveEditModal(${isNew_})" disabled>
        ${isNew_?'âœ¨ CrÃ©er':'ğŸ’¾ Enregistrer'}
      </button>
    </div>
  `, true);

  // Set preview bg
  refreshEditPreview();
  renderEditTasks(); renderEditTags(); renderEditLinks();

  function refreshEditPreview() {
    const prev = document.getElementById('edit-preview');
    if (prev) prev.style.background = d.color + '18';
    const pn = document.getElementById('prev-name');
    if (pn) pn.innerHTML = d.name ? esc(d.name) : '<span style="opacity:0.3">AperÃ§u...</span>';
    const pi = document.getElementById('prev-icon');
    if (pi) pi.textContent = d.icon;
    const sb = document.getElementById('save-proj-btn');
    if (sb) { sb.disabled = !d.name.trim(); sb.style.opacity = d.name.trim()? '1' : '0.4'; }
  }

  function selectIcon(icon) {
    d.icon = icon;
    document.querySelectorAll('#icon-grid .icon-btn').forEach(b=>b.classList.toggle('active', b.textContent===icon));
    refreshEditPreview();
  }
  function selectColor(color) {
    d.color = color;
    document.querySelectorAll('.color-swatch').forEach(s=>s.classList.toggle('active', s.style.background===color||s.dataset.c===color));
    refreshEditPreview();
  }
  function editField(k,v) { d[k]=v; refreshEditPreview(); }
  function renderEditTasks() {
    const el = document.getElementById('edit-tasks-list'); if (!el) return;
    if (!d.tasks.length) { el.innerHTML = '<p style="color:var(--text3);font-size:12px;text-align:center;padding:16px">Aucune tÃ¢che</p>'; return; }
    el.innerHTML = d.tasks.map((t,i)=>{
      const st = TASK_STATUS[t.status||'todo'];
      const prioColor = TASK_PRIO_COLOR[t.priority||'medium'];
      return `<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--glass);border-radius:8px;margin-bottom:5px">
        <button class="task-status-btn ${t.status||'todo'}" onclick="cycleEditTaskStatus(${i})" style="border-color:${st.color};${(t.status==='in_progress'||t.status==='done')?'background:'+st.color+'22':''}" title="${st.label}"><span style="color:${st.color}">${st.icon}</span></button>
        <span style="width:8px;height:8px;border-radius:50%;background:${prioColor};flex-shrink:0"></span>
        <input style="flex:1;background:none;border:none;color:var(--text);font-family:var(--font);font-size:12px;outline:none;text-decoration:${t.done?'line-through':''};opacity:${t.done?0.4:1}" value="${esc(t.text)}" oninput="editTaskText(${i},this.value)">
        ${(t.subtasks||[]).length?`<span style="font-size:9px;color:var(--text3)">${(t.subtasks||[]).filter(s=>s.done).length}/${(t.subtasks||[]).length}â†³</span>`:''}
        <button onclick="removeEditTask(${i})" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px">Ã—</button>
      </div>`;
    }).join('');
  }
  function cycleEditTaskStatus(i) {
    const t = d.tasks[i]; if(!t) return;
    const cycle = { todo:'in_progress', in_progress:'done', done:'todo' };
    t.status = cycle[t.status||'todo'];
    t.done = t.status === 'done';
    renderEditTasks();
  }
  function addEditTask() {
    const inp=document.getElementById('new-task-inp'); if(!inp||!inp.value.trim())return;
    d.tasks.push(newTask(inp.value.trim())); inp.value=''; renderEditTasks();
  }
  function removeEditTask(i) { d.tasks.splice(i,1); renderEditTasks(); }
  function editTaskDone(i,v) { d.tasks[i].done=v; }
  function editTaskText(i,v) { d.tasks[i].text=v; }
  function renderEditTags() {
    const el = document.getElementById('edit-tags-list'); if(!el)return;
    el.innerHTML = d.tags.map(t=>`<span class="tag-badge" style="background:${tagColor(t)}22;color:${tagColor(t)};display:inline-flex;align-items:center;gap:4px;padding:3px 8px;cursor:pointer" onclick="removeEditTag('${t}'">#${esc(t)} Ã—</span>`).join('');
    const existing = [...new Set(state.projects.flatMap(p=>p.tags))].filter(t=>!d.tags.includes(t));
    const sec = document.getElementById('existing-tags-section');
    if (sec && existing.length) sec.innerHTML = '<label class="form-label">Tags existants</label><div class="tags-wrap">' + existing.map(t=>`<button onclick="addExistingTag('${t}')" style="padding:3px 9px;border-radius:20px;border:1px dashed var(--border2);background:transparent;color:var(--text3);cursor:pointer;font-size:11px">+#${esc(t)}</button>`).join('') + '</div>';
  }
  function addEditTag() {
    const inp=document.getElementById('new-tag-inp'); if(!inp||!inp.value.trim())return;
    const t=inp.value.trim().toLowerCase().replace(/\s+/g,'-');
    if(!d.tags.includes(t))d.tags.push(t); inp.value=''; renderEditTags();
  }
  function addExistingTag(t) { if(!d.tags.includes(t))d.tags.push(t); renderEditTags(); }
  function removeEditTag(t) { d.tags=d.tags.filter(x=>x!==t); renderEditTags(); }
  function renderEditLinks() {
    const el = document.getElementById('edit-links-list'); if(!el)return;
    el.innerHTML = (d.links||[]).map((l,i)=>`<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
      <a href="${esc(l)}" target="_blank" style="flex:1;font-size:12px;color:var(--accent);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ğŸ”— ${esc(l)}</a>
      <button onclick="removeEditLink(${i})" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px">Ã—</button>
    </div>`).join('');
  }
  function addEditLink() {
    const inp=document.getElementById('new-link-inp'); if(!inp||!inp.value.trim())return;
    if(!d.links)d.links=[];d.links.push(inp.value.trim());inp.value='';renderEditLinks();
  }
  function removeEditLink(i) { d.links.splice(i,1); renderEditLinks(); }

  function saveEditModal(isNew_) {
    if (!d.name.trim()) return;
    if (isNew_) addProject(d);
    else { pushUndo(); Object.assign(state.projects.find(p=>p.id===d.id)||{}, d, { updatedAt:new Date().toISOString() }); renderAll(); scheduleSave(); toast(`"${d.name}" mis Ã  jour âœ`); }
    closeModal();
  }

  // Expose to global scope for inline handlers
  window.selectIcon = selectIcon;
  window.selectColor = selectColor;
  window.editField = editField;
  window.addEditTask = addEditTask;
  window.cycleEditTaskStatus = cycleEditTaskStatus;
  window.removeEditTask = removeEditTask;
  window.editTaskDone = editTaskDone;
  window.editTaskText = editTaskText;
  window.addEditTag = addEditTag;
  window.addExistingTag = addExistingTag;
  window.removeEditTag = removeEditTag;
  window.addEditLink = addEditLink;
  window.removeEditLink = removeEditLink;
  window.saveEditModal = saveEditModal;
}

function switchTab(btn, tab) {
  document.querySelectorAll('.modal-tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.modal-tab-body').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const el = document.getElementById('tab-'+tab);
  if (el) el.classList.add('active');
}

// â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetailProj(id) {
  const p = state.projects.find(x=>x.id===id) || state.completedProjects.find(x=>x.id===id);
  if (!p) return;
  const pct = progress(p);
  openModal(`
    <div class="detail-banner" style="background:linear-gradient(135deg,${p.color}25,${p.color}08)">
      <div class="detail-banner-inner">
        <div class="detail-icon" style="background:${p.color}25">${p.icon}</div>
        <div style="flex:1;min-width:0">
          <h2 style="font-family:var(--font-display);font-size:18px;font-weight:800;margin-bottom:4px">${esc(p.name)}</h2>
          ${p.description?`<p style="font-size:12px;color:var(--text2);margin-bottom:8px">${esc(p.description)}</p>`:''}
          <div style="display:flex;gap:5px;flex-wrap:wrap">
            <span class="badge ${PRIO[p.priority].bgClass}">${PRIO[p.priority].dot} ${PRIO[p.priority].label}</span>
            ${p.dueDate?`<span class="badge badge-due-${daysUntil(p.dueDate)<0?'late':daysUntil(p.dueDate)<=3?'urgent':daysUntil(p.dueDate)<=7?'soon':'ok'}">ğŸ“… ${fmtDate(p.dueDate)}</span>`:''}
            ${p.estimatedHours?`<span class="badge" style="background:rgba(255,255,255,0.06);color:var(--text3)">â± ${p.estimatedHours}h</span>`:''}
            ${p.pomodoroCount?`<span class="badge" style="background:rgba(249,115,22,0.12);color:#fb923c">ğŸ… ${p.pomodoroCount}</span>`:''}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
          ${renderProgRing(pct,52,4,p.color)}
          <span style="font-size:13px;font-weight:700;color:${p.color}">${pct}%</span>
        </div>
      </div>
      <!-- Progress bar -->
      <div style="margin-top:14px;height:7px;border-radius:4px;background:rgba(255,255,255,0.08);overflow:hidden">
        <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,${p.color},${p.color}cc);box-shadow:0 0 12px ${p.color}60;border-radius:4px"></div>
      </div>
    </div>
    <div class="modal-body" style="padding:16px 20px">
      ${p.tags.length?`<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px">${p.tags.map(t=>`<span class="tag-badge" style="background:${tagColor(t)}22;color:${tagColor(t)}">#${esc(t)}</span>`).join('')}</div>`:''}
      <!-- Tasks -->
      <div style="margin-bottom:16px">
        <div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.08em;margin-bottom:8px">TÃ‚CHES (${p.tasks.filter(t=>t.done).length}/${p.tasks.length})</div>
        <div style="max-height:220px;overflow-y:auto">
          ${p.tasks.map(t=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)">
            <button class="task-check${t.done?' done':''}" onclick="toggleTask('${p.id}','${t.id}');openDetailProj('${p.id}')"></button>
            <span style="flex:1;font-size:13px;color:${t.done?'var(--text3)':'var(--text2)'};text-decoration:${t.done?'line-through':'none'}">${esc(t.text)}</span>
          </div>`).join('')}
        </div>
        ${!p.completed?`<div style="display:flex;gap:8px;margin-top:8px">
          <input class="input" id="detail-task-inp" placeholder="+ Nouvelle tÃ¢che..." onkeydown="if(event.key==='Enter'&&this.value.trim()){addTask('${p.id}','detail-task-inp');openDetailProj('${p.id}')}" style="font-size:12px">
          <button class="btn" onclick="addTask('${p.id}','detail-task-inp');openDetailProj('${p.id}')">+</button>
        </div>`:''}
      </div>
      ${p.notes?`<div style="margin-bottom:16px"><div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.08em;margin-bottom:6px">NOTES</div><div style="background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:12px;font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap">${esc(p.notes)}</div></div>`:''}
      ${(p.links||[]).length?`<div style="margin-bottom:14px"><div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.08em;margin-bottom:6px">LIENS</div>${p.links.map(l=>`<a href="${esc(l)}" target="_blank" style="display:block;padding:7px 10px;border-radius:8px;background:var(--glass);color:var(--accent);font-size:12px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ğŸ”— ${esc(l)}</a>`).join('')}</div>`:''}
      <div style="background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--text3)">
        CrÃ©Ã© le ${fmtDateTime(p.createdAt)} â€¢ ModifiÃ© le ${fmtDateTime(p.updatedAt)}
        ${p.completedAt?` â€¢ TerminÃ© le ${fmtDateTime(p.completedAt)}`:''}
      </div>
    </div>
    <div class="modal-footer">
      ${!p.completed?`<button class="btn" onclick="closeModal();openEditProj('${p.id}')">âœ Modifier</button>`:''}
      ${p.completed?`<button class="btn btn-danger" onclick="deleteCompleted('${p.id}');closeModal()">ğŸ—‘ Supprimer</button><button class="btn" onclick="restoreCompleted('${p.id}');closeModal()">ğŸ”„ Restaurer</button>`:''}
      <button class="btn" onclick="closeModal()">Fermer</button>
    </div>
  `, true);
}

function openCompletedDetail(id) { openDetailProj(id); }

// â”€â”€ NOTES QUICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNotesQuick(projId) {
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  openModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ“ Notes â€” ${esc(p.name)}</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <textarea class="input" id="quick-notes" style="min-height:180px;resize:vertical">${esc(p.notes||'')}</textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveNotes('${projId}')">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}

function saveNotes(projId) {
  const v = document.getElementById('quick-notes').value;
  updateProj(projId, { notes: v }); renderAll(); scheduleSave();
  closeModal(); toast('Notes sauvegardÃ©es ğŸ“');
}

// â”€â”€ TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTemplates() {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ“„ Templates</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        ${TEMPLATES.map((t,i)=>`<button onclick="useTemplate(${i})" style="padding:14px;border-radius:12px;border:2px solid var(--border);background:var(--glass);cursor:pointer;text-align:left;transition:all var(--transition)" onmouseover="this.style.borderColor='${t.color}';this.style.background='${t.color}12'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--glass)'">
          <div style="font-size:24px;margin-bottom:6px">${t.icon}</div>
          <div style="font-weight:700;font-size:13px;margin-bottom:3px">${t.name}</div>
          <div style="font-size:10px;color:var(--text3)">${t.tasks.length} tÃ¢ches prÃ©dÃ©finies</div>
        </button>`).join('')}
      </div>
    </div>
  `, true);
}

function useTemplate(i) {
  const t = TEMPLATES[i];
  const data = { name:t.name, icon:t.icon, color:t.color, tags:t.tags, tasks:t.tasks.map(tx=>({id:uid(),text:tx,done:false})) };
  closeModal(); showEditModal(newProject(data), true);
}

// â”€â”€ SLOT NAMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSlotNamesEditor() {
  const n = state.settings.slotNames || {};
  openModal(`
    <div class="modal-header">
      <div class="modal-title">âœ Nommer les slots</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      ${Object.entries(SLOT_INFO).map(([k,m])=>`<div class="form-group">
        <label class="form-label">${m.emoji} Slot ${m.label}</label>
        <input class="input" id="slotname-${k}" value="${esc(n[k]||m.label)}" placeholder="${m.label}">
      </div>`).join('')}
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveSlotNames()">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}

function saveSlotNames() {
  if (!state.settings.slotNames) state.settings.slotNames = {};
  Object.keys(SLOT_INFO).forEach(k => {
    const v = document.getElementById('slotname-'+k); if (v) state.settings.slotNames[k] = v.value.trim() || SLOT_INFO[k].label;
  });
  renderSlots(); scheduleSave(); closeModal(); toast('Noms des slots mis Ã  jour âœ');
}

// â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">âš™ ParamÃ¨tres</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- Sync section -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ”„ Synchronisation GitHub</div>
        <div class="sync-status" style="margin-bottom:12px">
          <div class="sync-dot ${syncStatus}" id="modal-sync-dot"></div>
          <span id="modal-sync-label" style="font-size:12px">${{idle:'Non configurÃ©',syncing:'Synchronisation...',synced:'SynchronisÃ© âœ…',error:'Erreur de synchronisation âŒ'}[syncStatus]||syncStatus}</span>
        </div>
        <div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:10px;padding:12px;font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:12px">
          ğŸ“‹ <strong>Comment Ã§a marche :</strong><br>
          1. CrÃ©ez un repo GitHub avec les fichiers <code>index.html</code> et <code>database.json</code><br>
          2. Activez <strong>GitHub Pages</strong> sur la branche <code>main</code><br>
          3. CrÃ©ez un <strong>token personnel</strong> (Settings â†’ Developer settings â†’ Tokens â†’ avec scope <code>repo</code>)<br>
          4. Remplissez les champs ci-dessous â†’ vos donnÃ©es se synchronisent entre tous vos appareils !
        </div>
        <div class="form-group"><label class="form-label">GitHub Token (PAT)</label><input class="input" id="gh-token" type="password" value="${github.token}" placeholder="ghp_..."></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Votre username</label><input class="input" id="gh-owner" value="${github.owner}" placeholder="mon-pseudo"></div>
          <div class="form-group"><label class="form-label">Nom du repo</label><input class="input" id="gh-repo" value="${github.repo}" placeholder="projectflow"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="saveGitHubConfig()">ğŸ’¾ Enregistrer & synchroniser</button>
          <button class="btn" onclick="testSync()">ğŸ”„ Tester</button>
        </div>
      </div>
      <!-- Theme section -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ¨ Couleur d'accent</div>
        <div class="color-swatches" id="settings-colors">
          ${COLORS.map(c=>`<div class="color-swatch${state.settings.accent===c?' active':''}" style="background:${c}" onclick="setAccent('${c}')"></div>`).join('')}
        </div>
      </div>
      <!-- Timer defaults -->
      <div class="settings-section">
        <div class="settings-section-title">â± Timer par dÃ©faut</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Mode</label>
            <select class="input" id="def-timer-mode">
              <option value="countdown"${state.settings.timerDefault?.mode==='countdown'?' selected':''}>â± Compte Ã  rebours</option>
              <option value="stopwatch"${state.settings.timerDefault?.mode==='stopwatch'?' selected':''}>â² ChronomÃ¨tre</option>
              <option value="alarm"${state.settings.timerDefault?.mode==='alarm'?' selected':''}>â° Alarme</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">DurÃ©e (min)</label>
            <input type="number" class="input" id="def-timer-min" value="${state.settings.timerDefault?.m||25}" min="0" max="120">
          </div>
        </div>
      </div>
      <!-- Export/Import -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ“ DonnÃ©es</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="exportJSON()">ğŸ“¥ Exporter JSON</button>
          <label class="btn" style="cursor:pointer">ğŸ“¤ Importer JSON<input type="file" accept=".json" style="display:none" onchange="importJSON(event)"></label>
          <button class="btn btn-danger" onclick="if(confirm('Effacer TOUTES les donnÃ©es ?')){localStorage.removeItem('pf_local_v2');localStorage.removeItem('pf_github');location.reload()}" style="margin-left:auto">ğŸ—‘ RÃ©initialiser</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Fermer</button>
      <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Sauvegarder</button>
    </div>
  `, true);
}

function saveGitHubConfig() {
  github.token = document.getElementById('gh-token').value.trim();
  github.owner = document.getElementById('gh-owner').value.trim();
  github.repo = document.getElementById('gh-repo').value.trim();
  github.sha = null;
  localStorage.setItem(LS_GITHUB_KEY, JSON.stringify({ token:github.token, owner:github.owner, repo:github.repo }));
  toast('Config GitHub enregistrÃ©e. Synchronisation en cours...', 'info');
  saveData();
}

async function testSync() {
  if (!github.token || !github.owner || !github.repo) { toast('Remplissez les champs GitHub d\'abord !', 'error'); return; }
  toast('Test de connexion GitHub...', 'info');
  const ok = await syncFromGitHub();
  if (ok) { renderAll(); toast('âœ… Connexion GitHub OK ! DonnÃ©es chargÃ©es.', 'success'); }
  else toast('âŒ Ã‰chec de la connexion GitHub. VÃ©rifiez vos identifiants.', 'error');
}

function setAccent(color) {
  state.settings.accent = color;
  applyAccent(color);
  document.querySelectorAll('#settings-colors .color-swatch').forEach(s => s.classList.toggle('active', s.style.background===color));
  scheduleSave();
}

function applyAccent(color) {
  document.documentElement.style.setProperty('--accent', color);
  const rgb = hexToRgb(color);
  if (rgb) document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
  // Compute accent2 (slightly shifted)
  document.documentElement.style.setProperty('--accent2', shiftHue(color, -20));
}

function saveSettings() {
  const m = document.getElementById('def-timer-mode');
  const min = document.getElementById('def-timer-min');
  if (m) state.settings.timerDefault = { mode:m.value, h:0, m:+min.value||25, s:0 };
  scheduleSave(); closeModal(); toast('ParamÃ¨tres sauvegardÃ©s âš™');
}

function showExportMenu(event) {
  closeDropdown();
  const btn = event.currentTarget;
  const dd = document.createElement('div');
  dd.className = 'dropdown';
  dd.innerHTML = `
    <button class="dropdown-item" onclick="exportJSON();closeDropdown()">ğŸ“„ Exporter JSON</button>
    <button class="dropdown-item" onclick="exportCSV();closeDropdown()">ğŸ“Š Exporter CSV</button>
    <div class="dropdown-sep"></div>
    <label class="dropdown-item" style="cursor:pointer">ğŸ“¤ Importer JSON<input type="file" accept=".json" style="display:none" onchange="importJSON(event);closeDropdown()"></label>
  `;
  btn.style.position = 'relative';
  btn.appendChild(dd);
  openDropdown = dd;
}

function exportJSON() {
  const data = dataSnapshot();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download = `projectflow_${new Date().toISOString().split('T')[0]}.json`;
  a.click(); URL.revokeObjectURL(url); toast('Export JSON ğŸ“¥');
}

function exportCSV() {
  const rows = [['Nom','Description','PrioritÃ©','Statut','Progression','TÃ¢ches totales','TÃ¢ches faites','Date limite','Tags','CrÃ©Ã© le']];
  state.projects.forEach(p => rows.push([p.name,p.description,p.priority,p.archived?'ArchivÃ©':'Actif',progress(p)+'%',p.tasks.length,p.tasks.filter(t=>t.done).length,p.dueDate||'',p.tags.join(';'),fmtDate(p.createdAt)]));
  state.completedProjects.forEach(p => rows.push([p.name,p.description,p.priority,'TerminÃ©','100%',p.tasks.length,p.tasks.filter(t=>t.done).length,p.dueDate||'',p.tags.join(';'),fmtDate(p.createdAt)]));
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download=`projectflow_${new Date().toISOString().split('T')[0]}.csv`;
  a.click(); URL.revokeObjectURL(url); toast('Export CSV ğŸ“Š');
}

function importJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      pushUndo(); applyData(data);
      renderAll(); scheduleSave();
      toast(`âœ… Import rÃ©ussi ! ${(data.projects||[]).length} projets chargÃ©s.`);
    } catch(e) { toast('âŒ Fichier JSON invalide.', 'error'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shootConfetti() {
  const colors = ['#7c3aed','#ec4899','#f97316','#22c55e','#eab308','#0ea5e9'];
  for (let i=0; i<60; i++) {
    const c = document.createElement('div');
    c.className = 'confetti-piece';
    c.style.cssText = `left:${Math.random()*100}vw;top:0;background:${colors[Math.floor(Math.random()*colors.length)]};animation-duration:${0.8+Math.random()*1.5}s;animation-delay:${Math.random()*0.4}s;transform:rotate(${Math.random()*360}deg);width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'2px'}`;
    document.body.appendChild(c);
    setTimeout(()=>c.remove(), 2500);
  }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type='success') {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  const icons = { success:'âœ…', error:'âŒ', warning:'âš ï¸', info:'â„¹ï¸' };
  const colors = { success:'#22c55e', error:'#ef4444', warning:'#f97316', info:'#6366f1' };
  t.innerHTML = `<div class="toast-border-l" style="background:${colors[type]||colors.success}"></div><span class="toast-icon">${icons[type]||icons.success}</span><span>${msg}</span>`;
  container.appendChild(t);
  setTimeout(()=>{ t.classList.add('removing'); setTimeout(()=>t.remove(),300); }, 3000);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) { if (!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function tagColor(tag) {
  const hue = Array.from(tag).reduce((h,c)=>h+c.charCodeAt(0),0) % 360;
  return `hsl(${hue},60%,62%)`;
}

function hexToRgb(hex) {
  const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return r ? { r:parseInt(r[1],16), g:parseInt(r[2],16), b:parseInt(r[3],16) } : null;
}

function shiftHue(hex, amount) {
  const rgb = hexToRgb(hex); if (!rgb) return hex;
  const r=rgb.r/255,g=rgb.g/255,b=rgb.b/255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min;
  let h=0,s=max===0?0:d/max,v=max;
  if (d!==0) { switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;} }
  h=(h*360+amount+360)%360/360;
  const i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t2=v*(1-(1-f)*s);
  let r2,g2,b2;
  switch(i%6){case 0:r2=v;g2=t2;b2=p;break;case 1:r2=q;g2=v;b2=p;break;case 2:r2=p;g2=v;b2=t2;break;case 3:r2=p;g2=q;b2=v;break;case 4:r2=t2;g2=p;b2=v;break;default:r2=v;g2=p;b2=q;}
  const toHex=x=>Math.round(x*255).toString(16).padStart(2,'0');
  return '#'+toHex(r2)+toHex(g2)+toHex(b2);
}

function onKeyDown(e) {
  if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') {
    if (e.key==='Escape') e.target.blur();
    return;
  }
  if ((e.ctrlKey||e.metaKey) && e.key==='z') { e.preventDefault(); doUndo(); }
  if ((e.ctrlKey||e.metaKey) && e.key==='n') { e.preventDefault(); openNew(); }
  if (e.key==='Escape') { closeModal(); closeDropdown(); }
}

// â”€â”€ QUICK STATS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuickStats() {
  const bar = document.getElementById('quick-stats-bar');
  if (!bar) return;
  const slotProjects = Object.values(state.slots).filter(Boolean).map(id => state.projects.find(p=>p.id===id)).filter(Boolean);
  const totalTasks = slotProjects.reduce((a,p)=>a+p.tasks.length,0);
  const doneTasks_ = slotProjects.reduce((a,p)=>a+p.tasks.filter(t=>t.done).length,0);
  const avgProg = slotProjects.length ? Math.round(slotProjects.reduce((a,p)=>a+progress(p),0)/slotProjects.length) : 0;
  if (!slotProjects.length) { bar.innerHTML = ''; return; }
  bar.innerHTML = [
    { i:'âš¡', v:`${slotProjects.length}/3`, l:'Actifs', c:'var(--accent)' },
    { i:'âœ…', v:`${doneTasks_}/${totalTasks}`, l:'TÃ¢ches actives', c:'#22c55e' },
    { i:'ğŸ“ˆ', v:`${avgProg}%`, l:'Progression moy.', c:'#f97316' },
  ].map(s=>`<div style="background:var(--glass);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;gap:10px">
    <span style="font-size:22px">${s.i}</span>
    <div><div style="font-family:var(--font-display);font-size:20px;font-weight:800;color:${s.c}">${s.v}</div><div style="font-size:10px;color:var(--text3)">${s.l}</div></div>
  </div>`).join('');
}

// â”€â”€ CATEGORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCategoryManager() {
  showModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ· GÃ©rer les catÃ©gories</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="cat-manager-body"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="addCategoryPrompt()">+ Nouvelle catÃ©gorie</button>
      <button class="btn" onclick="closeModal()">Fermer</button>
    </div>
  `);
  renderCatManagerBody();
}

function renderCatManagerBody() {
  const el = document.getElementById('cat-manager-body'); if(!el) return;
  el.innerHTML = state.categories.map(c => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--glass);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
      <div style="width:34px;height:34px;border-radius:9px;background:${c.color}25;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">${c.icon}</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px">${esc(c.name)}</div>
        <div style="font-size:10px;color:var(--text3)">${state.projects.filter(p=>p.categoryId===c.id).length} projets</div>
      </div>
      <div style="display:flex;gap:4px">
        <button class="btn btn-icon" onclick="editCategoryModal('${c.id}')" style="font-size:12px">âœ</button>
        <button class="btn btn-icon btn-danger" onclick="deleteCategory('${c.id}')" style="font-size:12px">ğŸ—‘</button>
      </div>
    </div>`).join('') || '<p style="color:var(--text3);text-align:center;padding:20px">Aucune catÃ©gorie</p>';
}

function addCategoryPrompt() { editCategoryModal(null); }

function editCategoryModal(catId) {
  const cat = catId ? state.categories.find(c=>c.id===catId) : null;
  const catIcons = ['ğŸ“','ğŸ’»','ğŸ¨','ğŸ“š','ğŸ ','ğŸ’¼','ğŸ”¬','ğŸµ','ğŸŒ','âš½','ğŸ¯','ğŸš€','ğŸŒ±','â¤ï¸','ğŸ‹ï¸','ğŸ­'];
  showModal(`
    <div class="modal-header">
      <div class="modal-title">${cat?'âœ Modifier':'+ Nouvelle'} catÃ©gorie</div>
      <button class="btn btn-icon" onclick="${cat?'openCategoryManager()':'closeModal()'}">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Nom</label>
        <input class="input" id="cat-name-inp" value="${esc(cat?.name||'')}" placeholder="Ex: Ã‰lectronique, LittÃ©raire...">
      </div>
      <div class="form-group"><label class="form-label">IcÃ´ne</label>
        <div style="display:flex;flex-wrap:wrap;gap:5px" id="cat-icon-grid">
          ${catIcons.map(ic=>`<button class="icon-btn${(cat?.icon||catIcons[0])===ic?' active':''}" onclick="document.querySelectorAll('#cat-icon-grid .icon-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('cat-icon-val').value='${ic}'">${ic}</button>`).join('')}
        </div>
        <input type="hidden" id="cat-icon-val" value="${cat?.icon||catIcons[0]}">
      </div>
      <div class="form-group"><label class="form-label">Couleur</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${COLORS.map(c=>`<div class="color-swatch${(cat?.color||COLORS[0])===c?' active':''}" style="background:${c}" onclick="document.querySelectorAll('.cat-color-swatch').forEach(s=>s.classList.remove('active'));this.classList.add('active');document.getElementById('cat-color-val').value='${c}'" class="cat-color-swatch color-swatch"></div>`).join('')}
        </div>
        <input type="hidden" id="cat-color-val" value="${cat?.color||COLORS[0]}">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="${cat?'openCategoryManager()':'closeModal()'}">Annuler</button>
      <button class="btn btn-primary" onclick="saveCategory('${catId||''}')">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}
window.saveCategory = function(catId) {
  const name = document.getElementById('cat-name-inp')?.value.trim();
  const icon = document.getElementById('cat-icon-val')?.value || 'ğŸ“';
  const color = document.getElementById('cat-color-val')?.value || COLORS[0];
  if (!name) return;
  if (catId) {
    const c = state.categories.find(x=>x.id===catId);
    if (c) Object.assign(c, { name, icon, color });
    toast('CatÃ©gorie modifiÃ©e âœ');
  } else {
    state.categories.push({ id: 'cat_'+uid(), name, icon, color });
    toast(`CatÃ©gorie "${name}" crÃ©Ã©e ğŸ·`);
  }
  renderCategoryFilters(); renderBacklog(); scheduleSave(); closeModal();
};
function deleteCategory(catId) {
  if (!confirm('Supprimer cette catÃ©gorie ? Les projets seront mis dans "GÃ©nÃ©ral"')) return;
  state.categories = state.categories.filter(c=>c.id!==catId);
  state.projects.forEach(p=>{ if(p.categoryId===catId) p.categoryId='cat_general'; });
  renderCategoryFilters(); renderBacklog(); scheduleSave(); openCategoryManager();
}
function changeCategoryModal(projId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  showModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ· Changer la catÃ©gorie</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;flex-direction:column;gap:6px">
        ${state.categories.map(c=>`<button onclick="assignCategory('${projId}','${c.id}')" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${p.categoryId===c.id?c.color+'20':'var(--glass)'};border:1px solid ${p.categoryId===c.id?c.color:'var(--border)'};border-radius:10px;cursor:pointer;text-align:left;transition:all 0.15s">
          <span style="font-size:20px">${c.icon}</span>
          <span style="font-weight:600;color:${p.categoryId===c.id?c.color:'var(--text)'}">${esc(c.name)}</span>
          ${p.categoryId===c.id?'<span style="margin-left:auto;color:var(--accent)">âœ“</span>':''}
        </button>`).join('')}
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal()">Fermer</button></div>
  `);
}
window.assignCategory = function(projId, catId) {
  updateProj(projId, { categoryId: catId });
  renderBacklog(); scheduleSave(); closeModal();
  const cat = getCat(catId);
  toast(`CatÃ©gorie â†’ ${cat?.icon} ${cat?.name}`);
};

// â”€â”€ ENHANCED TASK RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TASK_STATUS = {
  todo:        { icon:'â—‹', label:'Ã€ faire',   color:'var(--text3)' },
  in_progress: { icon:'â—', label:'En cours',  color:'#f97316' },
  done:        { icon:'â—', label:'TerminÃ©',   color:'#22c55e' }
};
const TASK_PRIO_COLOR = { high:'#f87171', medium:'#fb923c', low:'#4ade80', critical:'#c084fc' };

function renderEnhancedTask(t, projId, idx) {
  const st = TASK_STATUS[t.status||'todo'];
  const prioColor = TASK_PRIO_COLOR[t.priority||'medium'];
  const subDone = (t.subtasks||[]).filter(s=>s.done).length;
  const subTotal = (t.subtasks||[]).length;
  return `<div class="task-item" id="taskitem-${t.id}" data-task-id="${t.id}" data-proj-id="${projId}">
    <div class="task-item-header">
      <span class="task-drag-handle" title="DÃ©placer">â ¿</span>
      <span class="task-rank" style="color:var(--text3)">${idx+1}</span>
      <button class="task-status-btn ${t.status||'todo'}" onclick="cycleTaskStatus('${projId}','${t.id}')" title="${st.label}" style="border-color:${st.color};${(t.status==='in_progress'||t.status==='done')?'background:'+st.color+'22':''}">
        <span style="color:${st.color}">${st.icon}</span>
      </button>
      <span class="task-priority-dot" style="background:${prioColor}" title="PrioritÃ©: ${t.priority||'medium'}"></span>
      <span class="task-main-text ${t.status==='done'?'done':''}" onclick="openTaskDetail('${projId}','${t.id}')">${esc(t.text)}</span>
      ${subTotal?`<span style="font-size:9px;color:var(--text3);flex-shrink:0">${subDone}/${subTotal}</span>`:''}
      <div class="task-actions-row">
        <button onclick="openTaskDetail('${projId}','${t.id}')" title="DÃ©tails">ğŸ“‹</button>
        <button onclick="cycleTaskPriority('${projId}','${t.id}')" title="PrioritÃ©">ğŸ¯</button>
        <button onclick="deleteTaskFromProj('${projId}','${t.id}')" title="Supprimer" style="color:#f87171">Ã—</button>
      </div>
      ${subTotal?`<button class="task-expand-btn" id="texpand-${t.id}" onclick="toggleTaskDetail('${t.id}')">â–¶</button>`:''}
    </div>
    ${subTotal?`<div class="task-detail" id="tdetail-${t.id}">
      <div class="subtask-list">${(t.subtasks||[]).map(s=>`<div class="subtask-row">
        <button class="subtask-check${s.done?' done':''}" onclick="toggleSubtask('${projId}','${t.id}','${s.id}')">${s.done?'âœ“':''}</button>
        <span class="subtask-text${s.done?' done':''}">${esc(s.text)}</span>
        <button class="subtask-del" onclick="deleteSubtask('${projId}','${t.id}','${s.id}')">Ã—</button>
      </div>`).join('')}</div>
    </div>`:''}
  </div>`;
}

function cycleTaskStatus(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const cycle = { todo:'in_progress', in_progress:'done', done:'todo' };
  t.status = cycle[t.status||'todo'];
  t.done = t.status === 'done';
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave();
}

function cycleTaskPriority(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const cycle = { low:'medium', medium:'high', high:'critical', critical:'low' };
  t.priority = cycle[t.priority||'medium'];
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); scheduleSave();
}

function deleteTaskFromProj(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  p.tasks = p.tasks.filter(t=>t.id!==taskId);
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); scheduleSave();
}

function toggleTaskDetail(taskId) {
  const detail = document.getElementById('tdetail-'+taskId);
  const btn = document.getElementById('texpand-'+taskId);
  if (!detail) return;
  const open = detail.classList.toggle('open');
  if (btn) btn.classList.toggle('open', open);
}

function openTaskDetail(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const st = TASK_STATUS[t.status||'todo'];
  showModal(`
    <div class="modal-header">
      <div class="modal-title" style="display:flex;align-items:center;gap:8px">
        <span style="color:${TASK_STATUS[t.status||'todo'].color}">${TASK_STATUS[t.status||'todo'].icon}</span>
        DÃ©tail de la tÃ¢che
      </div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">TÃ¢che</label>
        <input class="input" id="td-text" value="${esc(t.text)}">
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Statut</label>
          <select class="input" id="td-status">
            ${Object.entries(TASK_STATUS).map(([k,v])=>`<option value="${k}"${t.status===k?' selected':''}>${v.icon} ${v.label}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">PrioritÃ©</label>
          <select class="input" id="td-priority">
            ${['low','medium','high','critical'].map(k=>`<option value="${k}"${(t.priority||'medium')===k?' selected':''}>${k}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">Rang</label>
          <input type="number" class="input" id="td-rank" value="${t.rank||0}" min="0">
        </div>
      </div>
      <div class="form-group"><label class="form-label">Date limite</label>
        <input type="date" class="input" id="td-due" value="${t.dueDate||''}" style="color-scheme:dark">
      </div>
      <div class="form-group"><label class="form-label">Note</label>
        <textarea class="input" id="td-note" style="min-height:80px">${esc(t.note||'')}</textarea>
      </div>
      <!-- Subtasks -->
      <div class="form-group">
        <label class="form-label">Sous-tÃ¢ches (${(t.subtasks||[]).filter(s=>s.done).length}/${(t.subtasks||[]).length})</label>
        <div id="td-subtasks">${renderSubtasksEdit(t.subtasks||[])}</div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <input class="input" id="td-sub-inp" placeholder="+ Sous-tÃ¢che..." style="font-size:12px" onkeydown="if(event.key==='Enter')addSubtaskFromModal('${projId}','${taskId}')">
          <button class="btn" onclick="addSubtaskFromModal('${projId}','${taskId}')">+</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveTaskDetail('${projId}','${taskId}')">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}
function renderSubtasksEdit(subtasks) {
  if (!subtasks.length) return '<p style="color:var(--text3);font-size:11px">Aucune sous-tÃ¢che</p>';
  return subtasks.map(s=>`<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border)">
    <button class="subtask-check${s.done?' done':''}" onclick="this.classList.toggle('done');this.nextSibling.nextSibling.value=this.classList.contains('done')?'true':'false'">${s.done?'âœ“':''}</button>
    <span style="flex:1;font-size:12px;${s.done?'text-decoration:line-through;opacity:0.5':''}">${esc(s.text)}</span>
    <input type="hidden" class="sub-done-val" value="${s.done}">
    <input type="hidden" class="sub-id-val" value="${s.id}">
    <button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:var(--text3)">Ã—</button>
  </div>`).join('');
}
window.addSubtaskFromModal = function(projId, taskId) {
  const inp = document.getElementById('td-sub-inp'); if(!inp||!inp.value.trim()) return;
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  if(!t.subtasks) t.subtasks=[];
  const sub = { id:uid(), text:inp.value.trim(), done:false };
  t.subtasks.push(sub);
  p.updatedAt = new Date().toISOString();
  inp.value='';
  const container = document.getElementById('td-subtasks');
  if (container) container.innerHTML = renderSubtasksEdit(t.subtasks);
  scheduleSave();
};
window.saveTaskDetail = function(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  t.text = document.getElementById('td-text')?.value.trim() || t.text;
  t.status = document.getElementById('td-status')?.value || t.status;
  t.done = t.status === 'done';
  t.priority = document.getElementById('td-priority')?.value || t.priority;
  t.rank = parseInt(document.getElementById('td-rank')?.value)||0;
  t.dueDate = document.getElementById('td-due')?.value || '';
  t.note = document.getElementById('td-note')?.value || '';
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave(); closeModal();
  toast('TÃ¢che mise Ã  jour âœ');
};

function toggleSubtask(projId, taskId, subId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const s = (t.subtasks||[]).find(x=>x.id===subId); if(!s) return;
  s.done = !s.done;
  p.updatedAt = new Date().toISOString();
  renderSlots(); scheduleSave();
}
function deleteSubtask(projId, taskId, subId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  t.subtasks = (t.subtasks||[]).filter(s=>s.id!==subId);
  p.updatedAt = new Date().toISOString();
  renderSlots(); scheduleSave();
}

// â”€â”€ TOUCH DRAG (mobile drag & drop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTouchDragStart(e) {
  const card = e.currentTarget;
  touchDragId = card.dataset.id;
  const touch = e.touches[0];
  // Create ghost
  touchGhost = card.cloneNode(true);
  touchGhost.className = card.className + ' touch-drag-ghost';
  touchGhost.style.width = card.offsetWidth + 'px';
  touchGhost.style.left = (touch.clientX - card.offsetWidth/2) + 'px';
  touchGhost.style.top = (touch.clientY - 30) + 'px';
  document.body.appendChild(touchGhost);
  document.addEventListener('touchmove', onTouchDragMove, { passive: false });
  document.addEventListener('touchend', onTouchDragEnd);
}

function onTouchDragMove(e) {
  e.preventDefault();
  if (!touchGhost || !touchDragId) return;
  const touch = e.touches[0];
  touchGhost.style.left = (touch.clientX - parseInt(touchGhost.style.width)/2) + 'px';
  touchGhost.style.top = (touch.clientY - 30) + 'px';
  // Find drop target
  touchGhost.style.display = 'none';
  const el = document.elementFromPoint(touch.clientX, touch.clientY);
  touchGhost.style.display = '';
  if (!el) return;
  // Check slot drop zones
  let zone = null;
  const slotEl = el.closest('[id^="slot-"]');
  if (slotEl) zone = slotEl.id.replace('slot-','');
  // Highlight
  document.querySelectorAll('.slot-card').forEach(s => s.classList.remove('drag-valid-target'));
  if (zone && SLOT_INFO[zone]) {
    const slotCard = document.getElementById('slot-'+zone);
    if (slotCard) { slotCard.classList.add('drag-valid-target'); touchDragOver = zone; }
  } else { touchDragOver = null; }
}

function onTouchDragEnd() {
  if (touchGhost) { touchGhost.remove(); touchGhost = null; }
  document.querySelectorAll('.slot-card').forEach(s => s.classList.remove('drag-valid-target'));
  document.removeEventListener('touchmove', onTouchDragMove);
  document.removeEventListener('touchend', onTouchDragEnd);
  if (touchDragId && touchDragOver) {
    assignToSlot(touchDragId, touchDragOver);
  }
  touchDragId = null; touchDragOver = null;
}

// â”€â”€ HABITS SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const todayKey = () => new Date().toISOString().split('T')[0];

function renderHabits() {
  const body = document.getElementById('habits-body'); if (!body) return;
  const collapsed = state.settings.habitsCollapsed;
  const btn = document.getElementById('habits-collapse-btn');
  if (btn) btn.textContent = collapsed ? '+' : 'âˆ’';
  if (collapsed) { body.style.display = 'none'; return; }
  body.style.display = 'block';
  const today = todayKey();
  const log = state.habitLog[today] || {};
  const done = state.habits.filter(h => log[h.id]).length;
  const badge = document.getElementById('habits-streak-badge');
  if (badge) {
    badge.style.display = state.habits.length > 0 ? 'inline' : 'none';
    badge.textContent = `${done}/${state.habits.length}`;
    badge.style.background = done===state.habits.length ? 'rgba(34,197,94,0.2)' : 'rgba(var(--accent-rgb),0.15)';
    badge.style.color = done===state.habits.length ? '#4ade80' : 'var(--accent)';
  }
  if (!state.habits.length) {
    body.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text3);font-size:12px">Aucune habitude â€” <button onclick="addHabitPrompt()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px">Ajouter â†’</button></div>`;
    return;
  }
  body.innerHTML = state.habits.map(h => {
    const isDone = !!log[h.id];
    const streak = getHabitStreak(h.id);
    const dots = Array.from({length:7},(_,i)=>{ const d=new Date();d.setDate(d.getDate()-6+i);const k=d.toISOString().split('T')[0];const filled=!!(state.habitLog[k]||{})[h.id];return `<div class="habit-dot" style="background:${filled?(h.color||'var(--accent)'):'rgba(255,255,255,0.1)'}"></div>`; }).join('');
    return `<div class="habit-row"><button class="habit-check${isDone?' done':''}" onclick="toggleHabit('${h.id}')" style="${isDone?`border-color:${h.color||'#22c55e'};background:${h.color||'#22c55e'}22`:''}"></button><span class="habit-name" style="${isDone?'text-decoration:line-through;opacity:0.5':''}">${esc(h.name)}</span><div class="habit-dots">${dots}</div>${streak>0?`<div class="habit-streak">ğŸ”¥ ${streak}</div>`:''}<button class="habit-del" onclick="deleteHabit('${h.id}')">Ã—</button></div>`;
  }).join('');
}
function getHabitStreak(habitId) {
  let streak=0,d=new Date(); d.setDate(d.getDate()-1);
  while(true){const k=d.toISOString().split('T')[0];if((state.habitLog[k]||{})[habitId]){streak++;d.setDate(d.getDate()-1);}else break;if(streak>365)break;}
  if((state.habitLog[todayKey()]||{})[habitId]) streak++;
  return streak;
}
function toggleHabit(habitId) {
  const today=todayKey(); if(!state.habitLog[today])state.habitLog[today]={};
  state.habitLog[today][habitId]=!state.habitLog[today][habitId];
  const cutoff=new Date();cutoff.setDate(cutoff.getDate()-90);
  Object.keys(state.habitLog).forEach(k=>{if(new Date(k)<cutoff)delete state.habitLog[k];});
  renderHabits(); scheduleSave();
  const allDone=state.habits.length>0&&state.habits.every(h=>state.habitLog[today][h.id]);
  if(allDone) toast('ğŸŒ¿ Toutes les habitudes du jour ! ğŸ‰','success');
}
function addHabitPrompt() {
  showModal(`
    <div class="modal-header"><div class="modal-title">ğŸŒ¿ Nouvelle habitude</div><button class="btn btn-icon" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Nom</label><input class="input" id="habit-name-inp" placeholder="Ex: MÃ©ditation, Sport, Lecture..."></div>
      <div class="form-group"><label class="form-label">Couleur</label><div class="color-swatches">${COLORS.slice(0,8).map((c,i)=>`<div class="color-swatch${i===0?' active':''}" style="background:${c}" onclick="document.querySelectorAll('.color-swatches .color-swatch').forEach(s=>s.classList.remove('active'));this.classList.add('active');document.getElementById('habit-color-val').value='${c}'"></div>`).join('')}</div><input type="hidden" id="habit-color-val" value="${COLORS[0]}"></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveNewHabit()">+ Ajouter</button></div>
  `);
  setTimeout(()=>document.getElementById('habit-name-inp')?.focus(),100);
}
window.saveNewHabit = function() {
  const name=document.getElementById('habit-name-inp')?.value.trim();
  const color=document.getElementById('habit-color-val')?.value||COLORS[0];
  if(!name)return;
  state.habits.push({id:uid(),name,color,createdAt:new Date().toISOString()});
  renderHabits();scheduleSave();closeModal();toast(`ğŸŒ¿ "${name}" ajoutÃ©e !`);
};
function deleteHabit(id){state.habits=state.habits.filter(h=>h.id!==id);renderHabits();scheduleSave();}
function toggleHabitsWidget(){state.settings.habitsCollapsed=!state.settings.habitsCollapsed;renderHabits();scheduleSave();}

// â”€â”€ SYNC STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(s) {
  syncStatus = s;
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  if (!dot) return;
  dot.className = 'sync-dot ' + s;
  const labels = { idle:'Local', syncing:'Sync...', synced:'Sync âœ“', error:'Erreur sync' };
  lbl.textContent = labels[s] || s;
  if (s==='synced') { lastSaveTime=new Date(); updateSyncTime(); }
}
function updateSyncTime() {
  const el=document.getElementById('sync-time'); if(!el||!lastSaveTime)return;
  const diff=Math.round((Date.now()-lastSaveTime)/1000);
  el.textContent=diff<5?'Ã€ l\'instant':diff<60?`${diff}s`:`${Math.round(diff/60)}min`;
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
