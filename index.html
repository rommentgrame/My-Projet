<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ProjectFlow</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECTFLOW â€” Modern UI v4.0
   Mobile-first â€¢ Dark theme â€¢ Sora font
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  /* Colors */
  --bg:          #0a0d14;
  --bg2:         #0f1320;
  --bg3:         #151a2e;
  --surface:     #1a2035;
  --surface2:    #1f2740;
  --border:      rgba(255,255,255,0.07);
  --border2:     rgba(255,255,255,0.12);
  --text:        #e8eaf2;
  --text2:       #9ba3bf;
  --text3:       #5a6280;
  --accent:      #7c3aed;
  --accent2:     #5b21b6;
  --accent-rgb:  124,58,237;
  --success:     #22c55e;
  --warning:     #f59e0b;
  --danger:      #ef4444;
  --info:        #0ea5e9;

  /* Glass */
  --glass:       rgba(255,255,255,0.03);
  --glass2:      rgba(255,255,255,0.06);

  /* Spacing */
  --gap:         1rem;
  --gap-sm:      0.5rem;
  --gap-lg:      1.5rem;

  /* Radius */
  --r-sm:        8px;
  --r:           12px;
  --r-lg:        20px;
  --r-xl:        28px;

  /* Font */
  --font:        'Sora', system-ui, -apple-system, sans-serif;
  --mono:        'JetBrains Mono', monospace;

  /* Layout */
  --nav-h:       64px;
  --header-h:    56px;
  --sidebar-w:   300px;
  --fab-size:    56px;
}

/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100%;
  overflow-x: hidden;
  line-height: 1.5;
}
input, select, textarea, button { font-family: inherit; }
button { cursor: pointer; border: none; background: none; color: inherit; }
a { color: var(--accent); text-decoration: none; }
code { font-family: var(--mono); }

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--border2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREENS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.auth-screen {
  position: fixed; inset: 0; z-index: 9999;
  display: none; align-items: center; justify-content: center;
  padding: 20px;
  overflow: hidden;
  /* Layered background */
  background:
    radial-gradient(ellipse 100% 70% at 15% 0%, rgba(124,58,237,0.18) 0%, transparent 60%),
    radial-gradient(ellipse 80% 60% at 85% 100%, rgba(79,70,229,0.14) 0%, transparent 55%),
    radial-gradient(ellipse 60% 50% at 50% 50%, rgba(14,165,233,0.05) 0%, transparent 60%),
    #07090f;
}
.auth-screen.active { display: flex; }

/* Animated grid overlay */
.auth-grid {
  position: absolute; inset: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 48px 48px;
  mask-image: radial-gradient(ellipse 90% 90% at 50% 50%, black 0%, transparent 75%);
  -webkit-mask-image: radial-gradient(ellipse 90% 90% at 50% 50%, black 0%, transparent 75%);
  animation: gridFade 8s ease-in-out infinite alternate;
}
@keyframes gridFade { from { opacity: 0.5; } to { opacity: 1; } }

/* Floating orbs */
.auth-orbs { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
.auth-orb {
  position: absolute; border-radius: 50%;
  animation: orbFloat linear infinite;
  opacity: 0;
}
@keyframes orbFloat {
  0%   { transform: translateY(110vh) rotate(0deg);   opacity: 0; }
  5%   { opacity: 1; }
  95%  { opacity: 1; }
  100% { transform: translateY(-20px) rotate(540deg); opacity: 0; }
}

/* Auth card */
.auth-card {
  position: relative; z-index: 2;
  width: 100%; max-width: 420px;
  animation: cardIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
}
@keyframes cardIn {
  from { opacity: 0; transform: translateY(24px) scale(0.97); }
  to   { opacity: 1; transform: none; }
}
.auth-card-inner {
  background: rgba(10, 13, 20, 0.88);
  backdrop-filter: blur(40px) saturate(160%);
  -webkit-backdrop-filter: blur(40px) saturate(160%);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: var(--r-xl);
  padding: 40px 36px 36px;
  box-shadow:
    0 60px 120px rgba(0,0,0,0.7),
    0 0 0 1px rgba(255,255,255,0.03),
    inset 0 1px 0 rgba(255,255,255,0.06);
}

/* Logo */
.auth-logo {
  display: flex; flex-direction: column; align-items: center;
  margin-bottom: 32px; text-align: center;
}
.auth-logo-ring {
  width: 80px; height: 80px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  background: conic-gradient(from 0deg, var(--accent), #4f46e5, #0ea5e9, var(--accent));
  padding: 2.5px; margin-bottom: 16px;
  animation: ringRotate 6s linear infinite;
  position: relative;
}
@keyframes ringRotate { to { transform: rotate(360deg); } }
.auth-logo-icon {
  width: 100%; height: 100%;
  border-radius: 50%; background: #07090f;
  display: flex; align-items: center; justify-content: center;
  font-size: 34px; line-height: 1;
  animation: ringRotate 6s linear infinite reverse; /* counter-rotate to stay upright */
}
.auth-app-name {
  font-size: 24px; font-weight: 800; letter-spacing: -0.5px;
  background: linear-gradient(135deg, #fff 30%, rgba(255,255,255,0.6));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; margin-bottom: 4px;
}
.auth-tagline {
  font-size: 12px; color: var(--text3); letter-spacing: 0.06em;
  display: flex; align-items: center; gap: 6px;
}
.auth-status-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--success);
  box-shadow: 0 0 6px var(--success);
  animation: pulse 2s ease-in-out infinite;
}
.auth-status-dot.setup { background: var(--warning); box-shadow: 0 0 6px var(--warning); }
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.7; }
}

/* Setup banner */
.auth-banner {
  display: flex; gap: 10px; align-items: flex-start;
  background: rgba(124,58,237,0.1);
  border: 1px solid rgba(124,58,237,0.25);
  border-radius: var(--r); padding: 12px 14px;
  margin-bottom: 20px; font-size: 12px; line-height: 1.6; color: var(--text2);
}
.auth-banner-icon { font-size: 16px; flex-shrink: 0; }

/* Form fields */
.auth-field {
  position: relative; margin-bottom: 12px;
}
.auth-field-icon {
  position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  font-size: 16px; pointer-events: none; z-index: 1;
}
.auth-input {
  width: 100%; padding: 12px 14px 12px 44px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r); color: var(--text);
  font-size: 14px; font-family: var(--font);
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  outline: none;
}
.auth-input:focus {
  border-color: rgba(var(--accent-rgb), 0.5);
  background: rgba(var(--accent-rgb), 0.06);
  box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.15);
}
.auth-input::placeholder { color: var(--text3); }

/* Auth button */
.auth-btn {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, var(--accent), #4f46e5);
  color: #fff; font-size: 14px; font-weight: 600;
  border-radius: var(--r); letter-spacing: 0.02em;
  transition: all 0.2s; margin-top: 4px;
  box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.35);
  position: relative; overflow: hidden;
}
.auth-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(to right, transparent, rgba(255,255,255,0.12), transparent);
  transform: translateX(-100%); transition: transform 0.5s;
}
.auth-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(var(--accent-rgb), 0.45); }
.auth-btn:hover::before { transform: translateX(100%); }
.auth-btn:active { transform: translateY(0); }
.auth-btn:disabled { opacity: 0.6; pointer-events: none; }

/* Error message */
.auth-error {
  display: none; padding: 10px 14px; margin-bottom: 12px;
  background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.25);
  border-radius: var(--r-sm); color: #fca5a5; font-size: 12px;
  animation: errShake 0.35s cubic-bezier(0.36, 0.07, 0.19, 0.97);
}
@keyframes errShake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-6px); }
  40%, 80% { transform: translateX(6px); }
}

/* Attempts / lockout */
.auth-attempts {
  display: none; padding: 8px 12px; margin-bottom: 10px;
  background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.25);
  border-radius: var(--r-sm); color: #fcd34d; font-size: 11px;
  text-align: center; font-weight: 500;
}

/* Security badge */
.auth-badge {
  display: flex; justify-content: center; gap: 12px;
  margin-top: 20px; padding-top: 16px;
  border-top: 1px solid var(--border);
  font-size: 10px; color: var(--text3); letter-spacing: 0.03em;
}
.auth-badge span { display: flex; align-items: center; gap: 3px; }

/* Hint */
.auth-hint {
  text-align: center; font-size: 11px; color: var(--text3);
  margin-top: 12px;
}

/* Skip link */
.auth-skip {
  display: block; text-align: center; margin-top: 14px;
  font-size: 12px; color: var(--text3);
  transition: color 0.2s; padding: 4px;
}
.auth-skip:hover { color: var(--text2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP WRAPPER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.app-wrapper {
  display: none; flex-direction: column;
  height: 100dvh; overflow: hidden;
}
.app-wrapper.visible { display: flex; }

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header {
  height: var(--header-h); min-height: var(--header-h);
  display: flex; align-items: center; gap: 8px;
  padding: 0 16px;
  background: rgba(10,13,20,0.92);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  z-index: 100; flex-shrink: 0;
}
.logo {
  display: flex; align-items: center; gap: 10px;
  text-decoration: none; color: inherit;
}
.logo-icon { font-size: 22px; }
.logo-text {
  font-size: 16px; font-weight: 800;
  letter-spacing: -0.3px; color: #fff;
}
.logo-sub {
  font-size: 10px; color: var(--text3);
  max-width: 200px; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.header-spacer { flex: 1; }
.header-actions {
  display: flex; align-items: center; gap: 6px;
}
.sync-badge {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 10px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 20px; cursor: pointer;
  transition: all 0.2s; font-size: 11px; color: var(--text2);
}
.sync-badge:hover { background: var(--glass2); border-color: var(--border2); }
.sync-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.sync-dot.idle    { background: var(--text3); }
.sync-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
.sync-dot.synced  { background: var(--success); }
.sync-dot.error   { background: var(--danger); }
#sync-time { font-size: 9px; color: var(--text3); }
#user-label {
  font-size: 11px; color: var(--text3);
  padding-left: 6px; margin-left: 2px;
  border-left: 1px solid var(--border);
}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 7px 12px; border-radius: var(--r-sm);
  font-size: 12px; font-weight: 500; font-family: var(--font);
  transition: all 0.18s; color: var(--text2);
  background: var(--glass);
  border: 1px solid var(--border);
  white-space: nowrap; text-decoration: none;
  cursor: pointer;
}
.btn:hover { background: var(--glass2); border-color: var(--border2); color: var(--text); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.45; pointer-events: none; }

.btn-primary {
  background: linear-gradient(135deg, var(--accent) 0%, #4f46e5 100%);
  border-color: transparent; color: #fff;
  box-shadow: 0 3px 12px rgba(var(--accent-rgb), 0.3);
}
.btn-primary:hover {
  box-shadow: 0 5px 20px rgba(var(--accent-rgb), 0.45);
  border-color: transparent; color: #fff;
  filter: brightness(1.1);
}

.btn-danger {
  background: rgba(239,68,68,0.12);
  border-color: rgba(239,68,68,0.25); color: #fca5a5;
}
.btn-danger:hover { background: rgba(239,68,68,0.2); color: #fca5a5; }

.btn-icon {
  width: 34px; height: 34px; padding: 0;
  border-radius: var(--r-sm); font-size: 15px;
}

.btn-text { display: none; }

/* â”€â”€ BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-body {
  display: flex; flex: 1; overflow: hidden;
}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar-overlay {
  display: none; position: fixed; inset: 0; z-index: 190;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
}
.sidebar {
  width: 0; overflow: hidden;
  display: flex; flex-direction: column;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0; z-index: 200;
}
.sidebar.open {
  width: min(var(--sidebar-w), 90vw);
}

.sidebar-header {
  padding: 14px 14px 0;
  flex-shrink: 0; border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}
.sidebar-topbar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.sidebar-title {
  font-size: 13px; font-weight: 700; color: var(--text);
  display: flex; align-items: center; gap: 6px;
}
.count-badge {
  display: inline-flex; align-items: center; justify-content: center;
  background: rgba(var(--accent-rgb), 0.2);
  color: rgba(var(--accent-rgb), 1); border-radius: 10px;
  padding: 1px 7px; font-size: 10px; font-weight: 700;
}
.sidebar-cat-section { margin-bottom: 8px; }
.sidebar-cat-title {
  display: flex; align-items: center; justify-content: space-between;
  font-size: 10px; font-weight: 600; color: var(--text3);
  text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 6px;
}
.cats-filter-row {
  display: flex; flex-wrap: wrap; gap: 4px;
}
.cat-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 8px; border-radius: 20px;
  font-size: 10px; font-weight: 500;
  background: var(--surface); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.15s;
}
.cat-chip:hover { border-color: var(--border2); }
.cat-chip.active {
  background: rgba(var(--accent-rgb), 0.15);
  border-color: rgba(var(--accent-rgb), 0.4); color: #c4b5fd;
}

.search-wrap {
  position: relative; margin-bottom: 8px;
}
.search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  font-size: 13px; pointer-events: none; color: var(--text3);
}
.search-clear {
  position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--text3); font-size: 16px;
  cursor: pointer; padding: 0 4px; line-height: 1;
  transition: color 0.15s;
}
.search-clear:hover { color: var(--text); }

.sidebar-filters { display: flex; flex-direction: column; gap: 8px; padding-bottom: 8px; }
.filter-row { display: flex; flex-wrap: wrap; gap: 4px; }
.filter-chip {
  padding: 3px 8px; border-radius: 20px;
  font-size: 10px; font-weight: 500;
  background: var(--surface); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.15s; color: var(--text2);
}
.filter-chip:hover { border-color: var(--border2); color: var(--text); }
.filter-chip.active { background: rgba(var(--accent-rgb),0.15); border-color: rgba(var(--accent-rgb),0.4); color: #c4b5fd; }

.sidebar-list { flex: 1; overflow-y: auto; padding: 8px; }
.sidebar-add-btn {
  width: 100%; padding: 10px 12px;
  background: transparent; border: 1px dashed rgba(var(--accent-rgb),0.3);
  border-radius: var(--r); color: rgba(var(--accent-rgb),0.8);
  font-size: 12px; font-weight: 600;
  transition: all 0.2s; cursor: pointer; text-align: left;
  margin-bottom: 6px;
}
.sidebar-add-btn:hover {
  background: rgba(var(--accent-rgb),0.08);
  border-color: rgba(var(--accent-rgb),0.5);
}

/* Backlog cards */
.backlog-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 10px 11px;
  margin-bottom: 4px; cursor: grab;
  transition: all 0.18s; position: relative;
  border-left: 3px solid transparent;
}
.backlog-card:hover {
  background: var(--surface2); border-color: var(--border2);
  transform: translateX(2px);
}
.backlog-card:active { cursor: grabbing; }
.backlog-card.pinned { border-left-color: var(--warning); }
.backlog-card.dragging { opacity: 0.4; transform: scale(0.98); }
.backlog-card.drag-over { box-shadow: 0 0 0 2px var(--accent); }

.bc-top {
  display: flex; align-items: flex-start; gap: 7px; margin-bottom: 4px;
}
.bc-icon { font-size: 15px; flex-shrink: 0; margin-top: 1px; }
.bc-name {
  flex: 1; font-size: 12px; font-weight: 600;
  color: var(--text); line-height: 1.35; word-break: break-word;
}
.bc-actions {
  display: flex; gap: 2px; opacity: 0; transition: opacity 0.15s;
}
.backlog-card:hover .bc-actions { opacity: 1; }
.bc-actions .btn-icon {
  width: 22px; height: 22px; font-size: 11px;
  background: transparent; border: none;
}
.bc-meta {
  display: flex; align-items: center; gap: 6px;
  flex-wrap: wrap;
}
.sidebar-empty {
  text-align: center; padding: 40px 16px; color: var(--text3);
}
.empty-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.5; }

/* sidebar footer */
#sidebar-footer {
  padding: 8px 12px; border-top: 1px solid var(--border);
  font-size: 10px; color: var(--text3);
  text-align: center; flex-shrink: 0;
}

/* â”€â”€ MAIN AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-area {
  flex: 1; overflow-y: auto;
  padding: 16px 16px 80px;
}

/* â”€â”€ SECTION HEADERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.section-title {
  font-size: 15px; font-weight: 700;
  color: var(--text); display: flex; align-items: center; gap: 6px;
}
.divider {
  height: 1px; background: var(--border); margin: 20px 0;
}

/* â”€â”€ SLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.slots-grid {
  display: grid; grid-template-columns: 1fr;
  gap: 14px; margin-bottom: 20px;
}

.slot-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-lg); overflow: hidden;
  transition: all 0.2s;
}
.slot-card.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(var(--accent-rgb),0.25); }
.slot-empty {
  padding: 28px 20px; text-align: center;
  border: 2px dashed rgba(255,255,255,0.08);
  background: transparent; cursor: pointer;
}
.slot-empty-icon { font-size: 28px; opacity: 0.4; margin-bottom: 6px; }
.slot-empty-text { font-size: 12px; color: var(--text3); font-weight: 500; }
.slot-empty:hover { background: var(--glass); border-color: rgba(var(--accent-rgb),0.25); }

.slot-header {
  display: flex; align-items: center; gap: 8px; padding: 12px 14px 0;
}
.slot-label {
  font-size: 9px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text3);
  padding: 2px 7px; background: var(--glass);
  border: 1px solid var(--border); border-radius: 10px;
}
.slot-proj-icon { font-size: 20px; }
.slot-proj-name {
  flex: 1; font-size: 14px; font-weight: 700; color: var(--text);
  word-break: break-word;
}
.slot-body { padding: 10px 14px 14px; }
.sp-desc {
  font-size: 12px; color: var(--text2); margin-bottom: 10px; line-height: 1.5;
}
.sp-progress { margin-bottom: 10px; }
.sp-progress-bar {
  height: 5px; background: var(--surface2); border-radius: 10px; overflow: hidden;
}
.sp-progress-fill {
  height: 100%; border-radius: 10px;
  background: linear-gradient(90deg, var(--accent), #7dd3fc);
  transition: width 0.5s ease; min-width: 4px;
}
.sp-tasks-scroll { max-height: 120px; overflow-y: auto; margin-bottom: 10px; }
.sp-task {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 4px; border-radius: 6px;
  transition: background 0.15s; cursor: pointer; font-size: 12px;
}
.sp-task:hover { background: var(--glass); }
.sp-task-check {
  width: 15px; height: 15px; border-radius: 4px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  border: 1.5px solid var(--border2); font-size: 9px;
  transition: all 0.15s;
}
.sp-task.done .sp-task-check {
  background: var(--success); border-color: var(--success); color: #fff;
}
.sp-task-text { flex: 1; }
.sp-task.done .sp-task-text { text-decoration: line-through; color: var(--text3); }
.sp-task-add {
  display: flex; gap: 6px; margin-bottom: 10px;
}
.sp-task-add .input {
  flex: 1; padding: 7px 10px; font-size: 11px;
}
.sp-footer {
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
}
.timer-widget-mini {
  display: flex; align-items: center; gap: 4px;
}
.timer-display-mini {
  font-family: var(--mono); font-size: 14px; font-weight: 600;
  color: var(--text); letter-spacing: 0.05em;
}

/* Progress ring */
.prog-ring { display: flex; align-items: center; justify-content: center; }

/* â”€â”€ QUICK STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.quick-stats-grid {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 10px; margin-bottom: 20px;
}
.qs-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 12px 14px;
  display: flex; align-items: center; gap: 10px;
}
.qs-icon { font-size: 20px; }
.qs-num { font-size: 20px; font-weight: 800; color: var(--text); }
.qs-label { font-size: 10px; color: var(--text3); font-weight: 500; }

/* â”€â”€ KBD HINTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kbd-hints {
  display: none; /* hidden on mobile */
  gap: 12px; flex-wrap: wrap; padding: 10px 14px;
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--r-sm); font-size: 11px; color: var(--text3);
  margin-bottom: 20px;
}
.kbd {
  display: inline-block; padding: 1px 5px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; font-family: var(--mono); font-size: 10px;
  color: var(--text2);
}

/* â”€â”€ COMPLETED VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.completed-grid {
  display: grid; grid-template-columns: 1fr;
  gap: 10px;
}
.completed-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 12px 14px;
  display: flex; gap: 10px; align-items: flex-start;
  transition: all 0.18s;
}
.completed-card:hover { background: var(--surface2); }
.completed-trophy { font-size: 20px; flex-shrink: 0; margin-top: 2px; }
.completed-body { flex: 1; min-width: 0; }
.completed-name { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.completed-meta { font-size: 11px; color: var(--text3); }
.completed-actions { display: flex; gap: 4px; }

/* â”€â”€ STATS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px;
}
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 20px;
}
.stat-big { font-size: 36px; font-weight: 800; letter-spacing: -1px; }
.stat-label { font-size: 12px; color: var(--text3); margin-top: 2px; }
.stat-detail { font-size: 11px; color: var(--text2); margin-top: 8px; }

/* â”€â”€ HABITS WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.habits-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 14px 16px;
  margin-bottom: 18px;
}
.habits-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.habits-title {
  font-size: 13px; font-weight: 700;
  display: flex; align-items: center; gap: 6px;
}
.habit-row {
  display: flex; align-items: center; gap: 8px; padding: 6px 4px;
  border-radius: var(--r-sm); transition: background 0.15s;
}
.habit-row:hover { background: var(--glass); }
.habit-check {
  width: 28px; height: 28px; border-radius: 50%;
  border: 2px solid var(--border2); background: transparent;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; transition: all 0.2s; flex-shrink: 0; cursor: pointer;
}
.habit-check.done { background: var(--success); border-color: var(--success); color: #fff; }
.habit-name { flex: 1; font-size: 12px; font-weight: 500; }
.habit-streak { font-size: 10px; color: var(--text3); }
.habit-days { display: flex; gap: 3px; }
.habit-day-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--surface2);
}
.habit-day-dot.filled { background: var(--success); }

/* â”€â”€ MOBILE BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mobile-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(10,13,20,0.95);
  backdrop-filter: blur(24px);
  border-top: 1px solid var(--border);
  padding: 6px 0 max(8px, env(safe-area-inset-bottom));
}
.mobile-nav-inner {
  display: flex; justify-content: space-around; align-items: center;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 4px 12px; border-radius: var(--r);
  font-size: 10px; font-weight: 600; color: var(--text3);
  transition: all 0.2s; background: none; border: none; cursor: pointer;
  letter-spacing: 0.02em;
  -webkit-tap-highlight-color: transparent;
}
.nav-item span:first-child { font-size: 20px; line-height: 1.2; }
.nav-item:hover, .nav-item.active {
  color: rgba(var(--accent-rgb), 1);
}
.nav-item.active span:first-child {
  filter: drop-shadow(0 0 8px rgba(var(--accent-rgb), 0.8));
}

/* â”€â”€ FAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mobile-fab {
  position: fixed; right: 18px;
  bottom: calc(var(--nav-h) + 12px);
  z-index: 301;
  width: var(--fab-size); height: var(--fab-size);
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #4f46e5);
  color: #fff; font-size: 28px; line-height: 1;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 24px rgba(var(--accent-rgb), 0.5);
  border: none; cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.mobile-fab:hover { transform: scale(1.08); box-shadow: 0 6px 32px rgba(var(--accent-rgb), 0.65); }
.mobile-fab:active { transform: scale(0.94); }

/* â”€â”€ VIEW TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view-hidden { display: none !important; }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container {
  position: fixed; bottom: calc(var(--nav-h) + 70px); right: 16px;
  z-index: 10000; display: flex; flex-direction: column; gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 11px 16px; border-radius: var(--r);
  font-size: 13px; font-weight: 500;
  backdrop-filter: blur(20px); pointer-events: auto;
  animation: toastIn 0.3s cubic-bezier(0.22, 1, 0.36, 1) both;
  box-shadow: 0 4px 24px rgba(0,0,0,0.5);
  max-width: 280px;
}
@keyframes toastIn {
  from { opacity: 0; transform: translateX(20px) scale(0.95); }
  to   { opacity: 1; transform: none; }
}
.toast.success { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); color: #86efac; }
.toast.error   { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; }
.toast.info    { background: rgba(14,165,233,0.15); border: 1px solid rgba(14,165,233,0.3); color: #7dd3fc; }
.toast.default { background: rgba(30,30,60,0.9); border: 1px solid var(--border); color: var(--text); }

/* â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-bg {
  position: fixed; inset: 0; z-index: 5000;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
  display: flex; align-items: flex-end; justify-content: center;
  padding: 0; animation: bgIn 0.2s ease;
}
@keyframes bgIn { from { opacity: 0; } to { opacity: 1; } }
.modal {
  width: 100%; max-width: 620px; max-height: 92dvh;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r-xl) var(--r-xl) 0 0;
  display: flex; flex-direction: column; overflow: hidden;
  animation: modalIn 0.35s cubic-bezier(0.22, 1, 0.36, 1) both;
}
@keyframes modalIn {
  from { opacity: 0; transform: translateY(40px); }
  to   { opacity: 1; transform: none; }
}
.modal-header {
  padding: 18px 20px 14px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.modal-title { font-size: 15px; font-weight: 700; color: var(--text); }
.modal-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
.modal-footer {
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 8px;
  flex-shrink: 0;
}

/* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group { margin-bottom: 12px; }
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; margin-bottom: 0; }
.form-label {
  display: block; font-size: 11px; font-weight: 600;
  color: var(--text3); text-transform: uppercase; letter-spacing: 0.06em;
  margin-bottom: 5px;
}
.input {
  width: 100%; padding: 9px 12px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-sm); color: var(--text);
  font-size: 13px; font-family: var(--font);
  transition: all 0.2s; outline: none;
  appearance: none; -webkit-appearance: none;
}
.input:focus {
  border-color: rgba(var(--accent-rgb), 0.5);
  background: rgba(var(--accent-rgb), 0.05);
  box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.12);
}
.input::placeholder { color: var(--text3); }
select.input { cursor: pointer; padding-right: 28px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235a6280' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
textarea.input { resize: vertical; min-height: 80px; }

/* â”€â”€ MODAL TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-tabs { display: flex; gap: 2px; margin-bottom: 14px; }
.modal-tab {
  flex: 1; padding: 7px; font-size: 11px; font-weight: 600;
  border-radius: var(--r-sm); color: var(--text3);
  background: var(--surface); border: 1px solid transparent;
  cursor: pointer; transition: all 0.15s; text-align: center;
}
.modal-tab.active {
  color: rgba(var(--accent-rgb),1);
  background: rgba(var(--accent-rgb),0.12);
  border-color: rgba(var(--accent-rgb),0.3);
}
.modal-tab-body { display: none; }
.modal-tab-body.active { display: block; }

/* â”€â”€ EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.edit-preview {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 12px; margin-bottom: 12px;
  display: flex; align-items: center; gap: 10px;
}
.preview-swatch {
  width: 40px; height: 40px; border-radius: var(--r-sm);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.preview-name { font-size: 13px; font-weight: 600; }
.preview-meta { font-size: 11px; color: var(--text3); }

.icon-grid { display: flex; flex-wrap: wrap; gap: 4px; }
.icon-btn {
  width: 36px; height: 36px; border-radius: var(--r-sm);
  font-size: 18px; background: var(--surface); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.icon-btn:hover { background: var(--surface2); border-color: var(--border2); }
.icon-btn.active { background: rgba(var(--accent-rgb),0.15); border-color: rgba(var(--accent-rgb),0.4); }

.color-swatches { display: flex; flex-wrap: wrap; gap: 6px; }
.color-swatch {
  width: 26px; height: 26px; border-radius: 50%;
  cursor: pointer; transition: all 0.15s;
  border: 2px solid transparent;
}
.color-swatch:hover { transform: scale(1.15); }
.color-swatch.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 0 0 2px rgba(255,255,255,0.3); }

.task-edit-row {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 4px; border-radius: var(--r-sm);
  transition: background 0.15s;
}
.task-edit-row:hover { background: var(--glass); }
.task-status-btn {
  font-size: 12px; padding: 2px 6px; border-radius: 4px;
  background: var(--surface); border: 1px solid var(--border);
  font-size: 10px; cursor: pointer; flex-shrink: 0; transition: all 0.15s;
}
.task-edit-input {
  flex: 1; background: transparent; border: none; color: var(--text);
  font-size: 12px; font-family: var(--font); outline: none;
  padding: 2px 4px; border-radius: 4px;
}
.task-edit-input:focus { background: var(--glass); }

.tag-list { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
.tag {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 8px; border-radius: 20px;
  font-size: 10px; font-weight: 600;
}
.tag-remove {
  background: none; border: none; font-size: 12px; line-height: 1;
  cursor: pointer; opacity: 0.6; transition: opacity 0.15s; padding: 0;
}
.tag-remove:hover { opacity: 1; }

/* â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
  display: inline-flex; align-items: center; gap: 2px;
  padding: 2px 7px; border-radius: 10px;
  font-size: 9px; font-weight: 700; letter-spacing: 0.03em;
}
.badge-prio-critical { background: rgba(239,68,68,0.15); color: #f87171; }
.badge-prio-high { background: rgba(249,115,22,0.15); color: #fb923c; }
.badge-prio-medium { background: rgba(234,179,8,0.15); color: #facc15; }
.badge-prio-low { background: rgba(34,197,94,0.15); color: #4ade80; }
.badge-due-late { background: rgba(239,68,68,0.15); color: #f87171; }
.badge-due-soon { background: rgba(245,158,11,0.15); color: #fcd34d; }
.badge-due-ok { background: rgba(34,197,94,0.1); color: var(--text3); }

/* â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-section {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 16px;
  margin-bottom: 12px;
}
.settings-section-title {
  font-size: 12px; font-weight: 700; color: var(--text);
  letter-spacing: 0.05em; margin-bottom: 14px;
  display: flex; align-items: center; gap: 6px;
}
.settings-note {
  font-size: 12px; padding: 10px 12px; border-radius: var(--r-sm);
  margin-bottom: 12px; line-height: 1.6;
}
.settings-note.warn { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); color: #fcd34d; }
.settings-note.info { background: rgba(14,165,233,0.08); border: 1px solid rgba(14,165,233,0.2); color: #7dd3fc; }
.account-badge {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; background: rgba(34,197,94,0.08);
  border: 1px solid rgba(34,197,94,0.2); border-radius: var(--r);
  margin-bottom: 14px;
}
.account-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #4f46e5);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0;
}

/* â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-banner {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.detail-banner-inner {
  display: flex; align-items: center; gap: 12px;
}
.detail-icon { font-size: 32px; }
.detail-name { font-size: 18px; font-weight: 800; color: var(--text); }
.detail-meta { font-size: 12px; color: var(--text2); margin-top: 2px; }

/* â”€â”€ ENHANCED TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.task-row {
  display: flex; align-items: center; gap: 7px; padding: 6px 4px;
  border-radius: var(--r-sm); transition: background 0.15s;
}
.task-row:hover { background: var(--glass); }
.task-status-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  border: 1.5px solid currentColor; cursor: pointer; transition: all 0.2s;
}
.task-done .task-status-dot { background: currentColor; }
.task-row-text { flex: 1; font-size: 12px; cursor: pointer; }
.task-done .task-row-text { text-decoration: line-through; color: var(--text3); }
.task-prio-badge {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.subtasks-indent { padding-left: 20px; }
.subtask-row {
  display: flex; align-items: center; gap: 6px;
  padding: 3px 4px; font-size: 11px; color: var(--text2);
}

/* â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.confetti-piece {
  position: fixed; z-index: 99999; pointer-events: none;
  width: 8px; height: 8px;
  animation: confettiFall 1.2s ease-in forwards;
}
@keyframes confettiFall {
  0%   { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* â”€â”€ PORTAL DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.portal-dropdown {
  position: fixed; z-index: 9000;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 4px;
  box-shadow: 0 16px 40px rgba(0,0,0,0.6);
  min-width: 160px; animation: dropIn 0.15s ease;
}
@keyframes dropIn { from { opacity: 0; transform: scale(0.95) translateY(-4px); } to { opacity: 1; transform: none; } }
.dropdown-item {
  display: flex; align-items: center; gap: 8px;
  width: 100%; padding: 8px 10px; border-radius: var(--r-sm);
  font-size: 12px; font-weight: 500; color: var(--text2);
  background: none; border: none; cursor: pointer; text-align: left;
  transition: all 0.15s; font-family: var(--font);
}
.dropdown-item:hover { background: var(--glass2); color: var(--text); }
.dropdown-item.active { color: rgba(var(--accent-rgb),1); background: rgba(var(--accent-rgb),0.1); }
.dropdown-item.danger { color: #fca5a5; }
.dropdown-item.danger:hover { background: rgba(239,68,68,0.1); }
.dropdown-sep {
  height: 1px; background: var(--border); margin: 4px 0;
}

/* â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view-hidden { display: none !important; }
.modal-wide { max-width: 700px; }
.mobile-only { display: none; }
.desktop-only { display: flex; }
.all-projects-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap: 10px;
}
.all-proj-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 12px; cursor: pointer;
  transition: all 0.18s;
}
.all-proj-card:hover { background: var(--surface2); }
.sp-notes-quick {
  background: var(--glass); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 8px 10px;
  font-size: 12px; color: var(--text2); font-family: var(--mono);
  cursor: pointer; transition: all 0.15s;
  max-height: 60px; overflow: hidden;
}
.sp-notes-quick:hover { background: var(--glass2); }
.template-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 12px; cursor: pointer;
  transition: all 0.18s;
}
.template-card:hover { background: var(--surface2); border-color: rgba(var(--accent-rgb),0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” TABLET 640px+
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 640px) {
  .slots-grid { grid-template-columns: repeat(2, 1fr); }
  .quick-stats-grid { grid-template-columns: repeat(4, 1fr); }
  .completed-grid { grid-template-columns: repeat(2, 1fr); }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .modal { border-radius: var(--r-xl); max-height: 85vh; }
  .modal-bg { align-items: center; padding: 20px; }
  .btn-text { display: inline; }
  .kbd-hints { display: flex; }
  .auth-card-inner { padding: 44px 42px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” DESKTOP 900px+
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 900px) {
  :root { --header-h: 58px; }

  /* Show sidebar always on desktop */
  .sidebar {
    width: var(--sidebar-w) !important;
    position: static !important;
    z-index: auto;
  }
  .sidebar-overlay { display: none !important; }
  #btn-menu-sidebar { display: none !important; }

  /* Hide mobile nav & FAB */
  .mobile-nav { display: none !important; }
  .mobile-fab { display: none !important; }
  .mobile-only { display: none !important; }

  /* Show desktop new project button */
  #btn-new-desktop { display: inline-flex !important; }
  .btn-text { display: inline; }
  .kbd-hints { display: flex; }

  .main-area { padding: 20px 24px 24px; }
  .slots-grid { grid-template-columns: repeat(3, 1fr); }
  .quick-stats-grid { grid-template-columns: repeat(4, 1fr); }
  .completed-grid { grid-template-columns: repeat(2, 1fr); }
  .stats-grid { grid-template-columns: repeat(4, 1fr); }

  /* Toast above header */
  .toast-container { bottom: 24px; right: 24px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” MOBILE <640px tweaks
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 639px) {
  .mobile-only { display: block !important; }
  #btn-new-desktop { display: none !important; }
  .header-actions .sync-badge { display: none; }
  .logo-sub { display: none; }
  .auth-card-inner { padding: 32px 22px 28px; }
  .auth-logo-ring { width: 68px; height: 68px; }
  .auth-logo-icon { font-size: 28px; }
  .auth-app-name { font-size: 20px; }
  .form-row { flex-direction: column; gap: 0; }
  .form-row .form-group { margin-bottom: 12px; }
}

/* Mobile sidebar (slide from left) */
@media (max-width: 899px) {
  .sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    z-index: 200;
  }
  .sidebar.open ~ .sidebar-overlay,
  .sidebar-overlay.show { display: block; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1: SETUP (first time)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-setup" class="auth-screen">
  <div class="auth-grid"></div>
  <div class="auth-orbs" id="login-orbs"></div>
  <div class="auth-card">
    <div class="auth-card-inner">
      <div class="auth-logo">
        <div class="auth-logo-ring">
          <div class="auth-logo-icon">ğŸ—‚</div>
        </div>
        <div class="auth-app-name">ProjectFlow</div>
        <div class="auth-tagline">
          <div class="auth-status-dot setup"></div>
          <span>PremiÃ¨re connexion</span>
        </div>
      </div>
      <div class="auth-banner">
        <div class="auth-banner-icon">ğŸ”</div>
        <div><strong>Bienvenue !</strong> CrÃ©ez votre accÃ¨s personnel. Vous serez le <em>seul</em> utilisateur de cette application.</div>
      </div>
      <div id="setup-error" class="auth-error"></div>
      <div class="auth-field">
        <span class="auth-field-icon">ğŸ‘¤</span>
        <input class="auth-input" id="setup-username" placeholder="Votre prÃ©nom ou pseudo"
          autocomplete="username" onkeydown="if(event.key==='Enter')document.getElementById('setup-password').focus()">
      </div>
      <div class="auth-field">
        <span class="auth-field-icon">ğŸ”‘</span>
        <input class="auth-input" type="password" id="setup-password" placeholder="Mot de passe (min 6 caractÃ¨res)"
          autocomplete="new-password" onkeydown="if(event.key==='Enter')document.getElementById('setup-confirm').focus()">
      </div>
      <div class="auth-field">
        <span class="auth-field-icon">ğŸ”’</span>
        <input class="auth-input" type="password" id="setup-confirm" placeholder="Confirmer le mot de passe"
          autocomplete="new-password" onkeydown="if(event.key==='Enter')doSetup()">
      </div>
      <button class="auth-btn" onclick="doSetup()" id="setup-btn">âœ¨ CrÃ©er mon espace</button>
      <div class="auth-badge">
        <span>ğŸ”’ SHA-256</span>
        <span>ğŸ’¾ Stockage local</span>
        <span>ğŸš« Utilisateur unique</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2: LOGIN (returning user)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="auth-screen">
  <div class="auth-grid"></div>
  <div class="auth-orbs"></div>
  <div class="auth-card">
    <div class="auth-card-inner">
      <div class="auth-logo">
        <div class="auth-logo-ring">
          <div class="auth-logo-icon">ğŸ—‚</div>
        </div>
        <div class="auth-app-name">ProjectFlow</div>
        <div class="auth-tagline">
          <div class="auth-status-dot"></div>
          <span id="login-welcome">Bon retour !</span>
        </div>
      </div>
      <div id="login-error" class="auth-error"></div>
      <div id="login-attempts" class="auth-attempts"></div>
      <div class="auth-field">
        <span class="auth-field-icon">ğŸ”‘</span>
        <input class="auth-input" type="password" id="login-password"
          placeholder="Mot de passe" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="auth-btn" onclick="doLogin()" id="login-btn">ğŸ” DÃ©verrouiller</button>
      <div class="auth-hint" id="login-hint">AccÃ¨s protÃ©gÃ© â€” utilisateur unique</div>
      <div class="auth-badge">
        <span>ğŸ”’ SHA-256</span>
        <span>ğŸ’¾ Stockage local</span>
        <span>ğŸš« Utilisateur unique</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3: GITHUB TOKEN (one-time)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-token" class="auth-screen">
  <div class="auth-grid"></div>
  <div class="auth-orbs"></div>
  <div class="auth-card" style="max-width:460px">
    <div class="auth-card-inner">
      <div class="auth-logo">
        <div style="font-size:44px;margin-bottom:14px">ğŸ”—</div>
        <div class="auth-app-name">Synchronisation GitHub</div>
        <div class="auth-tagline">
          <div class="auth-status-dot"></div>
          <span>Configuration unique</span>
        </div>
      </div>
      <div class="auth-banner">
        <div class="auth-banner-icon">ğŸ›¡ï¸</div>
        <div>Votre token sera stockÃ© <strong>uniquement sur cet appareil</strong>. Il ne sera jamais Ã©crit dans le code.</div>
      </div>
      <div id="token-error" class="auth-error"></div>
      <div style="margin-bottom:8px">
        <div class="form-label" style="margin-bottom:5px">Token GitHub (classic)</div>
        <div class="auth-field" style="margin-bottom:0">
          <span class="auth-field-icon">ğŸ”‘</span>
          <input class="auth-input" type="password" id="setup-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        </div>
        <div style="font-size:10px;color:var(--text3);margin-top:4px">Settings â†’ Developer settings â†’ Tokens â†’ scope <code>repo</code></div>
      </div>
      <div class="form-row" style="gap:10px;margin-bottom:10px">
        <div style="flex:1">
          <div class="form-label" style="margin-bottom:5px">Username GitHub</div>
          <div class="auth-field" style="margin-bottom:0">
            <span class="auth-field-icon">ğŸ‘¤</span>
            <input class="auth-input" id="setup-owner" placeholder="votre-username" autocomplete="off">
          </div>
        </div>
        <div style="flex:1">
          <div class="form-label" style="margin-bottom:5px">Nom du repo</div>
          <div class="auth-field" style="margin-bottom:0">
            <span class="auth-field-icon">ğŸ“</span>
            <input class="auth-input" id="setup-repo" placeholder="nom-du-repo" autocomplete="off"
              onkeydown="if(event.key==='Enter')saveTokenSetup()">
          </div>
        </div>
      </div>
      <button class="auth-btn" onclick="saveTokenSetup()" id="token-btn">âœ… Connecter GitHub</button>
      <a href="#" class="auth-skip" onclick="skipTokenSetup();return false">
        Passer â€” utiliser en local sans synchronisation â†’
      </a>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-wrapper" id="app">

  <!-- â”€â”€ HEADER â”€â”€ -->
  <header class="app-header">
    <button class="btn btn-icon mobile-only" id="btn-menu-sidebar" onclick="toggleSidebar()" style="display:none">â˜°</button>
    <div class="logo">
      <div class="logo-icon">ğŸ—‚</div>
      <div>
        <div class="logo-text">ProjectFlow</div>
        <div class="logo-sub" id="quote-text">Chargement...</div>
      </div>
    </div>
    <div class="header-spacer"></div>
    <div class="header-actions">
      <div class="sync-badge" id="sync-badge" onclick="openSettings()" title="ParamÃ¨tres sync">
        <div class="sync-dot idle" id="sync-dot"></div>
        <span id="sync-label" style="font-size:11px">Local</span>
        <span id="user-label"></span>
        <div style="font-size:9px;color:var(--text3)" id="sync-time"></div>
      </div>
      <button class="btn btn-icon" onclick="openSettings()" title="ParamÃ¨tres">âš™</button>
      <button class="btn btn-icon" onclick="doUndo()" id="undo-btn" title="Annuler (Ctrl+Z)" style="opacity:0.4">â†©</button>
      <button class="btn" onclick="showExportMenu(event)" title="Export">ğŸ“¥ <span class="btn-text">Export</span></button>
      <button class="btn btn-primary" onclick="openNew()" id="btn-new-desktop" style="display:none">
        + Projet
      </button>
    </div>
  </header>

  <!-- â”€â”€ BODY â”€â”€ -->
  <div class="app-body">

    <!-- Sidebar overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- â”€â”€ SIDEBAR â”€â”€ -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-topbar">
          <div class="sidebar-title">
            ğŸ“‹ Projets
            <span class="count-badge" id="backlog-count">0</span>
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-icon" onclick="toggleFilters()" title="Filtres">âš™</button>
            <button class="btn btn-icon" onclick="openTemplates()" title="Templates">ğŸ“„</button>
            <button class="btn btn-icon" onclick="toggleArchived()" title="ArchivÃ©s">ğŸ“¦</button>
          </div>
        </div>
        <div class="sidebar-cat-section" id="cat-filter-section">
          <div class="sidebar-cat-title">
            CatÃ©gories
            <button onclick="openCategoryManager()" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:11px" title="GÃ©rer">âš™</button>
          </div>
          <div class="cats-filter-row" id="cats-filter-row"></div>
        </div>
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input class="input" id="search-input" placeholder="Rechercher..." oninput="renderBacklog()" autocomplete="off">
          <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none">Ã—</button>
        </div>
        <div id="filters-panel" style="display:none" class="sidebar-filters">
          <div>
            <label class="form-label">Tri</label>
            <select class="input" id="sort-select" onchange="renderBacklog()" style="font-size:11px;padding:5px 28px 5px 8px">
              <option value="createdAt">Plus rÃ©cent</option>
              <option value="name">Nom Aâ†’Z</option>
              <option value="priority">PrioritÃ©</option>
              <option value="progress">Progression</option>
              <option value="dueDate">Date limite</option>
            </select>
          </div>
          <div>
            <label class="form-label">PrioritÃ©</label>
            <div class="filter-row" id="filter-priority-row"></div>
          </div>
          <div id="filter-tags-section" style="display:none">
            <label class="form-label">Tags</label>
            <div class="filter-row" id="filter-tags-row"></div>
          </div>
          <div style="display:flex;gap:4px;margin-top:2px">
            <button class="btn" style="flex:1;font-size:10px" onclick="toggleCompact()">
              <span id="compact-label">ğŸ“‹ Confortable</span>
            </button>
            <button class="btn" style="font-size:10px" onclick="resetFilters()">RÃ©initialiser</button>
          </div>
        </div>
      </div>

      <div class="sidebar-list" id="backlog-list"
        ondragover="event.preventDefault();setDragOver('backlog')"
        ondragleave="clearDragOver()"
        ondrop="handleDrop(event,'backlog')">
        <button class="sidebar-add-btn" onclick="openNew()">
          + Nouveau projet <span style="opacity:0.4;font-size:10px">(Ctrl+N)</span>
        </button>
        <div id="backlog-cards"></div>
      </div>

      <div id="sidebar-footer"></div>
    </aside>

    <!-- â”€â”€ MAIN â”€â”€ -->
    <main class="main-area" id="main-area">

      <!-- Board view -->
      <div id="view-board">
        <!-- Habits -->
        <div class="habits-card" id="habits-widget">
          <div class="habits-header">
            <div class="habits-title">
              ğŸŒ¿ Habitudes du jour
              <span class="count-badge" id="habits-streak-badge" style="display:none"></span>
            </div>
            <div style="display:flex;gap:4px">
              <button class="btn btn-icon" style="font-size:11px;width:28px;height:28px" onclick="addHabitPrompt()" title="Ajouter">+</button>
              <button class="btn btn-icon" style="font-size:11px;width:28px;height:28px" onclick="toggleHabitsWidget()" id="habits-collapse-btn" title="RÃ©duire">âˆ’</button>
            </div>
          </div>
          <div id="habits-body"></div>
        </div>
        <!-- Active slots -->
        <div class="section-header">
          <div class="section-title">âš¡ Projets actifs <span style="font-size:11px;color:var(--text3);font-weight:400">Max 3</span></div>
          <button class="btn" onclick="openSlotNamesEditor()" style="font-size:11px">âœ Nommer les slots</button>
        </div>
        <div class="slots-grid" id="slots-grid"></div>
        <!-- Quick stats -->
        <div class="quick-stats-grid" id="quick-stats-bar"></div>
        <!-- Keyboard hints (desktop only) -->
        <div class="kbd-hints" id="kbd-hints">
          <span><kbd class="kbd">Ctrl+N</kbd> Nouveau projet</span>
          <span><kbd class="kbd">Ctrl+Z</kbd> Annuler</span>
          <span>ğŸ–± Glisser vers slots</span>
        </div>
      </div>

      <!-- Completed view -->
      <div id="view-completed" class="view-hidden">
        <div class="section-header">
          <div class="section-title">ğŸ† Projets terminÃ©s</div>
          <button class="btn btn-danger" onclick="confirmClearCompleted()" style="font-size:11px">Vider tout</button>
        </div>
        <div id="completed-grid" class="completed-grid"></div>
        <div id="completed-empty" style="text-align:center;padding:60px 20px;color:var(--text3);display:none">
          <div style="font-size:48px;margin-bottom:12px">ğŸ†</div>
          <p style="font-size:14px">Aucun projet terminÃ©.<br>Terminez un projet actif pour le voir ici !</p>
        </div>
      </div>

      <!-- Stats view -->
      <div id="view-stats" class="view-hidden">
        <div class="section-title" style="margin-bottom:16px">ğŸ“Š Tableau de bord</div>
        <div class="stats-grid" id="stats-grid"></div>
        <div class="divider"></div>
        <div class="section-title" style="margin-bottom:12px">ğŸ“ Tous les projets actifs</div>
        <div id="all-projects-overview" class="all-projects-grid"></div>
      </div>

    </main>
  </div><!-- end app-body -->

  <!-- â”€â”€ MOBILE NAV â”€â”€ -->
  <nav class="mobile-nav">
    <div class="mobile-nav-inner">
      <button class="nav-item active" id="nav-list" onclick="setMobileView('list')">
        <span>ğŸ“‹</span>Liste
      </button>
      <button class="nav-item" id="nav-board" onclick="setMobileView('board')">
        <span>âš¡</span>Actifs
      </button>
      <button class="nav-item" id="nav-done" onclick="setMobileView('completed')">
        <span>ğŸ†</span>TerminÃ©s
      </button>
      <button class="nav-item" id="nav-stats" onclick="setMobileView('stats')">
        <span>ğŸ“Š</span>Stats
      </button>
      <button class="nav-item" id="nav-settings" onclick="openSettings()">
        <span>âš™</span>RÃ©glages
      </button>
    </div>
  </nav>
  <button class="mobile-fab" onclick="openNew()">ï¼‹</button>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

</div><!-- end app-wrapper -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

'use strict';

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB_FILENAME = 'database.json';
const LS_KEY = 'pf_local_v2';
const LS_GITHUB_KEY = 'pf_github';

const COLORS = ['#7c3aed','#4f46e5','#0ea5e9','#06b6d4','#10b981','#22c55e','#84cc16','#eab308','#f97316','#ef4444','#f43f5e','#ec4899','#a855f7','#8b5cf6','#6366f1'];
const ICONS = ['ğŸš€','ğŸ’¡','ğŸ¯','ğŸ“š','ğŸ’¼','ğŸ¨','ğŸ”§','ğŸŒ±','âš¡','ğŸ†','ğŸµ','ğŸ”¬','ğŸŒ','ğŸ’ª','âœ¨','ğŸ§ ','â¤ï¸','ğŸ”¥','ğŸŒŸ','ğŸ­','ğŸ¦‹','ğŸŒŠ','ğŸª','ğŸ—ï¸','ğŸ²','ğŸ“','ğŸ‹ï¸','ğŸ¹','ğŸ“±','ğŸ–¥ï¸'];
const PRIO = {
  critical: { label:'Critique', dot:'ğŸ”´', bgClass:'badge-pri-critical' },
  high:     { label:'Ã‰levÃ©',    dot:'ğŸŸ ', bgClass:'badge-pri-high'     },
  medium:   { label:'Moyen',    dot:'ğŸŸ¡', bgClass:'badge-pri-medium'   },
  low:      { label:'Faible',   dot:'ğŸŸ¢', bgClass:'badge-pri-low'      }
};
const SLOT_INFO = {
  primary:   { emoji:'ğŸ¯', label:'Primaire',   desc:'Votre prioritÃ© absolue' },
  secondary: { emoji:'âš¡', label:'Secondaire', desc:'Important mais flexible' },
  pleasure:  { emoji:'ğŸ˜Š', label:'Plaisir',    desc:'Pour la joie crÃ©ative' }
};
const TEMPLATES = [
  { name:'App / Web', icon:'ğŸ”§', color:'#6366f1', tags:['dev','tech'],     tasks:['Setup & config','Design UI','Dev backend','Tests','DÃ©ploiement'] },
  { name:'CrÃ©atif',   icon:'ğŸ¨', color:'#ec4899', tags:['crÃ©atif','art'],   tasks:['Brainstorm','Maquettes','CrÃ©ation','RÃ©vision','Finalisation'] },
  { name:'Apprentissage',icon:'ğŸ“š',color:'#22c55e',tags:['learning'],      tasks:['Objectifs','Ressources','Pratiquer','Notes','RÃ©vision'] },
  { name:'Sport',     icon:'ğŸ’ª', color:'#f97316', tags:['santÃ©','sport'],   tasks:['Programme','Semaine 1','Semaine 2','Semaine 3','Ã‰valuation'] },
  { name:'Business',  icon:'ğŸ’¼', color:'#0ea5e9', tags:['business','pro'],  tasks:['MarchÃ©','ModÃ¨le Ã©co','Marketing','Finance','Pitch'] },
  { name:'Musique',   icon:'ğŸµ', color:'#a855f7', tags:['music','crÃ©atif'], tasks:['Concept','Enregistrement','Mixage','Artwork','Publication'] },
  { name:'Voyage',    icon:'ğŸŒ', color:'#14b8a6', tags:['perso','voyage'],  tasks:['Destinations','Billets','HÃ©bergement','ActivitÃ©s','Packing'] },
  { name:'Recherche', icon:'ğŸ”¬', color:'#8b5cf6', tags:['research','pro'],  tasks:['Sujet','Sources','Analyse','RÃ©daction','RÃ©vision'] },
];
const QUOTES = [
  'La constance bat le talent quand il ne travaille pas.',
  'Un projet commencÃ© est Ã  moitiÃ© fini.',
  'Le secret, c\'est de commencer.',
  'Focus sur le progrÃ¨s, pas la perfection.',
  'Petits pas, grandes victoires.',
  'Chaque jour est une nouvelle opportunitÃ©.',
  'Un objectif sans plan est juste un souhait.',
  'La discipline est le pont entre les objectifs et les rÃ©sultats.',
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  projects: [],
  slots: { primary: null, secondary: null, pleasure: null },
  completedProjects: [],
  categories: [
    { id: 'cat_general', name: 'GÃ©nÃ©ral', color: '#6366f1', icon: 'ğŸ“' },
    { id: 'cat_tech', name: 'Tech / Dev', color: '#0ea5e9', icon: 'ğŸ’»' },
    { id: 'cat_creative', name: 'CrÃ©atif', color: '#ec4899', icon: 'ğŸ¨' },
    { id: 'cat_learning', name: 'Apprentissage', color: '#22c55e', icon: 'ğŸ“š' },
    { id: 'cat_perso', name: 'Personnel', color: '#f97316', icon: 'ğŸ ' },
  ],
  habits: [],
  habitLog: {},
  settings: {
    accent: '#7c3aed',
    compact: false,
    slotNames: { primary: 'Primaire', secondary: 'Secondaire', pleasure: 'Plaisir' },
    timerDefault: { mode: 'countdown', h: 0, m: 25, s: 0 },
    habitsCollapsed: false
  }
};
let filterActive = { priority: '', tags: [], archived: false, category: '' };
let undoStack = [];
let timers = {};
let github = { token: '', owner: '', repo: '', sha: null };
let syncStatus = 'idle';
let draggedId = null, dragFrom = null, dragOverZone = null;
let mobileView = 'board';
let openDropdown = null;
let activeModalBg = null;
let saveTimeout = null;
let lastSaveTime = null;
let broadcastChannel = null;
let touchDragId = null, touchGhost = null, touchDragOver = null;

const uid = () => Math.random().toString(36).slice(2,11) + Date.now().toString(36);
const fmtDate = d => d ? new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}) : '';
const fmtDateTime = d => d ? new Date(d).toLocaleString('fr-FR',{day:'2-digit',month:'short',year:'numeric'}) : '';
const daysUntil = d => d ? Math.ceil((new Date(d) - Date.now()) / 86400000) : null;
const clamp = (v,min,max) => Math.max(min, Math.min(max,v));
const proj = id => state.projects.find(p => p.id === id) || state.completedProjects.find(p => p.id === id);
const progress = p => p.tasks.length ? Math.round(p.tasks.filter(t=>t.done).length/p.tasks.length*100) : 0;
const isOverdue = p => p.dueDate && new Date(p.dueDate) < new Date() && !p.completed && !p.archived;
const getCat = id => state.categories.find(c=>c.id===id);

// â”€â”€ AUTH SYSTEM â€” SINGLE USER, LOCKED FOREVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Once account is created, NO NEW ACCOUNT can EVER be created.
// Wrong password â†’ attempt counter â†’ 30s lockout after 5 fails.

const LS_AUTH_KEY = 'pf_auth_v1';
const LS_LOCK_KEY = 'pf_lock_v1';
const MAX_ATTEMPTS = 5;
const LOCKOUT_MS   = 30_000;
// Both salts supported so old accounts still work
const SALTS = ['pf_salt_projectflow_2024', 'pf_salt_2024'];

async function hashPwd(pwd, salt = SALTS[0]) {
  const enc = new TextEncoder().encode(pwd + salt);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function getAuth() {
  try { return JSON.parse(localStorage.getItem(LS_AUTH_KEY)) || null; } catch(e) { return null; }
}
function getLock() {
  try { return JSON.parse(localStorage.getItem(LS_LOCK_KEY)) || { attempts:0, until:0 }; } catch(e) { return { attempts:0, until:0 }; }
}
function saveLock(l) { localStorage.setItem(LS_LOCK_KEY, JSON.stringify(l)); }
function clearLock() { localStorage.removeItem(LS_LOCK_KEY); }
function isLocked() { return getLock().until > Date.now(); }

function recordFailedAttempt() {
  const l = getLock();
  l.attempts = (l.attempts || 0) + 1;
  if (l.attempts >= MAX_ATTEMPTS) { l.until = Date.now() + LOCKOUT_MS; l.attempts = 0; }
  saveLock(l);
  return getLock();
}

// â”€â”€ MAIN LOGIN HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ AUTH â€” STATE MACHINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Screens: "setup" (first time) | "login" (returning) | "token" (github once)
// Use showScreen(name) to navigate â€” never touch display manually elsewhere.

function showScreen(name) {
  ['screen-setup','screen-login','screen-token'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === 'screen-' + name) ? 'flex' : 'none';
  });
  document.getElementById('app').style.display = 'none';
  spawnLoginOrbs();
}

function hideScreens() {
  ['screen-setup','screen-login','screen-token'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
}

// Called by init() â€” decides which screen to show
function showLoginScreen() {
  const auth = getAuth();
  if (!auth) {
    // No account yet â€” show SETUP form
    showScreen('setup');
  } else {
    // Account exists â€” show LOGIN form
    const dot = document.getElementById('login-lock-dot');
    if (dot) dot.className = 'login-lock-dot';
    const welcome = document.getElementById('login-welcome');
    if (welcome) welcome.textContent = 'Bon retour, ' + auth.username + ' !';
    const hint = document.getElementById('login-hint');
    if (hint) hint.textContent = 'AccÃ¨s protÃ©gÃ© â€” utilisateur unique';
    updateAttemptsUI();
    if (isLocked()) startLockCountdown();
    showScreen('login');
    setTimeout(() => document.getElementById('login-password')?.focus(), 150);
  }
}

// â”€â”€ FIRST TIME: create account â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSetup() {
  const username = (document.getElementById('setup-username')?.value || '').trim();
  const password = document.getElementById('setup-password')?.value || '';
  const confirm  = document.getElementById('setup-confirm')?.value  || '';
  if (!username) { showError('setup-error', 'Choisissez un nom'); return; }
  if (password.length < 6) { showError('setup-error', 'Minimum 6 caractÃ¨res'); return; }
  if (password !== confirm) { showError('setup-error', 'Les mots de passe ne correspondent pas'); return; }
  const btn = document.getElementById('setup-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'â³'; }
  const hash = await hashPwd(password, SALTS[0]);
  localStorage.setItem(LS_AUTH_KEY, JSON.stringify({ username, hash, salt: SALTS[0], createdAt: new Date().toISOString(), single: true }));
  clearLock();
  if (btn) { btn.classList.remove('loading'); btn.textContent = 'âœ¨ CrÃ©er mon espace'; btn.disabled = false; }
  launchApp(username);
}

// â”€â”€ RETURNING USER: login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const auth = getAuth();
  if (!auth) { showLoginScreen(); return; } // safety: should never happen
  if (isLocked()) {
    const secs = Math.ceil((getLock().until - Date.now()) / 1000);
    showError('login-error', 'Compte verrouillÃ© â€” rÃ©essayez dans ' + secs + 's');
    return;
  }
  const password = document.getElementById('login-password')?.value || '';
  if (!password) { showError('login-error', 'Saisissez votre mot de passe'); return; }
  const btn = document.getElementById('login-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'â³'; }
  const saltToUse = auth.salt || SALTS[0];
  const hash = await hashPwd(password, saltToUse);
  // Also try other salts for compat
  let loginOk = hash === auth.hash;
  if (!loginOk) { for (const s of SALTS) { if (s !== saltToUse && await hashPwd(password, s) === auth.hash) { loginOk = true; break; } } }
  if (btn) { btn.classList.remove('loading'); btn.textContent = 'ğŸ” DÃ©verrouiller'; }
  if (!loginOk) {
    recordFailedAttempt();
    const l = getLock();
    if (l.until > Date.now()) {
      showError('login-error', 'âŒ Trop de tentatives â€” verrouillÃ© 30s');
      startLockCountdown();
    } else {
      const left = MAX_ATTEMPTS - (l.attempts || 0);
      showError('login-error', 'Mot de passe incorrect' + (left > 0 ? ' (' + left + ' essai(s) restant(s))' : ''));
      updateAttemptsUI();
    }
    document.getElementById('login-password').value = '';
    document.getElementById('login-password').focus();
    return;
  }
  clearLock();
  launchApp(auth.username);
}

function showError(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = 'loginErrShake 0.3s ease';
  setTimeout(() => { if (el) el.style.display = 'none'; }, 4500);
}
// alias for old code using showLoginError
function showLoginError(msg) { showError('login-error', msg); }

function startLockCountdown() {
  const el = document.getElementById('login-attempts');
  if (!el) return;
  const tick = () => {
    const secs = Math.ceil((getLock().until - Date.now()) / 1000);
    if (secs <= 0) { el.style.display = 'none'; updateAttemptsUI(); return; }
    el.style.display = 'flex';
    el.textContent = 'ğŸ”’ VerrouillÃ© â€” rÃ©essayez dans ' + secs + 's';
    setTimeout(tick, 1000);
  };
  tick();
}

function updateAttemptsUI() {
  const l  = getLock();
  const el = document.getElementById('login-attempts');
  if (!el) return;
  if (l.attempts > 0) { el.style.display = 'flex'; el.textContent = 'âš ï¸ ' + l.attempts + '/' + MAX_ATTEMPTS + ' tentatives incorrectes'; }
  else { el.style.display = 'none'; }
}

// â”€â”€ LAUNCH: after login, check if GitHub token needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchApp(username) {
  hideScreens();
  const lbl = document.getElementById('user-label');
  if (lbl) lbl.textContent = username;
  const ghStr = localStorage.getItem(LS_GITHUB_KEY);
  if (!ghStr) {
    showScreen('token');
    setTimeout(() => document.getElementById('setup-token')?.focus(), 150);
  } else {
    document.getElementById('app').style.display = 'flex';
    loadAndRender();
  }
}

function skipTokenSetup() {
  localStorage.setItem(LS_GITHUB_KEY, JSON.stringify({ token:'', owner:'', repo:'' }));
  hideScreens();
  document.getElementById('app').style.display = 'flex';
  loadAndRender();
}

async function saveTokenSetup() {
  const token = (document.getElementById('setup-token')?.value || '').trim();
  const owner = (document.getElementById('setup-owner')?.value || '').trim();
  const repo  = (document.getElementById('setup-repo')?.value  || '').trim();
  if (!token || !owner || !repo) { showError('token-error', 'Remplissez les 3 champs.'); return; }
  const btn = document.getElementById('setup-btn');
  if (btn) { btn.textContent = 'â³ VÃ©rification...'; btn.disabled = true; }
  const errEl = document.getElementById('token-error');
  if (errEl) errEl.style.display = 'none';
  try {
    const r = await fetch('https://api.github.com/repos/' + owner + '/' + repo, {
      headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!r.ok) throw new Error('DÃ©pÃ´t introuvable ou token invalide (code ' + r.status + ')');
  } catch(e) {
    showError('token-error', 'âŒ ' + e.message);
    if (btn) { btn.textContent = 'âœ… Enregistrer et ouvrir l\'app'; btn.disabled = false; }
    return;
  }
  Object.assign(github, { token, owner, repo });
  localStorage.setItem(LS_GITHUB_KEY, JSON.stringify({ token, owner, repo }));
  if (btn) { btn.textContent = 'âœ… Enregistrer et ouvrir l\'app'; btn.disabled = false; }
  hideScreens();
  document.getElementById('app').style.display = 'flex';
  loadAndRender();
  setTimeout(() => toast('ğŸ”— GitHub connectÃ© !', 'success'), 800);
}

function spawnLoginOrbs() {
  const container = document.getElementById('login-orbs');
  if (!container || container.childElementCount > 0) return;
  const colors = ['rgba(124,58,237,0.15)','rgba(79,70,229,0.12)','rgba(14,165,233,0.1)','rgba(167,139,250,0.1)'];
  for (let i = 0; i < 6; i++) {
    const orb = document.createElement('div');
    const size = 30 + Math.random() * 60;
    orb.className = 'login-orb';
    orb.style.cssText = 'width:' + size + 'px;height:' + size + 'px;left:' + (Math.random()*100) + '%;background:radial-gradient(circle,' + colors[i%colors.length] + ',transparent);animation-duration:' + (8+Math.random()*12) + 's;animation-delay:' + (Math.random()*8) + 's;filter:blur(8px);';
    container.appendChild(orb);
  }
}


// â”€â”€ LOAD & RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAndRender() {
  try {
    broadcastChannel = new BroadcastChannel('projectflow_sync');
    broadcastChannel.onmessage = (e) => {
      if (e.data?.type === 'state_update') { applyData(e.data.data); renderAll(); toast('ğŸ”„ Sync entre onglets','info'); }
    };
  } catch(e) {}

  const ghStr = localStorage.getItem(LS_GITHUB_KEY);
  if (ghStr) try { Object.assign(github, JSON.parse(ghStr)); } catch(e) {}

  let loaded = false;
  if (github.token && github.owner && github.repo) {
    try { loaded = await syncFromGitHub(); } catch(e) {}
  }
  if (!loaded) {
    try {
      const r = await fetch('./database.json?t=' + Date.now());
      if (r.ok) { const d = await r.json(); applyData(d); loaded = true; setSyncStatus('synced'); }
    } catch(e) {}
  }
  if (!loaded) {
    try {
      const ls = localStorage.getItem(LS_KEY);
      if (ls) applyData(JSON.parse(ls));
    } catch(e) {}
    setSyncStatus('idle');
  }

  applyAccent(state.settings.accent || '#7c3aed');
  try { document.getElementById('quote-text').textContent = QUOTES[new Date().getDay() % QUOTES.length]; } catch(e) {}
  renderFilterPriority();
  renderCategoryFilters();
  renderAll();
  renderHeaderStats();
  setMobileView('board');

  setInterval(() => { if (github.token && github.owner && github.repo) saveData(); }, 5*60*1000);
  setInterval(updateSyncTime, 30000);
}

function newProject(overrides={}) {
  return {
    id: uid(), name: '', description: '', icon: ICONS[Math.floor(Math.random()*ICONS.length)],
    color: COLORS[Math.floor(Math.random()*COLORS.length)], tasks: [], tags: [],
    priority: 'medium', dueDate: '', notes: '', links: [],
    estimatedHours: 0, loggedHours: 0, pomodoroCount: 0,
    categoryId: 'cat_general',
    pinned: false, archived: false, completed: false,
    createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
    ...overrides
  };
}

function newTask(text='') {
  return { id: uid(), text, done: false, status: 'todo', priority: 'medium', rank: 0, subtasks: [], note: '', dueDate: '' };
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  document.addEventListener('keydown', onKeyDown);
  document.addEventListener('click', e => {
    if (openDropdown && !openDropdown.contains(e.target)) closeDropdown();
  });
  window.addEventListener('resize', onResize);
  showLoginScreen();
}

function applyData(d) {
  if (!d) return;
  if (Array.isArray(d.projects)) state.projects = d.projects;
  if (d.slots) state.slots = { primary:null, secondary:null, pleasure:null, ...d.slots };
  if (Array.isArray(d.completedProjects)) state.completedProjects = d.completedProjects;
  if (d.settings) state.settings = { ...state.settings, ...d.settings };
  if (Array.isArray(d.categories) && d.categories.length) state.categories = d.categories;
  if (Array.isArray(d.habits)) state.habits = d.habits;
  if (d.habitLog) state.habitLog = d.habitLog;
  if (!state.settings.slotNames) state.settings.slotNames = { primary:'Primaire', secondary:'Secondaire', pleasure:'Plaisir' };
  // Migrate old tasks to new format
  state.projects.forEach(p => {
    p.tasks = (p.tasks||[]).map(t => ({
      status: t.done ? 'done' : 'todo', priority: 'medium', rank: 0, subtasks: [], note: '', dueDate: '', ...t
    }));
    if (!p.categoryId) p.categoryId = 'cat_general';
  });
}

// â”€â”€ SYNC & SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dataSnapshot() {
  return {
    version: '3.0',
    lastUpdated: new Date().toISOString(),
    projects: state.projects,
    slots: state.slots,
    completedProjects: state.completedProjects,
    categories: state.categories,
    habits: state.habits,
    habitLog: state.habitLog,
    settings: state.settings
  };
}

function scheduleSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveData, 500);
}

async function saveData() {
  const data = dataSnapshot();
  const json = JSON.stringify(data, null, 2);
  try { localStorage.setItem(LS_KEY, json); } catch(e) {}
  lastSaveTime = new Date(); updateSyncTime();
  if (broadcastChannel) try { broadcastChannel.postMessage({ type:'state_update', data }); } catch(e) {}
  if (github.token && github.owner && github.repo) await saveToGitHub(json);
}


async function saveToGitHub(json) {
  setSyncStatus('syncing');
  try {
    // Get current SHA if not cached
    if (!github.sha) {
      const r = await fetch(`https://api.github.com/repos/${github.owner}/${github.repo}/contents/${DB_FILENAME}`, {
        headers: { 'Authorization': 'token ' + github.token, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (r.ok) { const d = await r.json(); github.sha = d.sha; }
    }
    const body = { message: 'ğŸ”„ ProjectFlow sync ' + new Date().toLocaleTimeString('fr-FR'), content: btoa(unescape(encodeURIComponent(json))), ...(github.sha ? { sha: github.sha } : {}) };
    const r2 = await fetch(`https://api.github.com/repos/${github.owner}/${github.repo}/contents/${DB_FILENAME}`, {
      method: 'PUT', headers: { 'Authorization': 'token ' + github.token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (r2.ok) {
      const d2 = await r2.json(); github.sha = d2.content.sha;
      setSyncStatus('synced');
    } else {
      const err = await r2.json();
      // SHA mismatch â†’ refetch
      if (r2.status === 409) { github.sha = null; await saveToGitHub(json); return; }
      setSyncStatus('error'); console.error('GitHub save error:', err);
    }
  } catch(e) { setSyncStatus('error'); console.error('GitHub sync error:', e); }
}

async function syncFromGitHub() {
  setSyncStatus('syncing');
  try {
    const r = await fetch(`https://api.github.com/repos/${github.owner}/${github.repo}/contents/${DB_FILENAME}`, {
      headers: { 'Authorization': 'token ' + github.token, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!r.ok) { setSyncStatus('error'); return false; }
    const d = await r.json();
    github.sha = d.sha;
    const json = decodeURIComponent(escape(atob(d.content.replace(/\n/g,''))));
    applyData(JSON.parse(json));
    setSyncStatus('synced');
    return true;
  } catch(e) { setSyncStatus('error'); return false; }
}

function pushUndo() {
  undoStack.push(JSON.parse(JSON.stringify({ projects:state.projects, slots:state.slots, completedProjects:state.completedProjects })));
  if (undoStack.length > 20) undoStack.shift();
  document.getElementById('undo-btn').style.opacity = '1';
}

function doUndo() {
  if (!undoStack.length) return;
  const snap = undoStack.pop();
  state.projects = snap.projects;
  state.slots = snap.slots;
  state.completedProjects = snap.completedProjects;
  if (!undoStack.length) document.getElementById('undo-btn').style.opacity = '0.4';
  renderAll(); scheduleSave(); toast('Action annulÃ©e â†©', 'info');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderBacklog();
  renderSlots();
  renderCompleted();
  renderStats();
  renderHeaderStats();
  updateAllProjectsOverview();
  renderQuickStats();
  renderHabits();
  renderCategoryFilters();
}

function renderHeaderStats() {
  const slotIds = Object.values(state.slots).filter(Boolean);
  const allTasks = state.projects.reduce((a,p)=>a+p.tasks.length,0);
  const doneTasks = state.projects.reduce((a,p)=>a+p.tasks.filter(t=>t.done).length,0);
  const pomos = state.projects.reduce((a,p)=>a+(p.pomodoroCount||0),0) + state.completedProjects.reduce((a,p)=>a+(p.pomodoroCount||0),0);
  const el = document.getElementById('header-stats');
  el.innerHTML = [
    { v: state.projects.length, l:'projets' },
    { v: `${slotIds.length}/3`, l:'actifs' },
    { v: `${doneTasks}/${allTasks}`, l:'tÃ¢ches' },
    { v: pomos, l:'ğŸ…' },
    { v: state.completedProjects.length, l:'terminÃ©s' },
  ].map(s => `<div class="hstat"><div class="hstat-val">${s.v}</div><div class="hstat-lbl">${s.l}</div></div>`).join('');
}

// â”€â”€ BACKLOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCategoryFilters() {
  const row = document.getElementById('cats-filter-row');
  if (!row) return;
  const chips = [{ id:'', name:'Tout', color:'var(--text3)', icon:'ğŸ“‹' }, ...state.categories].map(c =>
    `<button class="category-chip${filterActive.category===c.id?' active':''}" 
      style="background:${filterActive.category===c.id?(c.color||'var(--accent)')+'22':'transparent'};color:${filterActive.category===c.id?(c.color||'var(--accent)'):'var(--text3)'};border-color:${filterActive.category===c.id?(c.color||'var(--accent)')+'60':'var(--border)'};"
      onclick="setCatFilter('${c.id}')">${c.icon} ${c.name}</button>`
  ).join('');
  row.innerHTML = chips;
}

function setCatFilter(id) {
  filterActive.category = filterActive.category===id ? '' : id;
  renderCategoryFilters(); renderBacklog();
}

function renderBacklog() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const sortBy = document.getElementById('sort-select').value;
  const showArchived = filterActive.archived;
  const slotIds = Object.values(state.slots).filter(Boolean);

  document.getElementById('search-clear').style.display = search ? 'block' : 'none';

  let list = state.projects.filter(p => {
    if (showArchived) return p.archived && !p.completed;
    if (p.archived || p.completed) return false;
    if (search && !p.name.toLowerCase().includes(search) && !p.description.toLowerCase().includes(search) && !p.tags.some(t=>t.includes(search))) return false;
    if (filterActive.priority && p.priority !== filterActive.priority) return false;
    if (filterActive.tags.length && !filterActive.tags.some(t=>p.tags.includes(t))) return false;
    if (filterActive.category && p.categoryId !== filterActive.category) return false;
    return true;
  });

  const ordPri = {critical:0,high:1,medium:2,low:3};
  list.sort((a,b) => {
    if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    switch(sortBy) {
      case 'name': return a.name.localeCompare(b.name);
      case 'priority': return ordPri[a.priority] - ordPri[b.priority];
      case 'progress': return progress(b) - progress(a);
      case 'dueDate': return (a.dueDate||'9999') > (b.dueDate||'9999') ? 1 : -1;
      default: return new Date(b.createdAt) - new Date(a.createdAt);
    }
  });

  document.getElementById('backlog-count').textContent = list.length;

  // Update tags filter UI
  updateTagFilters();

  const container = document.getElementById('backlog-cards');
  if (!list.length) {
    container.innerHTML = `<div class="sidebar-empty"><div class="empty-icon">${showArchived?'ğŸ“¦':'âœ¨'}</div><p>${showArchived?'Aucun projet archivÃ©':'Votre liste est vide !<br>CrÃ©ez un projet ou choisissez un template.'}</p></div>`;
  } else {
    container.innerHTML = list.map(p => renderBacklogCard(p, slotIds.includes(p.id))).join('');
    // Bind drag events (desktop + touch/mobile)
    container.querySelectorAll('.bl-card').forEach(el => {
      el.addEventListener('dragstart', e => { draggedId=el.dataset.id; dragFrom='backlog'; el.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
      el.addEventListener('dragend', () => { el.classList.remove('dragging'); clearDragOver(); });
      // Touch drag for mobile
      el.addEventListener('touchstart', onTouchDragStart, { passive: true });
    });
  }

  // Footer
  const archived = state.projects.filter(p=>p.archived&&!p.completed).length;
  document.getElementById('sidebar-footer').innerHTML = archived && !showArchived
    ? `<button style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:11px" onclick="toggleArchived()">ğŸ“¦ ${archived} projet${archived>1?'s':''} archivÃ©${archived>1?'s':''}</button>`
    : showArchived ? `<button style="background:none;border:none;cursor:pointer;color:var(--accent);font-size:11px" onclick="toggleArchived()">â† Retour Ã  la liste</button>` : '';
}

function renderBacklogCard(p, inSlot) {
  const pct = progress(p);
  const overdue = isOverdue(p);
  const due = daysUntil(p.dueDate);
  const dueBadge = p.dueDate ? `<span class="badge ${due < 0 ? 'badge-due-late' : due <= 2 ? 'badge-due-urgent' : due <= 7 ? 'badge-due-soon' : 'badge-due-ok'}">ğŸ“… ${due < 0 ? Math.abs(due)+'j retard' : due===0?'Auj.':due===1?'Demain':due+'j'}</span>` : '';
  const compact = state.settings.compact;
  const cat = getCat(p.categoryId);
  const catBadge = cat ? `<span class="cat-badge" style="background:${cat.color}20;color:${cat.color}">${cat.icon} ${cat.name}</span>` : '';
  return `<div class="bl-card" data-id="${p.id}" draggable="true" style="border-left-color:${p.color};${inSlot?'opacity:0.65;':''}">
    ${overdue ? '<div class="bl-overdue">EN RETARD</div>' : ''}
    ${inSlot ? '<div class="bl-active-badge">actif</div>' : ''}
    <div class="bl-card-top">
      <div class="bl-icon" style="background:${p.color}22">${p.icon}</div>
      <div class="bl-info">
        <div class="bl-name">${p.pinned?'ğŸ“Œ ':''}<span title="${esc(p.name)}">${esc(p.name)||'<em style="opacity:0.4">Sans titre</em>'}</span></div>
        ${!compact && p.description ? `<div class="bl-desc">${esc(p.description)}</div>` : ''}
        ${!compact ? `<div class="bl-meta">
          <span class="badge ${PRIO[p.priority].bgClass}">${PRIO[p.priority].dot} ${PRIO[p.priority].label}</span>
          ${dueBadge}
          ${catBadge}
          ${p.tags.slice(0,2).map(t=>`<span class="tag-badge" style="background:${tagColor(t)}22;color:${tagColor(t)}">#${esc(t)}</span>`).join('')}
        </div>` : ''}
      </div>
      <div class="bl-actions">
        <button class="btn btn-icon" style="font-size:11px;color:${p.color}" onclick="assignDropdown(event,'${p.id}')" title="Assigner">â†’</button>
        <button class="btn btn-icon" onclick="openCardMenu(event,'${p.id}')" title="Menu">â‹®</button>
      </div>
    </div>
    ${p.tasks.length ? `<div class="bl-prog">
      <div class="bl-prog-bar"><div class="bl-prog-fill" style="width:${pct}%;background:${p.color}"></div></div>
      <div class="bl-prog-info"><span>${p.tasks.filter(t=>t.done).length}/${p.tasks.length} tÃ¢ches</span><span style="color:${p.color};font-weight:700">${pct}%</span></div>
    </div>` : ''}
  </div>`;
}

// â”€â”€ SLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSlots() {
  const grid = document.getElementById('slots-grid');
  grid.innerHTML = Object.entries(SLOT_INFO).map(([key, meta]) => {
    const customLabel = state.settings.slotNames?.[key] || meta.label;
    const projId = state.slots[key];
    const p = projId ? state.projects.find(x=>x.id===projId) : null;
    const isDragOver = dragOverZone === key;
    return `<div class="slot-card${p?' has-project':''}${isDragOver?' drag-over':''}" id="slot-${key}"
      ondragover="event.preventDefault(); setDragOver('${key}')"
      ondragleave="clearDragOver()"
      ondrop="handleDrop(event,'${key}')">
      <div class="slot-header" style="${p?`background:linear-gradient(135deg,${p.color}18,${p.color}07);border-bottom-color:${p.color}25`:''}">
        <div class="slot-meta">
          <div class="slot-label" style="${p?`color:${p.color}`:'color:var(--text3)'}">${meta.emoji} ${customLabel}</div>
          <div class="slot-desc">${meta.desc}</div>
        </div>
        ${p ? `<div style="display:flex;align-items:center;gap:6px">
          ${renderProgRing(progress(p), 36, 3, p.color)}
          <span style="font-family:var(--font-display);font-size:12px;font-weight:700;color:${p.color}">${progress(p)}%</span>
        </div>` : ''}
      </div>
      ${p ? renderActiveProject(p, key) : `<div class="slot-empty">
        <div class="slot-empty-icon">${meta.emoji}</div>
        <p>Glissez un projet ici<br>ou utilisez la flÃ¨che â†’</p>
      </div>`}
    </div>`;
  }).join('');

  // After rendering, bind task checkboxes and inputs
  Object.keys(state.slots).forEach(key => {
    const projId = state.slots[key];
    if (!projId) return;
    const p = state.projects.find(x=>x.id===projId);
    if (!p) return;
    // Timer setup if not already running
    if (!timers[projId]) initTimer(projId, p);
    renderTimerWidget(projId);
  });
}

function renderActiveProject(p, slotKey) {
  const pct = progress(p);
  const tasks = p.tasks.slice(0,6);
  const more = p.tasks.length - 6;
  return `<div class="slot-body">
    <div class="sp-header">
      <div class="sp-icon" style="background:${p.color}22">${p.icon}</div>
      <div class="sp-info">
        <div class="sp-name">${esc(p.name)||'Sans titre'}</div>
        ${p.description ? `<div class="sp-desc">${esc(p.description)}</div>` : ''}
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">
          <span class="badge ${PRIO[p.priority].bgClass}">${PRIO[p.priority].dot} ${PRIO[p.priority].label}</span>
          ${p.dueDate ? (() => { const d=daysUntil(p.dueDate); return `<span class="badge ${d<0?'badge-due-late':d<=2?'badge-due-urgent':d<=7?'badge-due-soon':'badge-due-ok'}">ğŸ“… ${d<0?Math.abs(d)+'j retard':d===0?'Auj.':d+'j'}</span>`; })() : ''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;flex-shrink:0">
        <button class="btn btn-icon" style="font-size:12px" onclick="openEditProj('${p.id}')" title="Modifier">âœ</button>
        <button class="btn btn-icon" style="font-size:12px;color:var(--text3)" onclick="removeFromSlot('${slotKey}')" title="Remettre en liste">â†©</button>
      </div>
    </div>

    <div class="sp-prog">
      <div class="sp-prog-label">
        <span>${p.tasks.filter(t=>t.done).length}/${p.tasks.length} tÃ¢ches</span>
        <span class="sp-prog-pct" style="color:${p.color}">${pct}%</span>
      </div>
      <div class="sp-prog-bar"><div class="sp-prog-fill" style="width:${pct}%;background:linear-gradient(90deg,${p.color},${p.color}cc);box-shadow:0 0 10px ${p.color}60"></div></div>
    </div>

    <div class="sp-tasks">
      <div class="sp-tasks-scroll" id="tasks-${p.id}" style="max-height:160px;overflow-y:auto">
        ${tasks.map((t,i) => renderEnhancedTask(t, p.id, i)).join('')}
        ${more > 0 ? `<div style="font-size:10px;color:var(--text3);text-align:center;padding:4px">+ ${more} de plus â€” <a href="#" onclick="openDetailProj('${p.id}');return false" style="color:var(--accent)">voir tout</a></div>` : ''}
      </div>
      <div class="sp-task-input">
        <input class="input" id="task-input-${p.id}" placeholder="+ Ajouter une tÃ¢che..." onkeydown="if(event.key==='Enter')addTask('${p.id}','${p.id}')">
        <button class="btn" style="padding:6px 10px;font-size:16px;flex-shrink:0" onclick="addTask('${p.id}','${p.id}')">+</button>
      </div>
    </div>

    <!-- Timer Widget -->
    <div id="timer-${p.id}"></div>

    <div class="sp-actions">
      <button class="btn" onclick="openDetailProj('${p.id}')">ğŸ‘ DÃ©tails</button>
      <button class="btn" onclick="openNotesQuick('${p.id}')">ğŸ“ Notes</button>
      <button class="btn btn-success" onclick="completeProject('${p.id}')">ğŸ† Terminer</button>
    </div>
  </div>`;
}

// â”€â”€ PROGRESS RING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProgRing(val, size=44, stroke=4, color='var(--accent)') {
  const r = (size-stroke)/2, circ = 2*Math.PI*r, dash = (val/100)*circ;
  return `<svg class="prog-ring" width="${size}" height="${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="${stroke}"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${color}" stroke-width="${stroke}" stroke-dasharray="${dash} ${circ}" stroke-linecap="round"/></svg>`;
}

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTimer(projId, p) {
  if (timers[projId]) return;
  const def = state.settings.timerDefault || { mode:'countdown', h:0, m:25, s:0 };
  timers[projId] = { mode: def.mode, h: def.h, m: def.m, s: def.s, running: false, elapsed: 0, totalSecs: def.h*3600+def.m*60+def.s, intervalId: null };
}

function renderTimerWidget(projId) {
  const el = document.getElementById('timer-' + projId);
  if (!el) return;
  const t = timers[projId];
  if (!t) return;
  const p = state.projects.find(x=>x.id===projId);

  let display, progress_ = 0;
  if (t.mode === 'countdown') {
    const rem = Math.max(0, t.totalSecs - t.elapsed);
    display = secsToHMS(rem);
    progress_ = t.totalSecs > 0 ? (t.elapsed/t.totalSecs)*100 : 0;
  } else if (t.mode === 'stopwatch') {
    display = secsToHMS(t.elapsed);
    progress_ = Math.min(100, (t.elapsed % 3600) / 3600 * 100);
  } else { // alarm
    const alarmSecs = t.h*3600 + t.m*60 + t.s;
    const now = new Date(); const nowSecs = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
    let rem2 = alarmSecs - nowSecs; if (rem2 < 0) rem2 += 86400;
    display = secsToHMS(rem2);
    progress_ = 100 - (rem2/86400)*100;
  }
  const [dh, dm, ds] = display;

  el.innerHTML = `<div class="timer-widget${t.running?' timer-running':''}">
    <div class="timer-mode-tabs">
      ${['countdown','stopwatch','alarm'].map(m=>`<button class="timer-tab${t.mode===m?' active':''}" onclick="setTimerMode('${projId}','${m}')">${{countdown:'â± Compte',stopwatch:'â² Chrono',alarm:'â° Alarme'}[m]}</button>`).join('')}
    </div>
    <div class="timer-display">
      <div class="timer-clock">
        <div class="timer-time-edit">
          ${t.mode==='stopwatch' ? `<div style="font-family:var(--font-mono);font-size:22px;font-weight:700;color:var(--accent);padding:4px 0">${pad(dh)}:${pad(dm)}:${pad(ds)}</div>` :
          `<div class="timer-seg"><input type="number" value="${pad(dh)}" min="0" max="23" ${t.running?'disabled':''} onchange="setTimerH('${projId}',this.value)"><span>h</span></div>
          <div class="timer-colon">:</div>
          <div class="timer-seg"><input type="number" value="${pad(dm)}" min="0" max="59" ${t.running?'disabled':''} onchange="setTimerM('${projId}',this.value)"><span>min</span></div>
          <div class="timer-colon">:</div>
          <div class="timer-seg"><input type="number" value="${pad(ds)}" min="0" max="59" ${t.running?'disabled':''} onchange="setTimerS('${projId}',this.value)"><span>sec</span></div>`}
        </div>
        <div class="timer-progress-bar" style="margin-top:5px"><div class="timer-progress-fill" style="width:${progress_}%"></div></div>
      </div>
      <div class="timer-controls">
        <button class="btn ${t.running?'btn-danger':''}" onclick="toggleTimer('${projId}')" title="${t.running?'Pause':'DÃ©marrer'}">${t.running?'â¸':'â–¶'}</button>
        <button class="btn" onclick="resetTimer('${projId}')" title="RÃ©initialiser">â†º</button>
      </div>
    </div>
    ${p ? `<div class="pomo-count">ğŸ… ${p.pomodoroCount||0} pomodoro${(p.pomodoroCount||0)!==1?'s':''} complÃ©tÃ©${(p.pomodoroCount||0)!==1?'s':''}</div>` : ''}
  </div>`;
}

function secsToHMS(s) { s = Math.floor(s); return [Math.floor(s/3600), Math.floor((s%3600)/60), s%60]; }
function pad(n) { return String(n).padStart(2,'0'); }

function setTimerMode(projId, mode) {
  const t = timers[projId]; if (!t) return;
  stopTimer(projId);
  t.mode = mode; t.elapsed = 0;
  if (mode === 'alarm') { const now = new Date(); t.h = now.getHours(); t.m = now.getMinutes()+25; if(t.m>=60){t.h++;t.m-=60;} t.s = 0; }
  else { const def = state.settings.timerDefault; t.h=def.h; t.m=def.m; t.s=def.s; t.totalSecs=def.h*3600+def.m*60+def.s; }
  renderTimerWidget(projId);
}

function setTimerH(projId, v) { const t=timers[projId];if(!t)return;t.h=clamp(+v,0,23);t.totalSecs=t.h*3600+t.m*60+t.s;t.elapsed=0;renderTimerWidget(projId); }
function setTimerM(projId, v) { const t=timers[projId];if(!t)return;t.m=clamp(+v,0,59);t.totalSecs=t.h*3600+t.m*60+t.s;t.elapsed=0;renderTimerWidget(projId); }
function setTimerS(projId, v) { const t=timers[projId];if(!t)return;t.s=clamp(+v,0,59);t.totalSecs=t.h*3600+t.m*60+t.s;t.elapsed=0;renderTimerWidget(projId); }

function toggleTimer(projId) {
  const t = timers[projId]; if (!t) return;
  if (t.running) stopTimer(projId);
  else startTimer(projId);
}

function startTimer(projId) {
  const t = timers[projId]; if (!t || t.running) return;
  t.running = true;
  t.intervalId = setInterval(() => {
    if (!t.running) return;
    if (t.mode === 'stopwatch') {
      t.elapsed++;
    } else if (t.mode === 'countdown') {
      t.elapsed++;
      if (t.elapsed >= t.totalSecs) {
        stopTimer(projId); timerAlarm(projId);
        const p = state.projects.find(x=>x.id===projId);
        if (p) { updateProj(projId, { pomodoroCount: (p.pomodoroCount||0)+1 }); renderHeaderStats(); }
        return;
      }
    } else { // alarm
      const now = new Date(); const alarmSecs = t.h*3600+t.m*60+t.s;
      const nowSecs = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
      if (nowSecs >= alarmSecs) { stopTimer(projId); timerAlarm(projId); return; }
      t.elapsed++;
    }
    renderTimerWidget(projId);
  }, 1000);
  renderTimerWidget(projId);
}

function stopTimer(projId) {
  const t = timers[projId]; if (!t) return;
  clearInterval(t.intervalId); t.running = false; t.intervalId = null;
  renderTimerWidget(projId);
}

function resetTimer(projId) {
  stopTimer(projId);
  const t = timers[projId]; if (!t) return;
  t.elapsed = 0; renderTimerWidget(projId);
}

function timerAlarm(projId) {
  const p = state.projects.find(x=>x.id===projId);
  toast(`â° Timer terminÃ©${p?' pour "'+p.name+'"':''}! ğŸ…`, 'success');
  // Try Web Audio API beep
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [0,0.15,0.3].forEach(t => {
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880; g.gain.setValueAtTime(0.3, ctx.currentTime+t);
      g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+t+0.3);
      o.start(ctx.currentTime+t); o.stop(ctx.currentTime+t+0.3);
    });
  } catch(e) {}
  renderTimerWidget(projId);
}

// â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTask(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  const task = p.tasks.find(t=>t.id===taskId); if (!task) return;
  // Cycle: todo â†’ in_progress â†’ done â†’ todo
  const cycle = { todo:'in_progress', in_progress:'done', done:'todo' };
  task.status = cycle[task.status] || 'todo';
  task.done = task.status === 'done';
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave();
}

function addTask(projId, inputSuffix) {
  const inp = document.getElementById('task-input-' + inputSuffix); if (!inp) return;
  const text = inp.value.trim(); if (!text) return;
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  p.tasks.push(newTask(text));
  p.updatedAt = new Date().toISOString();
  inp.value = '';
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave();
}

function delTask(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  p.tasks = p.tasks.filter(t=>t.id!==taskId);
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); scheduleSave();
}

// â”€â”€ PROJECTS CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addProject(data) {
  pushUndo();
  const p = newProject(data);
  state.projects.unshift(p);
  renderAll(); scheduleSave();
  toast(`âœ¨ "${p.name}" crÃ©Ã© !`);
  return p;
}

function updateProj(id, changes) {
  const p = state.projects.find(x=>x.id===id); if (!p) return;
  Object.assign(p, changes, { updatedAt: new Date().toISOString() });
}

function deleteProject(id) {
  pushUndo();
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===id) state.slots[k]=null; });
  if (timers[id]) { stopTimer(id); delete timers[id]; }
  state.projects = state.projects.filter(p=>p.id!==id);
  renderAll(); scheduleSave(); toast('Projet supprimÃ© ğŸ—‘', 'warning');
}

function archiveProject(id) {
  pushUndo();
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===id) state.slots[k]=null; });
  updateProj(id, { archived: true });
  renderAll(); scheduleSave(); toast('Projet archivÃ© ğŸ“¦');
}

function restoreProject(id) {
  pushUndo();
  updateProj(id, { archived: false });
  renderAll(); scheduleSave(); toast('Projet restaurÃ© ğŸ”„');
}

function duplicateProject(id) {
  pushUndo();
  const src = state.projects.find(p=>p.id===id); if (!src) return;
  const copy = { ...JSON.parse(JSON.stringify(src)), id: uid(), name: src.name + ' (copie)', createdAt: new Date().toISOString(), pinned: false, completed: false, archived: false };
  state.projects.unshift(copy);
  renderAll(); scheduleSave(); toast('Projet dupliquÃ© ğŸ“‹');
}

function completeProject(id) {
  pushUndo();
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===id) state.slots[k]=null; });
  if (timers[id]) { stopTimer(id); delete timers[id]; }
  const idx = state.projects.findIndex(p=>p.id===id); if (idx<0) return;
  const p = state.projects[idx];
  p.completed = true; p.completedAt = new Date().toISOString();
  state.completedProjects.unshift(p);
  state.projects.splice(idx, 1);
  shootConfetti();
  renderAll(); scheduleSave();
  toast('ğŸ† FÃ©licitations ! Projet terminÃ© !', 'success');
}

function restoreCompleted(id) {
  pushUndo();
  const idx = state.completedProjects.findIndex(p=>p.id===id); if (idx<0) return;
  const p = state.completedProjects[idx];
  p.completed = false; p.archived = false; delete p.completedAt;
  state.projects.unshift(p);
  state.completedProjects.splice(idx, 1);
  renderAll(); scheduleSave(); toast('Projet restaurÃ© ğŸ”„');
}

function deleteCompleted(id) {
  pushUndo();
  state.completedProjects = state.completedProjects.filter(p=>p.id!==id);
  renderCompleted(); scheduleSave(); toast('SupprimÃ© ğŸ—‘', 'warning');
}

function confirmClearCompleted() {
  if (!state.completedProjects.length) return;
  if (confirm('Supprimer dÃ©finitivement TOUS les projets terminÃ©s ?')) {
    pushUndo(); state.completedProjects = [];
    renderCompleted(); scheduleSave(); toast('Historique vidÃ© ğŸ—‘', 'warning');
  }
}

// â”€â”€ SLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function assignToSlot(projId, slot) {
  pushUndo();
  // Remove from any current slot
  Object.keys(state.slots).forEach(k => { if (state.slots[k]===projId) state.slots[k]=null; });
  state.slots[slot] = projId;
  const p = state.projects.find(x=>x.id===projId);
  if (p) initTimer(projId, p);
  renderAll(); scheduleSave();
  toast(`AssignÃ© Ã  ${state.settings.slotNames?.[slot]||SLOT_INFO[slot].label} ${SLOT_INFO[slot].emoji}`);
}

function removeFromSlot(slotKey) {
  pushUndo();
  const id = state.slots[slotKey];
  if (id && timers[id]) stopTimer(id);
  state.slots[slotKey] = null;
  renderAll(); scheduleSave();
}

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDragOver(zone) {
  dragOverZone = zone;
  // Update slot visual
  Object.keys(SLOT_INFO).forEach(k => {
    const el = document.getElementById('slot-'+k);
    if (el) el.classList.toggle('drag-over', k===zone);
  });
  const bl = document.getElementById('backlog-list');
  if (bl) bl.style.background = zone==='backlog' ? 'rgba(var(--accent-rgb),0.05)' : '';
}

function clearDragOver() {
  dragOverZone = null;
  Object.keys(SLOT_INFO).forEach(k => {
    const el = document.getElementById('slot-'+k); if (el) el.classList.remove('drag-over');
  });
  const bl = document.getElementById('backlog-list'); if (bl) bl.style.background = '';
}

function handleDrop(event, zone) {
  event.preventDefault(); clearDragOver();
  if (!draggedId) return;
  if (zone === 'backlog') {
    Object.keys(state.slots).forEach(k => { if (state.slots[k]===draggedId) { state.slots[k]=null; } });
    renderAll(); scheduleSave();
  } else {
    assignToSlot(draggedId, zone);
  }
  draggedId = null; dragFrom = null;
}

// â”€â”€ COMPLETED VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCompleted() {
  const grid = document.getElementById('completed-grid');
  const empty = document.getElementById('completed-empty');
  if (!state.completedProjects.length) {
    grid.innerHTML = ''; empty.style.display = 'block'; return;
  }
  empty.style.display = 'none';
  grid.innerHTML = state.completedProjects.map(p => {
    const pct = progress(p);
    return `<div class="comp-card" style="--c:${p.color}" onclick="openCompletedDetail('${p.id}')">
      <div class="comp-icon">${p.icon}</div>
      <div class="comp-name">${esc(p.name)}</div>
      <div class="comp-date">âœ… TerminÃ© le ${fmtDateTime(p.completedAt)}</div>
      <div class="comp-stats">
        <span class="badge" style="background:${p.color}20;color:${p.color}">${pct}% â€¢ ${p.tasks.filter(t=>t.done).length}/${p.tasks.length} tÃ¢ches</span>
        ${p.pomodoroCount ? `<span class="badge" style="background:rgba(249,115,22,0.12);color:#fb923c">ğŸ… ${p.pomodoroCount}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ STATS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats() {
  const slotIds = Object.values(state.slots).filter(Boolean);
  const allP = state.projects;
  const allTasks = allP.reduce((a,p)=>a+p.tasks.length,0);
  const doneTasks = allP.reduce((a,p)=>a+p.tasks.filter(t=>t.done).length,0);
  const pomos = [...allP,...state.completedProjects].reduce((a,p)=>a+(p.pomodoroCount||0),0);
  const hours = allP.reduce((a,p)=>a+(p.loggedHours||0),0);
  const overdueCount = allP.filter(isOverdue).length;

  document.getElementById('stats-grid').innerHTML = [
    { i:'ğŸ“', v:allP.filter(p=>!p.archived&&!p.completed).length, l:'Projets en cours', c:'var(--accent)' },
    { i:'âš¡', v:`${slotIds.length}/3`, l:'Slots actifs', c:'#f97316' },
    { i:'âœ…', v:`${doneTasks}/${allTasks}`, l:'TÃ¢ches', c:'#22c55e' },
    { i:'ğŸ†', v:state.completedProjects.length, l:'TerminÃ©s', c:'#eab308' },
    { i:'ğŸ“¦', v:allP.filter(p=>p.archived).length, l:'ArchivÃ©s', c:'#94a3b8' },
    { i:'ğŸ…', v:pomos, l:'Pomodoros', c:'#f97316' },
    { i:'â±', v:`${hours}h`, l:'Heures log', c:'#0ea5e9' },
    { i:'â°', v:overdueCount, l:'En retard', c:'#f87171' },
  ].map(s=>`<div class="stat-card"><div class="stat-icon">${s.i}</div><div class="stat-val" style="color:${s.c}">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
}

function updateAllProjectsOverview() {
  const slotIds = Object.values(state.slots).filter(Boolean);
  const container = document.getElementById('all-projects-overview');
  if (!container) return;
  const active = state.projects.filter(p=>!p.archived&&!p.completed);
  if (!active.length) { container.innerHTML = '<p style="color:var(--text3);font-size:13px">Aucun projet actif.</p>'; return; }
  container.innerHTML = active.map(p => {
    const pct = progress(p);
    return `<div onclick="openDetailProj('${p.id}')" style="background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;border-left:3px solid ${p.color};transition:all var(--transition)" onmouseover="this.style.background='var(--glass2)'" onmouseout="this.style.background='var(--glass)'">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
        <span>${p.icon}</span>
        <span style="font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.name)}</span>
        ${slotIds.includes(p.id)?`<span style="font-size:9px;color:var(--text3);background:var(--glass2);padding:1px 5px;border-radius:10px">actif</span>`:''}
      </div>
      <div style="height:3px;border-radius:2px;background:rgba(255,255,255,0.06);overflow:hidden"><div style="height:100%;width:${pct}%;background:${p.color};border-radius:2px;box-shadow:0 0 6px ${p.color}60"></div></div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px;text-align:right">${pct}%</div>
    </div>`;
  }).join('');
}

// â”€â”€ MENUS (portal-based, fixed position to fix z-index overlap bug) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createPortalDropdown(anchorEl, itemsHTML) {
  closeDropdown();
  const rect = anchorEl.getBoundingClientRect();
  const dd = document.createElement('div');
  dd.className = 'dropdown dropdown-portal';
  dd.innerHTML = itemsHTML;
  // Position below and right-aligned to button
  document.body.appendChild(dd);
  const ddW = 190;
  let left = rect.right - ddW;
  let top = rect.bottom + 4;
  // Keep within viewport
  if (left < 8) left = 8;
  if (top + 200 > window.innerHeight) top = rect.top - Math.min(200, top + 200 - window.innerHeight) - 4;
  dd.style.left = left + 'px';
  dd.style.top = top + 'px';
  openDropdown = dd;
}

function openCardMenu(event, projId) {
  event.stopPropagation();
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  createPortalDropdown(event.currentTarget, [
    { i:'ğŸ‘', l:'Voir dÃ©tails', fn:`openDetailProj('${projId}')` },
    { i:'âœ', l:'Modifier', fn:`openEditProj('${projId}')` },
    { i:'ğŸ“‹', l:'Dupliquer', fn:`duplicateProject('${projId}')` },
    { i:'ğŸ“Œ', l:p.pinned?'DÃ©sÃ©pingler':'Ã‰pingler', fn:`togglePin('${projId}')` },
    { i:'ğŸ·', l:'Changer catÃ©gorie', fn:`changeCategoryModal('${projId}')` },
    { i:'ğŸ†', l:'Marquer terminÃ©', fn:`completeProject('${projId}')` },
    null, // separator
    { i:'ğŸ“¦', l:p.archived?'Restaurer':'Archiver', fn:p.archived?`restoreProject('${projId}')`:`archiveProject('${projId}')` },
    { i:'ğŸ—‘', l:'Supprimer', fn:`if(confirm('Supprimer ce projet ?'))deleteProject('${projId}')`, danger:true },
  ].map(it => it===null ? '<div class="dropdown-sep"></div>' :
    `<button class="dropdown-item${it.danger?' danger':''}" onclick="${it.fn};closeDropdown()">${it.i} ${it.l}</button>`
  ).join(''));
}

function assignDropdown(event, projId) {
  event.stopPropagation();
  createPortalDropdown(event.currentTarget, Object.entries(SLOT_INFO).map(([k,m]) => {
    const customLabel = state.settings.slotNames?.[k] || m.label;
    const isCurrent = state.slots[k] === projId;
    return `<button class="dropdown-item${isCurrent?' active':''}" onclick="assignToSlot('${projId}','${k}');closeDropdown()" style="${isCurrent?'color:var(--accent)':''}">${m.emoji} ${customLabel}${isCurrent?' âœ“':''}</button>`;
  }).join(''));
}

function closeDropdown() {
  if (openDropdown) { openDropdown.remove(); openDropdown = null; }
}

function togglePin(id) {
  const p = state.projects.find(x=>x.id===id); if (!p) return;
  updateProj(id, { pinned: !p.pinned });
  renderBacklog(); scheduleSave();
}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFilters() {
  const p = document.getElementById('filters-panel');
  p.style.display = p.style.display==='none' ? 'flex' : 'none';
  document.getElementById('btn-filters').style.borderColor = p.style.display!=='none' ? 'var(--accent)' : 'var(--border)';
}

function renderFilterPriority() {
  const row = document.getElementById('filter-priority-row');
  row.innerHTML = [['','Tout'],['critical','ğŸ”´ Critique'],['high','ğŸŸ  Ã‰levÃ©'],['medium','ğŸŸ¡ Moyen'],['low','ğŸŸ¢ Faible']].map(([v,l])=>
    `<button class="filter-chip${filterActive.priority===v?' active':''}" onclick="setFilterPriority('${v}')">${l}</button>`
  ).join('');
}

function setFilterPriority(v) { filterActive.priority = filterActive.priority===v&&v?'':v; renderFilterPriority(); renderBacklog(); }

function updateTagFilters() {
  const allTags = [...new Set(state.projects.flatMap(p=>p.tags))];
  const sec = document.getElementById('filter-tags-section');
  const row = document.getElementById('filter-tags-row');
  sec.style.display = allTags.length ? 'block' : 'none';
  row.innerHTML = allTags.map(t=>`<button class="filter-chip${filterActive.tags.includes(t)?' active':''}" onclick="toggleTagFilter('${t}')">#${t}</button>`).join('');
}

function toggleTagFilter(t) {
  const idx = filterActive.tags.indexOf(t);
  if (idx>=0) filterActive.tags.splice(idx,1); else filterActive.tags.push(t);
  renderBacklog();
}

function toggleArchived() {
  filterActive.archived = !filterActive.archived;
  document.getElementById('btn-archived').style.borderColor = filterActive.archived ? 'var(--accent)' : 'var(--border)';
  renderBacklog();
}

function toggleCompact() {
  state.settings.compact = !state.settings.compact;
  document.getElementById('compact-label').textContent = state.settings.compact ? 'ğŸ“‘ Compact âœ“' : 'ğŸ“‹ Confortable';
  renderBacklog(); scheduleSave();
}

function resetFilters() {
  filterActive = { priority:'', tags:[], archived:false };
  document.getElementById('search-input').value = '';
  document.getElementById('sort-select').value = 'createdAt';
  renderFilterPriority(); renderBacklog();
}

function clearSearch() { document.getElementById('search-input').value=''; renderBacklog(); }

// â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  const s = document.getElementById('sidebar');
  const o = document.getElementById('sidebar-overlay');
  const open = s.classList.toggle('open');
  o.style.display = open ? 'block' : 'none';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').style.display = 'none';
}

function setMobileView(v) {
  mobileView = v;
  const isMobile = window.innerWidth <= 640;

  // Show/hide main views
  document.getElementById('view-board').classList.toggle('view-hidden', v==='completed'||v==='stats');
  document.getElementById('view-completed').classList.toggle('view-hidden', v!=='completed');
  document.getElementById('view-stats').classList.toggle('view-hidden', v!=='stats');

  if (isMobile) {
    // On mobile: toggle sidebar for 'list' view
    if (v==='list') toggleSidebar();
    else closeSidebar();

    // Update nav
    ['list','board','done','stats','settings'].forEach(n => {
      const el = document.getElementById('nav-'+n);
      if (el) el.classList.toggle('active', v===n||(n==='done'&&v==='completed'));
    });
  }
}

function onResize() {
  const isMobile = window.innerWidth <= 640;
  const isTablet = window.innerWidth <= 900;
  document.getElementById('btn-menu-sidebar').style.display = isTablet ? 'flex' : 'none';
  if (!isTablet) {
    closeSidebar();
    document.getElementById('sidebar-overlay').style.display = 'none';
  }
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(html, wide=false) {
  closeModal();
  const bg = document.createElement('div');
  bg.className = 'modal-bg';
  bg.id = 'active-modal';
  bg.innerHTML = `<div class="modal${wide?' modal-wide':''}">${html}</div>`;
  bg.addEventListener('click', e => { if (e.target === bg) closeModal(); });
  document.body.appendChild(bg);
  activeModalBg = bg;
}
// alias for backwards compat with any inline onclick="openModal..."
const openModal = showModal;

function closeModal() {
  const m = document.getElementById('active-modal');
  if (m) m.remove();
  activeModalBg = null;
}

// â”€â”€ NEW / EDIT PROJECT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNew(templateData) {
  const p = newProject(templateData||{});
  showEditModal(p, true);
}

function openEditProj(id) {
  const p = state.projects.find(x=>x.id===id);
  if (!p) return;
  showEditModal(JSON.parse(JSON.stringify(p)), false);
}

function showEditModal(data, isNew_) {
  let d = data;
  function upd(k,v) { d[k]=v; refreshEditPreview(); }

  openModal(`
    <div class="modal-header">
      <div class="modal-title">${isNew_?'âœ¨ Nouveau projet':'âœ Modifier le projet'}</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" data-tab="info" onclick="switchTab(this,'info')">Infos</button>
      <button class="modal-tab" data-tab="tasks" onclick="switchTab(this,'tasks')">TÃ¢ches</button>
      <button class="modal-tab" data-tab="tags" onclick="switchTab(this,'tags')">Tags</button>
      <button class="modal-tab" data-tab="advanced" onclick="switchTab(this,'advanced')">AvancÃ©</button>
    </div>
    <div class="modal-body">
      <!-- INFO TAB -->
      <div class="modal-tab-body active" id="tab-info">
        <!-- Preview -->
        <div id="edit-preview" style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.08)">
          <span id="prev-icon" style="font-size:24px">${d.icon}</span>
          <span id="prev-name" style="font-weight:700;font-size:15px">${esc(d.name)||'<span style="opacity:0.3">AperÃ§u...</span>'}</span>
        </div>
        <!-- Icon row -->
        <div class="form-group">
          <label class="form-label">IcÃ´ne</label>
          <div class="icon-grid" id="icon-grid">
            ${ICONS.map(ic=>`<button class="icon-btn${ic===d.icon?' active':''}" onclick="selectIcon('${ic}')">${ic}</button>`).join('')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Couleur</label>
          <div class="color-swatches" id="color-swatches">
            ${COLORS.map(c=>`<div class="color-swatch${c===d.color?' active':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Nom *</label>
          <input class="input" id="edit-name" value="${esc(d.name)}" placeholder="Ex: DÃ©velopper mon portfolio" oninput="editField('name',this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="input" id="edit-desc" placeholder="Description courte..." oninput="editField('description',this.value)">${esc(d.description)}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">CatÃ©gorie</label>
            <select class="input" id="edit-category" onchange="editField('categoryId',this.value)">
              ${state.categories.map(c=>`<option value="${c.id}"${(d.categoryId||'cat_general')===c.id?' selected':''}>${c.icon} ${c.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">PrioritÃ©</label>
            <select class="input" id="edit-priority" onchange="editField('priority',this.value)">
              ${Object.entries(PRIO).map(([k,v])=>`<option value="${k}"${d.priority===k?' selected':''}>${v.dot} ${v.label}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Date limite</label>
            <input type="date" class="input" id="edit-due" value="${d.dueDate||''}" onchange="editField('dueDate',this.value)" style="color-scheme:dark">
          </div>
        </div>
      </div>

      <!-- TASKS TAB -->
      <div class="modal-tab-body" id="tab-tasks">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input class="input" id="new-task-inp" placeholder="Ajouter une tÃ¢che..." onkeydown="if(event.key==='Enter')addEditTask()">
          <button class="btn btn-primary" onclick="addEditTask()" style="flex-shrink:0">+</button>
        </div>
        <div id="edit-tasks-list"></div>
      </div>

      <!-- TAGS TAB -->
      <div class="modal-tab-body" id="tab-tags">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input class="input" id="new-tag-inp" placeholder="Ajouter un tag..." onkeydown="if(event.key==='Enter')addEditTag()">
          <button class="btn btn-primary" onclick="addEditTag()" style="flex-shrink:0">+</button>
        </div>
        <div id="edit-tags-list" class="tags-wrap"></div>
        <div id="existing-tags-section" style="margin-top:14px"></div>
      </div>

      <!-- ADVANCED TAB -->
      <div class="modal-tab-body" id="tab-advanced">
        <div class="form-row">
          <div class="form-group"><label class="form-label">Heures estimÃ©es</label><input type="number" min="0" class="input" id="edit-esthours" value="${d.estimatedHours||0}" oninput="editField('estimatedHours',+this.value)"></div>
          <div class="form-group"><label class="form-label">Heures travaillÃ©es</label><input type="number" min="0" class="input" id="edit-loghours" value="${d.loggedHours||0}" oninput="editField('loggedHours',+this.value)"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="input" id="edit-notes" style="min-height:120px" placeholder="Notes, idÃ©es, rÃ©flexions..." oninput="editField('notes',this.value)">${esc(d.notes||'')}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Lien</label>
          <div style="display:flex;gap:8px">
            <input class="input" id="new-link-inp" placeholder="https://...">
            <button class="btn" onclick="addEditLink()" style="flex-shrink:0">+</button>
          </div>
          <div id="edit-links-list" style="margin-top:6px"></div>
        </div>
        <label class="toggle-label" style="margin-top:6px">
          <div class="toggle${d.pinned?' on':''}" id="pin-toggle" onclick="this.classList.toggle('on');editField('pinned',this.classList.contains('on'))"></div>
          Ã‰pingler ce projet
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" id="save-proj-btn" onclick="saveEditModal(${isNew_})" disabled>
        ${isNew_?'âœ¨ CrÃ©er':'ğŸ’¾ Enregistrer'}
      </button>
    </div>
  `, true);

  // Set preview bg
  refreshEditPreview();
  renderEditTasks(); renderEditTags(); renderEditLinks();

  function refreshEditPreview() {
    const prev = document.getElementById('edit-preview');
    if (prev) prev.style.background = d.color + '18';
    const pn = document.getElementById('prev-name');
    if (pn) pn.innerHTML = d.name ? esc(d.name) : '<span style="opacity:0.3">AperÃ§u...</span>';
    const pi = document.getElementById('prev-icon');
    if (pi) pi.textContent = d.icon;
    const sb = document.getElementById('save-proj-btn');
    if (sb) { sb.disabled = !d.name.trim(); sb.style.opacity = d.name.trim()? '1' : '0.4'; }
  }

  function selectIcon(icon) {
    d.icon = icon;
    document.querySelectorAll('#icon-grid .icon-btn').forEach(b=>b.classList.toggle('active', b.textContent===icon));
    refreshEditPreview();
  }
  function selectColor(color) {
    d.color = color;
    document.querySelectorAll('.color-swatch').forEach(s=>s.classList.toggle('active', s.style.background===color||s.dataset.c===color));
    refreshEditPreview();
  }
  function editField(k,v) { d[k]=v; refreshEditPreview(); }
  function renderEditTasks() {
    const el = document.getElementById('edit-tasks-list'); if (!el) return;
    if (!d.tasks.length) { el.innerHTML = '<p style="color:var(--text3);font-size:12px;text-align:center;padding:16px">Aucune tÃ¢che</p>'; return; }
    el.innerHTML = d.tasks.map((t,i)=>{
      const st = TASK_STATUS[t.status||'todo'];
      const prioColor = TASK_PRIO_COLOR[t.priority||'medium'];
      return `<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--glass);border-radius:8px;margin-bottom:5px">
        <button class="task-status-btn ${t.status||'todo'}" onclick="cycleEditTaskStatus(${i})" style="border-color:${st.color};${(t.status==='in_progress'||t.status==='done')?'background:'+st.color+'22':''}" title="${st.label}"><span style="color:${st.color}">${st.icon}</span></button>
        <span style="width:8px;height:8px;border-radius:50%;background:${prioColor};flex-shrink:0"></span>
        <input style="flex:1;background:none;border:none;color:var(--text);font-family:var(--font);font-size:12px;outline:none;text-decoration:${t.done?'line-through':''};opacity:${t.done?0.4:1}" value="${esc(t.text)}" oninput="editTaskText(${i},this.value)">
        ${(t.subtasks||[]).length?`<span style="font-size:9px;color:var(--text3)">${(t.subtasks||[]).filter(s=>s.done).length}/${(t.subtasks||[]).length}â†³</span>`:''}
        <button onclick="removeEditTask(${i})" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px">Ã—</button>
      </div>`;
    }).join('');
  }
  function cycleEditTaskStatus(i) {
    const t = d.tasks[i]; if(!t) return;
    const cycle = { todo:'in_progress', in_progress:'done', done:'todo' };
    t.status = cycle[t.status||'todo'];
    t.done = t.status === 'done';
    renderEditTasks();
  }
  function addEditTask() {
    const inp=document.getElementById('new-task-inp'); if(!inp||!inp.value.trim())return;
    d.tasks.push(newTask(inp.value.trim())); inp.value=''; renderEditTasks();
  }
  function removeEditTask(i) { d.tasks.splice(i,1); renderEditTasks(); }
  function editTaskDone(i,v) { d.tasks[i].done=v; }
  function editTaskText(i,v) { d.tasks[i].text=v; }
  function renderEditTags() {
    const el = document.getElementById('edit-tags-list'); if(!el)return;
    el.innerHTML = d.tags.map(t=>`<span class="tag-badge" style="background:${tagColor(t)}22;color:${tagColor(t)};display:inline-flex;align-items:center;gap:4px;padding:3px 8px;cursor:pointer" onclick="removeEditTag('${t}'">#${esc(t)} Ã—</span>`).join('');
    const existing = [...new Set(state.projects.flatMap(p=>p.tags))].filter(t=>!d.tags.includes(t));
    const sec = document.getElementById('existing-tags-section');
    if (sec && existing.length) sec.innerHTML = '<label class="form-label">Tags existants</label><div class="tags-wrap">' + existing.map(t=>`<button onclick="addExistingTag('${t}')" style="padding:3px 9px;border-radius:20px;border:1px dashed var(--border2);background:transparent;color:var(--text3);cursor:pointer;font-size:11px">+#${esc(t)}</button>`).join('') + '</div>';
  }
  function addEditTag() {
    const inp=document.getElementById('new-tag-inp'); if(!inp||!inp.value.trim())return;
    const t=inp.value.trim().toLowerCase().replace(/\s+/g,'-');
    if(!d.tags.includes(t))d.tags.push(t); inp.value=''; renderEditTags();
  }
  function addExistingTag(t) { if(!d.tags.includes(t))d.tags.push(t); renderEditTags(); }
  function removeEditTag(t) { d.tags=d.tags.filter(x=>x!==t); renderEditTags(); }
  function renderEditLinks() {
    const el = document.getElementById('edit-links-list'); if(!el)return;
    el.innerHTML = (d.links||[]).map((l,i)=>`<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
      <a href="${esc(l)}" target="_blank" style="flex:1;font-size:12px;color:var(--accent);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ğŸ”— ${esc(l)}</a>
      <button onclick="removeEditLink(${i})" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px">Ã—</button>
    </div>`).join('');
  }
  function addEditLink() {
    const inp=document.getElementById('new-link-inp'); if(!inp||!inp.value.trim())return;
    if(!d.links)d.links=[];d.links.push(inp.value.trim());inp.value='';renderEditLinks();
  }
  function removeEditLink(i) { d.links.splice(i,1); renderEditLinks(); }

  function saveEditModal(isNew_) {
    if (!d.name.trim()) return;
    if (isNew_) addProject(d);
    else { pushUndo(); Object.assign(state.projects.find(p=>p.id===d.id)||{}, d, { updatedAt:new Date().toISOString() }); renderAll(); scheduleSave(); toast(`"${d.name}" mis Ã  jour âœ`); }
    closeModal();
  }

  // Expose to global scope for inline handlers
  window.selectIcon = selectIcon;
  window.selectColor = selectColor;
  window.editField = editField;
  window.addEditTask = addEditTask;
  window.cycleEditTaskStatus = cycleEditTaskStatus;
  window.removeEditTask = removeEditTask;
  window.editTaskDone = editTaskDone;
  window.editTaskText = editTaskText;
  window.addEditTag = addEditTag;
  window.addExistingTag = addExistingTag;
  window.removeEditTag = removeEditTag;
  window.addEditLink = addEditLink;
  window.removeEditLink = removeEditLink;
  window.saveEditModal = saveEditModal;
}

function switchTab(btn, tab) {
  document.querySelectorAll('.modal-tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.modal-tab-body').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const el = document.getElementById('tab-'+tab);
  if (el) el.classList.add('active');
}

// â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetailProj(id) {
  const p = state.projects.find(x=>x.id===id) || state.completedProjects.find(x=>x.id===id);
  if (!p) return;
  const pct = progress(p);
  openModal(`
    <div class="detail-banner" style="background:linear-gradient(135deg,${p.color}25,${p.color}08)">
      <div class="detail-banner-inner">
        <div class="detail-icon" style="background:${p.color}25">${p.icon}</div>
        <div style="flex:1;min-width:0">
          <h2 style="font-family:var(--font-display);font-size:18px;font-weight:800;margin-bottom:4px">${esc(p.name)}</h2>
          ${p.description?`<p style="font-size:12px;color:var(--text2);margin-bottom:8px">${esc(p.description)}</p>`:''}
          <div style="display:flex;gap:5px;flex-wrap:wrap">
            <span class="badge ${PRIO[p.priority].bgClass}">${PRIO[p.priority].dot} ${PRIO[p.priority].label}</span>
            ${p.dueDate?`<span class="badge badge-due-${daysUntil(p.dueDate)<0?'late':daysUntil(p.dueDate)<=3?'urgent':daysUntil(p.dueDate)<=7?'soon':'ok'}">ğŸ“… ${fmtDate(p.dueDate)}</span>`:''}
            ${p.estimatedHours?`<span class="badge" style="background:rgba(255,255,255,0.06);color:var(--text3)">â± ${p.estimatedHours}h</span>`:''}
            ${p.pomodoroCount?`<span class="badge" style="background:rgba(249,115,22,0.12);color:#fb923c">ğŸ… ${p.pomodoroCount}</span>`:''}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
          ${renderProgRing(pct,52,4,p.color)}
          <span style="font-size:13px;font-weight:700;color:${p.color}">${pct}%</span>
        </div>
      </div>
      <!-- Progress bar -->
      <div style="margin-top:14px;height:7px;border-radius:4px;background:rgba(255,255,255,0.08);overflow:hidden">
        <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,${p.color},${p.color}cc);box-shadow:0 0 12px ${p.color}60;border-radius:4px"></div>
      </div>
    </div>
    <div class="modal-body" style="padding:16px 20px">
      ${p.tags.length?`<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px">${p.tags.map(t=>`<span class="tag-badge" style="background:${tagColor(t)}22;color:${tagColor(t)}">#${esc(t)}</span>`).join('')}</div>`:''}
      <!-- Tasks -->
      <div style="margin-bottom:16px">
        <div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.08em;margin-bottom:8px">TÃ‚CHES (${p.tasks.filter(t=>t.done).length}/${p.tasks.length})</div>
        <div style="max-height:220px;overflow-y:auto">
          ${p.tasks.map(t=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)">
            <button class="task-check${t.done?' done':''}" onclick="toggleTask('${p.id}','${t.id}');openDetailProj('${p.id}')"></button>
            <span style="flex:1;font-size:13px;color:${t.done?'var(--text3)':'var(--text2)'};text-decoration:${t.done?'line-through':'none'}">${esc(t.text)}</span>
          </div>`).join('')}
        </div>
        ${!p.completed?`<div style="display:flex;gap:8px;margin-top:8px">
          <input class="input" id="detail-task-inp" placeholder="+ Nouvelle tÃ¢che..." onkeydown="if(event.key==='Enter'&&this.value.trim()){addTask('${p.id}','detail-task-inp');openDetailProj('${p.id}')}" style="font-size:12px">
          <button class="btn" onclick="addTask('${p.id}','detail-task-inp');openDetailProj('${p.id}')">+</button>
        </div>`:''}
      </div>
      ${p.notes?`<div style="margin-bottom:16px"><div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.08em;margin-bottom:6px">NOTES</div><div style="background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:12px;font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap">${esc(p.notes)}</div></div>`:''}
      ${(p.links||[]).length?`<div style="margin-bottom:14px"><div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.08em;margin-bottom:6px">LIENS</div>${p.links.map(l=>`<a href="${esc(l)}" target="_blank" style="display:block;padding:7px 10px;border-radius:8px;background:var(--glass);color:var(--accent);font-size:12px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ğŸ”— ${esc(l)}</a>`).join('')}</div>`:''}
      <div style="background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--text3)">
        CrÃ©Ã© le ${fmtDateTime(p.createdAt)} â€¢ ModifiÃ© le ${fmtDateTime(p.updatedAt)}
        ${p.completedAt?` â€¢ TerminÃ© le ${fmtDateTime(p.completedAt)}`:''}
      </div>
    </div>
    <div class="modal-footer">
      ${!p.completed?`<button class="btn" onclick="closeModal();openEditProj('${p.id}')">âœ Modifier</button>`:''}
      ${p.completed?`<button class="btn btn-danger" onclick="deleteCompleted('${p.id}');closeModal()">ğŸ—‘ Supprimer</button><button class="btn" onclick="restoreCompleted('${p.id}');closeModal()">ğŸ”„ Restaurer</button>`:''}
      <button class="btn" onclick="closeModal()">Fermer</button>
    </div>
  `, true);
}

function openCompletedDetail(id) { openDetailProj(id); }

// â”€â”€ NOTES QUICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNotesQuick(projId) {
  const p = state.projects.find(x=>x.id===projId); if (!p) return;
  openModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ“ Notes â€” ${esc(p.name)}</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <textarea class="input" id="quick-notes" style="min-height:180px;resize:vertical">${esc(p.notes||'')}</textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveNotes('${projId}')">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}

function saveNotes(projId) {
  const v = document.getElementById('quick-notes').value;
  updateProj(projId, { notes: v }); renderAll(); scheduleSave();
  closeModal(); toast('Notes sauvegardÃ©es ğŸ“');
}

// â”€â”€ TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTemplates() {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ“„ Templates</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        ${TEMPLATES.map((t,i)=>`<button onclick="useTemplate(${i})" style="padding:14px;border-radius:12px;border:2px solid var(--border);background:var(--glass);cursor:pointer;text-align:left;transition:all var(--transition)" onmouseover="this.style.borderColor='${t.color}';this.style.background='${t.color}12'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--glass)'">
          <div style="font-size:24px;margin-bottom:6px">${t.icon}</div>
          <div style="font-weight:700;font-size:13px;margin-bottom:3px">${t.name}</div>
          <div style="font-size:10px;color:var(--text3)">${t.tasks.length} tÃ¢ches prÃ©dÃ©finies</div>
        </button>`).join('')}
      </div>
    </div>
  `, true);
}

function useTemplate(i) {
  const t = TEMPLATES[i];
  const data = { name:t.name, icon:t.icon, color:t.color, tags:t.tags, tasks:t.tasks.map(tx=>({id:uid(),text:tx,done:false})) };
  closeModal(); showEditModal(newProject(data), true);
}

// â”€â”€ SLOT NAMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSlotNamesEditor() {
  const n = state.settings.slotNames || {};
  openModal(`
    <div class="modal-header">
      <div class="modal-title">âœ Nommer les slots</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      ${Object.entries(SLOT_INFO).map(([k,m])=>`<div class="form-group">
        <label class="form-label">${m.emoji} Slot ${m.label}</label>
        <input class="input" id="slotname-${k}" value="${esc(n[k]||m.label)}" placeholder="${m.label}">
      </div>`).join('')}
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveSlotNames()">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}

function saveSlotNames() {
  if (!state.settings.slotNames) state.settings.slotNames = {};
  Object.keys(SLOT_INFO).forEach(k => {
    const v = document.getElementById('slotname-'+k); if (v) state.settings.slotNames[k] = v.value.trim() || SLOT_INFO[k].label;
  });
  renderSlots(); scheduleSave(); closeModal(); toast('Noms des slots mis Ã  jour âœ');
}

// â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() {
  const auth = getAuth();
  openModal(`
    <div class="modal-header">
      <div class="modal-title">âš™ ParamÃ¨tres</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- â”€â”€ Compte â”€â”€ -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ‘¤ Compte</div>
        ${auth ? `<div class="account-badge">
          <span class="account-avatar">${auth.username ? auth.username[0].toUpperCase() : '?'}</span>
          <div><div style="font-weight:600;font-size:13px">${auth.username}</div>
          <div style="font-size:11px;color:var(--text3)">ConnectÃ© Â· AccÃ¨s protÃ©gÃ©</div></div>
        </div>` : `<div class="settings-note warn">âš ï¸ Aucun mot de passe â€” l'app s'ouvre directement.</div>`}
        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">Nom d'utilisateur</label>
            <input class="input" id="sec-username" value="${auth?.username||''}" placeholder="Votre prÃ©nom">
          </div>
        </div>
        ${auth ? `<div class="form-group">
          <label class="form-label">Mot de passe actuel</label>
          <input class="input" type="password" id="sec-old" placeholder="Requis pour modifier">
        </div>` : ''}
        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">${auth ? 'Nouveau mot de passe' : 'Mot de passe'}</label>
            <input class="input" type="password" id="sec-new" placeholder="Min 6 caractÃ¨res">
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">Confirmer</label>
            <input class="input" type="password" id="sec-confirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
        </div>
        <div id="sec-msg" style="display:none;font-size:12px;padding:8px 12px;border-radius:8px;margin-bottom:8px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="saveAccountSettings()">${auth ? 'ğŸ’¾ Mettre Ã  jour' : 'ğŸ” Activer la protection'}</button>
          ${auth ? `<button class="btn" style="color:var(--danger)" onclick="disablePassword()">ğŸ”“ DÃ©sactiver</button>` : ''}
        </div>
      </div>

      <!-- â”€â”€ Sync â”€â”€ -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ”„ Synchronisation GitHub</div>
        <div class="sync-status" style="margin-bottom:12px">
          <div class="sync-dot ${syncStatus}" id="modal-sync-dot"></div>
          <span id="modal-sync-label" style="font-size:12px">${{idle:'Non configurÃ©',syncing:'Synchronisation...',synced:'SynchronisÃ© âœ…',error:'Erreur de synchronisation âŒ'}[syncStatus]||syncStatus}</span>
        </div>
        <div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:10px;padding:12px;font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:12px">
          ğŸ“‹ <strong>Comment Ã§a marche :</strong><br>
          1. CrÃ©ez un repo GitHub avec les fichiers <code>index.html</code> et <code>database.json</code><br>
          2. Activez <strong>GitHub Pages</strong> sur la branche <code>main</code><br>
          3. CrÃ©ez un <strong>token personnel</strong> (Settings â†’ Developer settings â†’ Tokens â†’ avec scope <code>repo</code>)<br>
          4. Remplissez les champs ci-dessous â†’ vos donnÃ©es se synchronisent entre tous vos appareils !
        </div>
        <div class="form-group"><label class="form-label">GitHub Token (PAT)</label><input class="input" id="gh-token" type="password" value="${github.token}" placeholder="ghp_..."></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Votre username</label><input class="input" id="gh-owner" value="${github.owner}" placeholder="mon-pseudo"></div>
          <div class="form-group"><label class="form-label">Nom du repo</label><input class="input" id="gh-repo" value="${github.repo}" placeholder="projectflow"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="saveGitHubConfig()">ğŸ’¾ Enregistrer & synchroniser</button>
          <button class="btn" onclick="testSync()">ğŸ”„ Tester</button>
        </div>
      </div>
      <!-- Theme section -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ¨ Couleur d'accent</div>
        <div class="color-swatches" id="settings-colors">
          ${COLORS.map(c=>`<div class="color-swatch${state.settings.accent===c?' active':''}" style="background:${c}" onclick="setAccent('${c}')"></div>`).join('')}
        </div>
      </div>
      <!-- Timer defaults -->
      <div class="settings-section">
        <div class="settings-section-title">â± Timer par dÃ©faut</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Mode</label>
            <select class="input" id="def-timer-mode">
              <option value="countdown"${state.settings.timerDefault?.mode==='countdown'?' selected':''}>â± Compte Ã  rebours</option>
              <option value="stopwatch"${state.settings.timerDefault?.mode==='stopwatch'?' selected':''}>â² ChronomÃ¨tre</option>
              <option value="alarm"${state.settings.timerDefault?.mode==='alarm'?' selected':''}>â° Alarme</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">DurÃ©e (min)</label>
            <input type="number" class="input" id="def-timer-min" value="${state.settings.timerDefault?.m||25}" min="0" max="120">
          </div>
        </div>
      </div>
      <!-- Export/Import -->
      <div class="settings-section">
        <div class="settings-section-title">ğŸ“ DonnÃ©es</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="exportJSON()">ğŸ“¥ Exporter JSON</button>
          <label class="btn" style="cursor:pointer">ğŸ“¤ Importer JSON<input type="file" accept=".json" style="display:none" onchange="importJSON(event)"></label>
          <button class="btn btn-danger" onclick="if(confirm('Effacer TOUTES les donnÃ©es ?')){localStorage.removeItem('pf_local_v2');localStorage.removeItem('pf_github');location.reload()}" style="margin-left:auto">ğŸ—‘ RÃ©initialiser</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Fermer</button>
      <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Sauvegarder</button>
    </div>
  `, true);
}

// â”€â”€ ACCOUNT MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAccountSettings() {
  const auth      = getAuth();
  const username  = (document.getElementById('sec-username')?.value||'').trim();
  const pwdOld    = document.getElementById('sec-old')?.value||'';
  const pwdNew    = (document.getElementById('sec-new')?.value||'').trim();
  const pwdConf   = (document.getElementById('sec-confirm')?.value||'').trim();
  const msg       = document.getElementById('sec-msg');

  const showMsg = (text, ok=false) => {
    if (!msg) return;
    msg.textContent = text;
    msg.style.display = 'block';
    msg.style.background = ok ? 'rgba(34,197,94,0.12)' : 'rgba(239,68,68,0.12)';
    msg.style.color = ok ? '#4ade80' : '#f87171';
    msg.style.border = ok ? '1px solid rgba(34,197,94,0.3)' : '1px solid rgba(239,68,68,0.3)';
  };

  if (auth) {
    if (!pwdOld) { showMsg('Entrez votre mot de passe actuel.'); return; }
    const oldHash = await hashPwd(pwdOld, (auth.salt||SALTS[0]));
    let ok = oldHash === auth.hash;
    if (!ok) {
      for (const s of SALTS) {
        if (await hashPwd(pwdOld, s) === auth.hash) { ok = true; break; }
      }
    }
    if (!ok) { showMsg('Mot de passe actuel incorrect.'); return; }
    if (pwdNew && pwdNew.length < 6) { showMsg('Nouveau mot de passe trop court (min 6 car.).'); return; }
    if (pwdNew && pwdNew !== pwdConf) { showMsg('Les nouveaux mots de passe ne correspondent pas.'); return; }
    const finalHash = pwdNew ? await hashPwd(pwdNew, SALTS[0]) : auth.hash;
    localStorage.setItem(LS_AUTH_KEY, JSON.stringify({ username: username||auth.username, hash: finalHash, salt: SALTS[0], updatedAt: new Date().toISOString() }));
    const lbl = document.getElementById('user-label');
    if (lbl) lbl.textContent = username||auth.username;
    showMsg('âœ… Compte mis Ã  jour !', true);
    setTimeout(closeModal, 1500);
  } else {
    if (!username) { showMsg("Choisissez un nom d'utilisateur."); return; }
    if (!pwdNew || pwdNew.length < 6) { showMsg('Mot de passe requis, minimum 6 caractÃ¨res.'); return; }
    if (pwdNew !== pwdConf) { showMsg('Les mots de passe ne correspondent pas.'); return; }
    const hash = await hashPwd(pwdNew, SALTS[0]);
    localStorage.setItem(LS_AUTH_KEY, JSON.stringify({ username, hash, salt: SALTS[0], createdAt: new Date().toISOString() }));
    const lbl = document.getElementById('user-label');
    if (lbl) lbl.textContent = username;
    clearLock();
    showMsg('âœ… Protection activÃ©e ! DemandÃ©e dÃ¨s la prochaine visite.', true);
    setTimeout(closeModal, 1800);
  }
}

async function disablePassword() {
  if (!confirm('DÃ©sactiver le mot de passe ?\n\nL\'app s\'ouvrira sans connexion.')) return;
  localStorage.removeItem(LS_AUTH_KEY);
  localStorage.removeItem(LS_LOCK_KEY);
  toast('ğŸ”“ Protection dÃ©sactivÃ©e.', 'info');
  closeModal();
}


function saveGitHubConfig() {
  github.token = document.getElementById('gh-token').value.trim();
  github.owner = document.getElementById('gh-owner').value.trim();
  github.repo = document.getElementById('gh-repo').value.trim();
  github.sha = null;
  localStorage.setItem(LS_GITHUB_KEY, JSON.stringify({ token:github.token, owner:github.owner, repo:github.repo }));
  toast('Config GitHub enregistrÃ©e. Synchronisation en cours...', 'info');
  saveData();
}

async function testSync() {
  if (!github.token || !github.owner || !github.repo) { toast('Remplissez les champs GitHub d\'abord !', 'error'); return; }
  toast('Test de connexion GitHub...', 'info');
  const ok = await syncFromGitHub();
  if (ok) { renderAll(); toast('âœ… Connexion GitHub OK ! DonnÃ©es chargÃ©es.', 'success'); }
  else toast('âŒ Ã‰chec de la connexion GitHub. VÃ©rifiez vos identifiants.', 'error');
}

function setAccent(color) {
  state.settings.accent = color;
  applyAccent(color);
  document.querySelectorAll('#settings-colors .color-swatch').forEach(s => s.classList.toggle('active', s.style.background===color));
  scheduleSave();
}

function applyAccent(color) {
  document.documentElement.style.setProperty('--accent', color);
  const rgb = hexToRgb(color);
  if (rgb) document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
  // Compute accent2 (slightly shifted)
  document.documentElement.style.setProperty('--accent2', shiftHue(color, -20));
}

function saveSettings() {
  const m = document.getElementById('def-timer-mode');
  const min = document.getElementById('def-timer-min');
  if (m) state.settings.timerDefault = { mode:m.value, h:0, m:+min.value||25, s:0 };
  scheduleSave(); closeModal(); toast('ParamÃ¨tres sauvegardÃ©s âš™');
}

function showExportMenu(event) {
  closeDropdown();
  const btn = event.currentTarget;
  const dd = document.createElement('div');
  dd.className = 'dropdown';
  dd.innerHTML = `
    <button class="dropdown-item" onclick="exportJSON();closeDropdown()">ğŸ“„ Exporter JSON</button>
    <button class="dropdown-item" onclick="exportCSV();closeDropdown()">ğŸ“Š Exporter CSV</button>
    <div class="dropdown-sep"></div>
    <label class="dropdown-item" style="cursor:pointer">ğŸ“¤ Importer JSON<input type="file" accept=".json" style="display:none" onchange="importJSON(event);closeDropdown()"></label>
  `;
  btn.style.position = 'relative';
  btn.appendChild(dd);
  openDropdown = dd;
}

function exportJSON() {
  const data = dataSnapshot();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download = `projectflow_${new Date().toISOString().split('T')[0]}.json`;
  a.click(); URL.revokeObjectURL(url); toast('Export JSON ğŸ“¥');
}

function exportCSV() {
  const rows = [['Nom','Description','PrioritÃ©','Statut','Progression','TÃ¢ches totales','TÃ¢ches faites','Date limite','Tags','CrÃ©Ã© le']];
  state.projects.forEach(p => rows.push([p.name,p.description,p.priority,p.archived?'ArchivÃ©':'Actif',progress(p)+'%',p.tasks.length,p.tasks.filter(t=>t.done).length,p.dueDate||'',p.tags.join(';'),fmtDate(p.createdAt)]));
  state.completedProjects.forEach(p => rows.push([p.name,p.description,p.priority,'TerminÃ©','100%',p.tasks.length,p.tasks.filter(t=>t.done).length,p.dueDate||'',p.tags.join(';'),fmtDate(p.createdAt)]));
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download=`projectflow_${new Date().toISOString().split('T')[0]}.csv`;
  a.click(); URL.revokeObjectURL(url); toast('Export CSV ğŸ“Š');
}

function importJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      pushUndo(); applyData(data);
      renderAll(); scheduleSave();
      toast(`âœ… Import rÃ©ussi ! ${(data.projects||[]).length} projets chargÃ©s.`);
    } catch(e) { toast('âŒ Fichier JSON invalide.', 'error'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shootConfetti() {
  const colors = ['#7c3aed','#ec4899','#f97316','#22c55e','#eab308','#0ea5e9'];
  for (let i=0; i<60; i++) {
    const c = document.createElement('div');
    c.className = 'confetti-piece';
    c.style.cssText = `left:${Math.random()*100}vw;top:0;background:${colors[Math.floor(Math.random()*colors.length)]};animation-duration:${0.8+Math.random()*1.5}s;animation-delay:${Math.random()*0.4}s;transform:rotate(${Math.random()*360}deg);width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'2px'}`;
    document.body.appendChild(c);
    setTimeout(()=>c.remove(), 2500);
  }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type='success') {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  const icons = { success:'âœ…', error:'âŒ', warning:'âš ï¸', info:'â„¹ï¸' };
  const colors = { success:'#22c55e', error:'#ef4444', warning:'#f97316', info:'#6366f1' };
  t.innerHTML = `<div class="toast-border-l" style="background:${colors[type]||colors.success}"></div><span class="toast-icon">${icons[type]||icons.success}</span><span>${msg}</span>`;
  container.appendChild(t);
  setTimeout(()=>{ t.classList.add('removing'); setTimeout(()=>t.remove(),300); }, 3000);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) { if (!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function tagColor(tag) {
  const hue = Array.from(tag).reduce((h,c)=>h+c.charCodeAt(0),0) % 360;
  return `hsl(${hue},60%,62%)`;
}

function hexToRgb(hex) {
  const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return r ? { r:parseInt(r[1],16), g:parseInt(r[2],16), b:parseInt(r[3],16) } : null;
}

function shiftHue(hex, amount) {
  const rgb = hexToRgb(hex); if (!rgb) return hex;
  const r=rgb.r/255,g=rgb.g/255,b=rgb.b/255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min;
  let h=0,s=max===0?0:d/max,v=max;
  if (d!==0) { switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;} }
  h=(h*360+amount+360)%360/360;
  const i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t2=v*(1-(1-f)*s);
  let r2,g2,b2;
  switch(i%6){case 0:r2=v;g2=t2;b2=p;break;case 1:r2=q;g2=v;b2=p;break;case 2:r2=p;g2=v;b2=t2;break;case 3:r2=p;g2=q;b2=v;break;case 4:r2=t2;g2=p;b2=v;break;default:r2=v;g2=p;b2=q;}
  const toHex=x=>Math.round(x*255).toString(16).padStart(2,'0');
  return '#'+toHex(r2)+toHex(g2)+toHex(b2);
}

function onKeyDown(e) {
  if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') {
    if (e.key==='Escape') e.target.blur();
    return;
  }
  if ((e.ctrlKey||e.metaKey) && e.key==='z') { e.preventDefault(); doUndo(); }
  if ((e.ctrlKey||e.metaKey) && e.key==='n') { e.preventDefault(); openNew(); }
  if (e.key==='Escape') { closeModal(); closeDropdown(); }
}

// â”€â”€ QUICK STATS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuickStats() {
  const bar = document.getElementById('quick-stats-bar');
  if (!bar) return;
  const slotProjects = Object.values(state.slots).filter(Boolean).map(id => state.projects.find(p=>p.id===id)).filter(Boolean);
  const totalTasks = slotProjects.reduce((a,p)=>a+p.tasks.length,0);
  const doneTasks_ = slotProjects.reduce((a,p)=>a+p.tasks.filter(t=>t.done).length,0);
  const avgProg = slotProjects.length ? Math.round(slotProjects.reduce((a,p)=>a+progress(p),0)/slotProjects.length) : 0;
  if (!slotProjects.length) { bar.innerHTML = ''; return; }
  bar.innerHTML = [
    { i:'âš¡', v:`${slotProjects.length}/3`, l:'Actifs', c:'var(--accent)' },
    { i:'âœ…', v:`${doneTasks_}/${totalTasks}`, l:'TÃ¢ches actives', c:'#22c55e' },
    { i:'ğŸ“ˆ', v:`${avgProg}%`, l:'Progression moy.', c:'#f97316' },
  ].map(s=>`<div style="background:var(--glass);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;gap:10px">
    <span style="font-size:22px">${s.i}</span>
    <div><div style="font-family:var(--font-display);font-size:20px;font-weight:800;color:${s.c}">${s.v}</div><div style="font-size:10px;color:var(--text3)">${s.l}</div></div>
  </div>`).join('');
}

// â”€â”€ CATEGORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCategoryManager() {
  showModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ· GÃ©rer les catÃ©gories</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="cat-manager-body"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="addCategoryPrompt()">+ Nouvelle catÃ©gorie</button>
      <button class="btn" onclick="closeModal()">Fermer</button>
    </div>
  `);
  renderCatManagerBody();
}

function renderCatManagerBody() {
  const el = document.getElementById('cat-manager-body'); if(!el) return;
  el.innerHTML = state.categories.map(c => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--glass);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
      <div style="width:34px;height:34px;border-radius:9px;background:${c.color}25;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">${c.icon}</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px">${esc(c.name)}</div>
        <div style="font-size:10px;color:var(--text3)">${state.projects.filter(p=>p.categoryId===c.id).length} projets</div>
      </div>
      <div style="display:flex;gap:4px">
        <button class="btn btn-icon" onclick="editCategoryModal('${c.id}')" style="font-size:12px">âœ</button>
        <button class="btn btn-icon btn-danger" onclick="deleteCategory('${c.id}')" style="font-size:12px">ğŸ—‘</button>
      </div>
    </div>`).join('') || '<p style="color:var(--text3);text-align:center;padding:20px">Aucune catÃ©gorie</p>';
}

function addCategoryPrompt() { editCategoryModal(null); }

function editCategoryModal(catId) {
  const cat = catId ? state.categories.find(c=>c.id===catId) : null;
  const catIcons = ['ğŸ“','ğŸ’»','ğŸ¨','ğŸ“š','ğŸ ','ğŸ’¼','ğŸ”¬','ğŸµ','ğŸŒ','âš½','ğŸ¯','ğŸš€','ğŸŒ±','â¤ï¸','ğŸ‹ï¸','ğŸ­'];
  showModal(`
    <div class="modal-header">
      <div class="modal-title">${cat?'âœ Modifier':'+ Nouvelle'} catÃ©gorie</div>
      <button class="btn btn-icon" onclick="${cat?'openCategoryManager()':'closeModal()'}">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Nom</label>
        <input class="input" id="cat-name-inp" value="${esc(cat?.name||'')}" placeholder="Ex: Ã‰lectronique, LittÃ©raire...">
      </div>
      <div class="form-group"><label class="form-label">IcÃ´ne</label>
        <div style="display:flex;flex-wrap:wrap;gap:5px" id="cat-icon-grid">
          ${catIcons.map(ic=>`<button class="icon-btn${(cat?.icon||catIcons[0])===ic?' active':''}" onclick="document.querySelectorAll('#cat-icon-grid .icon-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('cat-icon-val').value='${ic}'">${ic}</button>`).join('')}
        </div>
        <input type="hidden" id="cat-icon-val" value="${cat?.icon||catIcons[0]}">
      </div>
      <div class="form-group"><label class="form-label">Couleur</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${COLORS.map(c=>`<div class="color-swatch${(cat?.color||COLORS[0])===c?' active':''}" style="background:${c}" onclick="document.querySelectorAll('.cat-color-swatch').forEach(s=>s.classList.remove('active'));this.classList.add('active');document.getElementById('cat-color-val').value='${c}'" class="cat-color-swatch color-swatch"></div>`).join('')}
        </div>
        <input type="hidden" id="cat-color-val" value="${cat?.color||COLORS[0]}">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="${cat?'openCategoryManager()':'closeModal()'}">Annuler</button>
      <button class="btn btn-primary" onclick="saveCategory('${catId||''}')">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}
window.saveCategory = function(catId) {
  const name = document.getElementById('cat-name-inp')?.value.trim();
  const icon = document.getElementById('cat-icon-val')?.value || 'ğŸ“';
  const color = document.getElementById('cat-color-val')?.value || COLORS[0];
  if (!name) return;
  if (catId) {
    const c = state.categories.find(x=>x.id===catId);
    if (c) Object.assign(c, { name, icon, color });
    toast('CatÃ©gorie modifiÃ©e âœ');
  } else {
    state.categories.push({ id: 'cat_'+uid(), name, icon, color });
    toast(`CatÃ©gorie "${name}" crÃ©Ã©e ğŸ·`);
  }
  renderCategoryFilters(); renderBacklog(); scheduleSave(); closeModal();
};
function deleteCategory(catId) {
  if (!confirm('Supprimer cette catÃ©gorie ? Les projets seront mis dans "GÃ©nÃ©ral"')) return;
  state.categories = state.categories.filter(c=>c.id!==catId);
  state.projects.forEach(p=>{ if(p.categoryId===catId) p.categoryId='cat_general'; });
  renderCategoryFilters(); renderBacklog(); scheduleSave(); openCategoryManager();
}
function changeCategoryModal(projId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  showModal(`
    <div class="modal-header">
      <div class="modal-title">ğŸ· Changer la catÃ©gorie</div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;flex-direction:column;gap:6px">
        ${state.categories.map(c=>`<button onclick="assignCategory('${projId}','${c.id}')" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${p.categoryId===c.id?c.color+'20':'var(--glass)'};border:1px solid ${p.categoryId===c.id?c.color:'var(--border)'};border-radius:10px;cursor:pointer;text-align:left;transition:all 0.15s">
          <span style="font-size:20px">${c.icon}</span>
          <span style="font-weight:600;color:${p.categoryId===c.id?c.color:'var(--text)'}">${esc(c.name)}</span>
          ${p.categoryId===c.id?'<span style="margin-left:auto;color:var(--accent)">âœ“</span>':''}
        </button>`).join('')}
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal()">Fermer</button></div>
  `);
}
window.assignCategory = function(projId, catId) {
  updateProj(projId, { categoryId: catId });
  renderBacklog(); scheduleSave(); closeModal();
  const cat = getCat(catId);
  toast(`CatÃ©gorie â†’ ${cat?.icon} ${cat?.name}`);
};

// â”€â”€ ENHANCED TASK RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TASK_STATUS = {
  todo:        { icon:'â—‹', label:'Ã€ faire',   color:'var(--text3)' },
  in_progress: { icon:'â—', label:'En cours',  color:'#f97316' },
  done:        { icon:'â—', label:'TerminÃ©',   color:'#22c55e' }
};
const TASK_PRIO_COLOR = { high:'#f87171', medium:'#fb923c', low:'#4ade80', critical:'#c084fc' };

function renderEnhancedTask(t, projId, idx) {
  const st = TASK_STATUS[t.status||'todo'];
  const prioColor = TASK_PRIO_COLOR[t.priority||'medium'];
  const subDone = (t.subtasks||[]).filter(s=>s.done).length;
  const subTotal = (t.subtasks||[]).length;
  return `<div class="task-item" id="taskitem-${t.id}" data-task-id="${t.id}" data-proj-id="${projId}">
    <div class="task-item-header">
      <span class="task-drag-handle" title="DÃ©placer">â ¿</span>
      <span class="task-rank" style="color:var(--text3)">${idx+1}</span>
      <button class="task-status-btn ${t.status||'todo'}" onclick="cycleTaskStatus('${projId}','${t.id}')" title="${st.label}" style="border-color:${st.color};${(t.status==='in_progress'||t.status==='done')?'background:'+st.color+'22':''}">
        <span style="color:${st.color}">${st.icon}</span>
      </button>
      <span class="task-priority-dot" style="background:${prioColor}" title="PrioritÃ©: ${t.priority||'medium'}"></span>
      <span class="task-main-text ${t.status==='done'?'done':''}" onclick="openTaskDetail('${projId}','${t.id}')">${esc(t.text)}</span>
      ${subTotal?`<span style="font-size:9px;color:var(--text3);flex-shrink:0">${subDone}/${subTotal}</span>`:''}
      <div class="task-actions-row">
        <button onclick="openTaskDetail('${projId}','${t.id}')" title="DÃ©tails">ğŸ“‹</button>
        <button onclick="cycleTaskPriority('${projId}','${t.id}')" title="PrioritÃ©">ğŸ¯</button>
        <button onclick="deleteTaskFromProj('${projId}','${t.id}')" title="Supprimer" style="color:#f87171">Ã—</button>
      </div>
      ${subTotal?`<button class="task-expand-btn" id="texpand-${t.id}" onclick="toggleTaskDetail('${t.id}')">â–¶</button>`:''}
    </div>
    ${subTotal?`<div class="task-detail" id="tdetail-${t.id}">
      <div class="subtask-list">${(t.subtasks||[]).map(s=>`<div class="subtask-row">
        <button class="subtask-check${s.done?' done':''}" onclick="toggleSubtask('${projId}','${t.id}','${s.id}')">${s.done?'âœ“':''}</button>
        <span class="subtask-text${s.done?' done':''}">${esc(s.text)}</span>
        <button class="subtask-del" onclick="deleteSubtask('${projId}','${t.id}','${s.id}')">Ã—</button>
      </div>`).join('')}</div>
    </div>`:''}
  </div>`;
}

function cycleTaskStatus(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const cycle = { todo:'in_progress', in_progress:'done', done:'todo' };
  t.status = cycle[t.status||'todo'];
  t.done = t.status === 'done';
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave();
}

function cycleTaskPriority(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const cycle = { low:'medium', medium:'high', high:'critical', critical:'low' };
  t.priority = cycle[t.priority||'medium'];
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); scheduleSave();
}

function deleteTaskFromProj(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  p.tasks = p.tasks.filter(t=>t.id!==taskId);
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); scheduleSave();
}

function toggleTaskDetail(taskId) {
  const detail = document.getElementById('tdetail-'+taskId);
  const btn = document.getElementById('texpand-'+taskId);
  if (!detail) return;
  const open = detail.classList.toggle('open');
  if (btn) btn.classList.toggle('open', open);
}

function openTaskDetail(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const st = TASK_STATUS[t.status||'todo'];
  showModal(`
    <div class="modal-header">
      <div class="modal-title" style="display:flex;align-items:center;gap:8px">
        <span style="color:${TASK_STATUS[t.status||'todo'].color}">${TASK_STATUS[t.status||'todo'].icon}</span>
        DÃ©tail de la tÃ¢che
      </div>
      <button class="btn btn-icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">TÃ¢che</label>
        <input class="input" id="td-text" value="${esc(t.text)}">
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Statut</label>
          <select class="input" id="td-status">
            ${Object.entries(TASK_STATUS).map(([k,v])=>`<option value="${k}"${t.status===k?' selected':''}>${v.icon} ${v.label}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">PrioritÃ©</label>
          <select class="input" id="td-priority">
            ${['low','medium','high','critical'].map(k=>`<option value="${k}"${(t.priority||'medium')===k?' selected':''}>${k}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">Rang</label>
          <input type="number" class="input" id="td-rank" value="${t.rank||0}" min="0">
        </div>
      </div>
      <div class="form-group"><label class="form-label">Date limite</label>
        <input type="date" class="input" id="td-due" value="${t.dueDate||''}" style="color-scheme:dark">
      </div>
      <div class="form-group"><label class="form-label">Note</label>
        <textarea class="input" id="td-note" style="min-height:80px">${esc(t.note||'')}</textarea>
      </div>
      <!-- Subtasks -->
      <div class="form-group">
        <label class="form-label">Sous-tÃ¢ches (${(t.subtasks||[]).filter(s=>s.done).length}/${(t.subtasks||[]).length})</label>
        <div id="td-subtasks">${renderSubtasksEdit(t.subtasks||[])}</div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <input class="input" id="td-sub-inp" placeholder="+ Sous-tÃ¢che..." style="font-size:12px" onkeydown="if(event.key==='Enter')addSubtaskFromModal('${projId}','${taskId}')">
          <button class="btn" onclick="addSubtaskFromModal('${projId}','${taskId}')">+</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveTaskDetail('${projId}','${taskId}')">ğŸ’¾ Sauvegarder</button>
    </div>
  `);
}
function renderSubtasksEdit(subtasks) {
  if (!subtasks.length) return '<p style="color:var(--text3);font-size:11px">Aucune sous-tÃ¢che</p>';
  return subtasks.map(s=>`<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border)">
    <button class="subtask-check${s.done?' done':''}" onclick="this.classList.toggle('done');this.nextSibling.nextSibling.value=this.classList.contains('done')?'true':'false'">${s.done?'âœ“':''}</button>
    <span style="flex:1;font-size:12px;${s.done?'text-decoration:line-through;opacity:0.5':''}">${esc(s.text)}</span>
    <input type="hidden" class="sub-done-val" value="${s.done}">
    <input type="hidden" class="sub-id-val" value="${s.id}">
    <button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:var(--text3)">Ã—</button>
  </div>`).join('');
}
window.addSubtaskFromModal = function(projId, taskId) {
  const inp = document.getElementById('td-sub-inp'); if(!inp||!inp.value.trim()) return;
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  if(!t.subtasks) t.subtasks=[];
  const sub = { id:uid(), text:inp.value.trim(), done:false };
  t.subtasks.push(sub);
  p.updatedAt = new Date().toISOString();
  inp.value='';
  const container = document.getElementById('td-subtasks');
  if (container) container.innerHTML = renderSubtasksEdit(t.subtasks);
  scheduleSave();
};
window.saveTaskDetail = function(projId, taskId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  t.text = document.getElementById('td-text')?.value.trim() || t.text;
  t.status = document.getElementById('td-status')?.value || t.status;
  t.done = t.status === 'done';
  t.priority = document.getElementById('td-priority')?.value || t.priority;
  t.rank = parseInt(document.getElementById('td-rank')?.value)||0;
  t.dueDate = document.getElementById('td-due')?.value || '';
  t.note = document.getElementById('td-note')?.value || '';
  p.updatedAt = new Date().toISOString();
  renderSlots(); renderBacklog(); renderHeaderStats(); scheduleSave(); closeModal();
  toast('TÃ¢che mise Ã  jour âœ');
};

function toggleSubtask(projId, taskId, subId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  const s = (t.subtasks||[]).find(x=>x.id===subId); if(!s) return;
  s.done = !s.done;
  p.updatedAt = new Date().toISOString();
  renderSlots(); scheduleSave();
}
function deleteSubtask(projId, taskId, subId) {
  const p = state.projects.find(x=>x.id===projId); if(!p) return;
  const t = p.tasks.find(x=>x.id===taskId); if(!t) return;
  t.subtasks = (t.subtasks||[]).filter(s=>s.id!==subId);
  p.updatedAt = new Date().toISOString();
  renderSlots(); scheduleSave();
}

// â”€â”€ TOUCH DRAG (mobile drag & drop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTouchDragStart(e) {
  const card = e.currentTarget;
  touchDragId = card.dataset.id;
  const touch = e.touches[0];
  // Create ghost
  touchGhost = card.cloneNode(true);
  touchGhost.className = card.className + ' touch-drag-ghost';
  touchGhost.style.width = card.offsetWidth + 'px';
  touchGhost.style.left = (touch.clientX - card.offsetWidth/2) + 'px';
  touchGhost.style.top = (touch.clientY - 30) + 'px';
  document.body.appendChild(touchGhost);
  document.addEventListener('touchmove', onTouchDragMove, { passive: false });
  document.addEventListener('touchend', onTouchDragEnd);
}

function onTouchDragMove(e) {
  e.preventDefault();
  if (!touchGhost || !touchDragId) return;
  const touch = e.touches[0];
  touchGhost.style.left = (touch.clientX - parseInt(touchGhost.style.width)/2) + 'px';
  touchGhost.style.top = (touch.clientY - 30) + 'px';
  // Find drop target
  touchGhost.style.display = 'none';
  const el = document.elementFromPoint(touch.clientX, touch.clientY);
  touchGhost.style.display = '';
  if (!el) return;
  // Check slot drop zones
  let zone = null;
  const slotEl = el.closest('[id^="slot-"]');
  if (slotEl) zone = slotEl.id.replace('slot-','');
  // Highlight
  document.querySelectorAll('.slot-card').forEach(s => s.classList.remove('drag-valid-target'));
  if (zone && SLOT_INFO[zone]) {
    const slotCard = document.getElementById('slot-'+zone);
    if (slotCard) { slotCard.classList.add('drag-valid-target'); touchDragOver = zone; }
  } else { touchDragOver = null; }
}

function onTouchDragEnd() {
  if (touchGhost) { touchGhost.remove(); touchGhost = null; }
  document.querySelectorAll('.slot-card').forEach(s => s.classList.remove('drag-valid-target'));
  document.removeEventListener('touchmove', onTouchDragMove);
  document.removeEventListener('touchend', onTouchDragEnd);
  if (touchDragId && touchDragOver) {
    assignToSlot(touchDragId, touchDragOver);
  }
  touchDragId = null; touchDragOver = null;
}

// â”€â”€ HABITS SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const todayKey = () => new Date().toISOString().split('T')[0];

function renderHabits() {
  const body = document.getElementById('habits-body'); if (!body) return;
  const collapsed = state.settings.habitsCollapsed;
  const btn = document.getElementById('habits-collapse-btn');
  if (btn) btn.textContent = collapsed ? '+' : 'âˆ’';
  if (collapsed) { body.style.display = 'none'; return; }
  body.style.display = 'block';
  const today = todayKey();
  const log = state.habitLog[today] || {};
  const done = state.habits.filter(h => log[h.id]).length;
  const badge = document.getElementById('habits-streak-badge');
  if (badge) {
    badge.style.display = state.habits.length > 0 ? 'inline' : 'none';
    badge.textContent = `${done}/${state.habits.length}`;
    badge.style.background = done===state.habits.length ? 'rgba(34,197,94,0.2)' : 'rgba(var(--accent-rgb),0.15)';
    badge.style.color = done===state.habits.length ? '#4ade80' : 'var(--accent)';
  }
  if (!state.habits.length) {
    body.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text3);font-size:12px">Aucune habitude â€” <button onclick="addHabitPrompt()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px">Ajouter â†’</button></div>`;
    return;
  }
  body.innerHTML = state.habits.map(h => {
    const isDone = !!log[h.id];
    const streak = getHabitStreak(h.id);
    const dots = Array.from({length:7},(_,i)=>{ const d=new Date();d.setDate(d.getDate()-6+i);const k=d.toISOString().split('T')[0];const filled=!!(state.habitLog[k]||{})[h.id];return `<div class="habit-dot" style="background:${filled?(h.color||'var(--accent)'):'rgba(255,255,255,0.1)'}"></div>`; }).join('');
    return `<div class="habit-row"><button class="habit-check${isDone?' done':''}" onclick="toggleHabit('${h.id}')" style="${isDone?`border-color:${h.color||'#22c55e'};background:${h.color||'#22c55e'}22`:''}"></button><span class="habit-name" style="${isDone?'text-decoration:line-through;opacity:0.5':''}">${esc(h.name)}</span><div class="habit-dots">${dots}</div>${streak>0?`<div class="habit-streak">ğŸ”¥ ${streak}</div>`:''}<button class="habit-del" onclick="deleteHabit('${h.id}')">Ã—</button></div>`;
  }).join('');
}
function getHabitStreak(habitId) {
  let streak=0,d=new Date(); d.setDate(d.getDate()-1);
  while(true){const k=d.toISOString().split('T')[0];if((state.habitLog[k]||{})[habitId]){streak++;d.setDate(d.getDate()-1);}else break;if(streak>365)break;}
  if((state.habitLog[todayKey()]||{})[habitId]) streak++;
  return streak;
}
function toggleHabit(habitId) {
  const today=todayKey(); if(!state.habitLog[today])state.habitLog[today]={};
  state.habitLog[today][habitId]=!state.habitLog[today][habitId];
  const cutoff=new Date();cutoff.setDate(cutoff.getDate()-90);
  Object.keys(state.habitLog).forEach(k=>{if(new Date(k)<cutoff)delete state.habitLog[k];});
  renderHabits(); scheduleSave();
  const allDone=state.habits.length>0&&state.habits.every(h=>state.habitLog[today][h.id]);
  if(allDone) toast('ğŸŒ¿ Toutes les habitudes du jour ! ğŸ‰','success');
}
function addHabitPrompt() {
  showModal(`
    <div class="modal-header"><div class="modal-title">ğŸŒ¿ Nouvelle habitude</div><button class="btn btn-icon" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Nom</label><input class="input" id="habit-name-inp" placeholder="Ex: MÃ©ditation, Sport, Lecture..."></div>
      <div class="form-group"><label class="form-label">Couleur</label><div class="color-swatches">${COLORS.slice(0,8).map((c,i)=>`<div class="color-swatch${i===0?' active':''}" style="background:${c}" onclick="document.querySelectorAll('.color-swatches .color-swatch').forEach(s=>s.classList.remove('active'));this.classList.add('active');document.getElementById('habit-color-val').value='${c}'"></div>`).join('')}</div><input type="hidden" id="habit-color-val" value="${COLORS[0]}"></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveNewHabit()">+ Ajouter</button></div>
  `);
  setTimeout(()=>document.getElementById('habit-name-inp')?.focus(),100);
}
window.saveNewHabit = function() {
  const name=document.getElementById('habit-name-inp')?.value.trim();
  const color=document.getElementById('habit-color-val')?.value||COLORS[0];
  if(!name)return;
  state.habits.push({id:uid(),name,color,createdAt:new Date().toISOString()});
  renderHabits();scheduleSave();closeModal();toast(`ğŸŒ¿ "${name}" ajoutÃ©e !`);
};
function deleteHabit(id){state.habits=state.habits.filter(h=>h.id!==id);renderHabits();scheduleSave();}
function toggleHabitsWidget(){state.settings.habitsCollapsed=!state.settings.habitsCollapsed;renderHabits();scheduleSave();}

// â”€â”€ SYNC STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(s) {
  syncStatus = s;
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  if (!dot) return;
  dot.className = 'sync-dot ' + s;
  const labels = { idle:'Local', syncing:'Sync...', synced:'Sync âœ“', error:'Erreur sync' };
  lbl.textContent = labels[s] || s;
  if (s==='synced') { lastSaveTime=new Date(); updateSyncTime(); }
}
function updateSyncTime() {
  const el=document.getElementById('sync-time'); if(!el||!lastSaveTime)return;
  const diff=Math.round((Date.now()-lastSaveTime)/1000);
  el.textContent=diff<5?'Ã€ l\'instant':diff<60?`${diff}s`:`${Math.round(diff/60)}min`;
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();

</script>
</body>
</html>